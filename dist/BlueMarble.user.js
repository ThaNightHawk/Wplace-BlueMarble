// ==UserScript==
// @name         Skirk Marble
// @namespace    https://github.com/Seris0/
// @version      0.69.1
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       Seris0
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://github.com/Seris0/Wplace-BlueMarble
// @icon         https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/cc70f8da7b10bb1c90f8387b38a659cbb917c80d/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/main/dist/BlueMarble.user.js
// @run-at       document-start
// @match        *://*.wplace.live/*
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      nominatim.openstreetmap.org
// @connect      wplace.live
// @connect      wplace.lol
// @resource     CSS-BM-File https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/cc70f8da7b10bb1c90f8387b38a659cbb917c80d/dist/BlueMarble.user.css
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var n,e=Object.defineProperty,t=Object.getOwnPropertyNames,o=n=>{throw TypeError(n)},a=(n,e,t)=>e.has(n)?o("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),r=(n,e,t)=>(((n,e)=>{e.has(n)||o("Cannot access private method")})(n,e),t),i={};function s(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}function l(n,e){return[parseInt(n[0])%4*1e3+parseInt(e[0]),parseInt(n[1])%4*1e3+parseInt(e[1])]}function c(n,e){return(n%e+e)%e}function d(...n){console.log("Fuck console.logs")}function p(...n){(0,console.error)(...n)}function m(...n){(0,console.warn)(...n)}function u(n,e){if(0===n)return e[0];let t="";const o=e.length;for(;n>0;)t=e[n%o]+t,n=Math.floor(n/o);return t}function b(n){let e="";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return btoa(e)}function g(n){const e=atob(n),t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}function f(n){if(4!==n.length)return;const e=2048e3;return{t:360*((1e3*n[0]+n[2])/e)-180,lat:(t=(1e3*n[1]+n[3])/e,360*(Math.atan(Math.exp(Math.PI-2*Math.PI*t))-Math.PI/4)/Math.PI)};var t}((n,t)=>{for(var o in t)e(n,o,{get:t[o],enumerable:!0})})(i,{o:()=>g,i:()=>f,l:()=>n,p:()=>p,m:()=>d,u:()=>m,h:()=>s,v:()=>c,k:()=>u,$:()=>l,M:()=>b});var h,x,v,w,y=(h={"src/utils.js"(){n=[{name:"Transparent",rgb:[0,0,0],free:!0},{name:"Black",rgb:[0,0,0],free:!0},{name:"Dark Gray",rgb:[60,60,60],free:!0},{name:"Gray",rgb:[120,120,120],free:!0},{name:"Light Gray",rgb:[210,210,210],free:!0},{name:"White",rgb:[255,255,255],free:!0},{name:"Deep Red",rgb:[96,0,24],free:!0},{name:"Red",rgb:[237,28,36],free:!0},{name:"Orange",rgb:[255,127,39],free:!0},{name:"Gold",rgb:[246,170,9],free:!0},{name:"Yellow",rgb:[249,221,59],free:!0},{name:"Light Yellow",rgb:[255,250,188],free:!0},{name:"Dark Green",rgb:[14,185,104],free:!0},{name:"Green",rgb:[19,230,123],free:!0},{name:"Light Green",rgb:[135,255,94],free:!0},{name:"Dark Teal",rgb:[12,129,110],free:!0},{name:"Teal",rgb:[16,174,166],free:!0},{name:"Light Teal",rgb:[19,225,190],free:!0},{name:"Dark Blue",rgb:[40,80,158],free:!0},{name:"Blue",rgb:[64,147,228],free:!0},{name:"Cyan",rgb:[96,247,242],free:!0},{name:"Indigo",rgb:[107,80,246],free:!0},{name:"Light Indigo",rgb:[153,177,251],free:!0},{name:"Dark Purple",rgb:[120,12,153],free:!0},{name:"Purple",rgb:[170,56,185],free:!0},{name:"Light Purple",rgb:[224,159,249],free:!0},{name:"Dark Pink",rgb:[203,0,122],free:!0},{name:"Pink",rgb:[236,31,128],free:!0},{name:"Light Pink",rgb:[243,141,169],free:!0},{name:"Dark Brown",rgb:[104,70,52],free:!0},{name:"Brown",rgb:[149,104,42],free:!0},{name:"Beige",rgb:[248,178,119],free:!0},{name:"Medium Gray",rgb:[170,170,170],free:!1},{name:"Dark Red",rgb:[165,14,30],free:!1},{name:"Light Red",rgb:[250,128,114],free:!1},{name:"Dark Orange",rgb:[228,92,26],free:!1},{name:"Light Tan",rgb:[214,181,148],free:!1},{name:"Dark Goldenrod",rgb:[156,132,49],free:!1},{name:"Goldenrod",rgb:[197,173,49],free:!1},{name:"Light Goldenrod",rgb:[232,212,95],free:!1},{name:"Dark Olive",rgb:[74,107,58],free:!1},{name:"Olive",rgb:[90,148,74],free:!1},{name:"Light Olive",rgb:[132,197,115],free:!1},{name:"Dark Cyan",rgb:[15,121,159],free:!1},{name:"Light Cyan",rgb:[187,250,242],free:!1},{name:"Light Blue",rgb:[125,199,255],free:!1},{name:"Dark Indigo",rgb:[77,49,184],free:!1},{name:"Dark Slate Blue",rgb:[74,66,132],free:!1},{name:"Slate Blue",rgb:[122,113,196],free:!1},{name:"Light Slate Blue",rgb:[181,174,241],free:!1},{name:"Light Brown",rgb:[219,164,99],free:!1},{name:"Dark Beige",rgb:[209,128,81],free:!1},{name:"Light Beige",rgb:[255,197,165],free:!1},{name:"Dark Peach",rgb:[155,82,73],free:!1},{name:"Peach",rgb:[209,128,120],free:!1},{name:"Light Peach",rgb:[250,182,164],free:!1},{name:"Dark Tan",rgb:[123,99,82],free:!1},{name:"Tan",rgb:[156,132,107],free:!1},{name:"Dark Slate",rgb:[51,57,65],free:!1},{name:"Slate",rgb:[109,117,141],free:!1},{name:"Light Slate",rgb:[179,185,209],free:!1},{name:"Dark Stone",rgb:[109,100,63],free:!1},{name:"Stone",rgb:[148,140,107],free:!1},{name:"Light Stone",rgb:[205,197,158],free:!1}]}},function(){return h&&(x=(0,h[t(h)[0]])(h=0)),x}),k='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',$='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',M='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',S='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',C=class{constructor(n,e){a(this,v),this.name=n,this.version=e,this.S=null,this.C="bm-v",this.T=null,this.N=null,this.O=[]}I(n){this.S=n}_(){return this.O.length>0&&(this.N=this.O.pop()),this}G(n){n?.appendChild(this.T),this.T=null,this.N=null,this.O=[]}D(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"div",{},n)),this}j(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"p",{},n)),this}F(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"small",{},n)),this}B(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"img",{},n)),this}L(n,e={},t=()=>{}){return t(this,r(this,v,w).call(this,"h"+n,{},e)),this}J(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"hr",{},n)),this}A(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"br",{},n)),this}V(n={},e=()=>{}){const t=r(this,v,w).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const o=r(this,v,w).call(this,"input",{type:"checkbox"},n);return t.insertBefore(o,t.firstChild),this._(),e(this,t,o),this}P(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"button",{},n)),this}R(n={},e=()=>{}){const t=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${t}`;const o={textContent:"?",className:"bm-P",onclick:()=>{this.U(this.C,t)}};return e(this,r(this,v,w).call(this,"button",o,n)),this}H(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"input",{},n)),this}W(n={},e=()=>{}){const t=n.textContent??"";delete n.textContent;const o=r(this,v,w).call(this,"div"),a=r(this,v,w).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this._();const i=r(this,v,w).call(this,"button");this.D({innerHTML:$})._();const s=r(this,v,w).call(this,"span",{textContent:t});return this._(),this._(),this._(),a.setAttribute("tabindex","-1"),a.setAttribute("aria-hidden","true"),i.addEventListener("click",()=>{a.click()}),a.addEventListener("change",()=>{i.style.maxWidth=`${i.offsetWidth}px`,a.files.length>0?s.textContent=a.files[0].name:s.textContent=t}),e(this,o,a,i),this}Y(n={},e=()=>{}){return e(this,r(this,v,w).call(this,"textarea",{},n)),this}U(n,e,t=!1){const o=document.getElementById(n.replace(/^#/,""));o&&(o instanceof HTMLInputElement?o.value=e:t?o.textContent=e:o.innerHTML=e)}q(n,e){let t,o=!1,a=0,r=null,i=0,s=0,l=0,c=0;if(n=document.querySelector("#"==n?.[0]?n:"#"+n),e=document.querySelector("#"==e?.[0]?e:"#"+e),!n||!e)return void this.X(`Can not drag! ${n?"":"moveMe"} ${n||e?"":"and "}${e?"":"iMoveThings "}was not found!`);const d=()=>{if(o){const e=Math.abs(i-l),t=Math.abs(s-c);(e>.5||t>.5)&&(i=l,s=c,n.style.transform=`translate(${i}px, ${s}px)`,n.style.left="0px",n.style.top="0px",n.style.right=""),r=requestAnimationFrame(d)}};let p=null;const m=(m,u)=>{o=!0,p=n.getBoundingClientRect(),t=m-p.left,a=u-p.top;const b=window.getComputedStyle(n).transform;if(b&&"none"!==b){const n=new DOMMatrix(b);i=n.m41,s=n.m42}else i=p.left,s=p.top;l=i,c=s,document.body.style.userSelect="none",e.classList.add("dragging"),r&&cancelAnimationFrame(r),d()},u=()=>{o=!1,r&&(cancelAnimationFrame(r),r=null),document.body.style.userSelect="",e.classList.remove("dragging")};e.addEventListener("mousedown",function(n){n.preventDefault(),m(n.clientX,n.clientY)}),e.addEventListener("touchstart",function(n){const e=n?.touches?.[0];e&&(m(e.clientX,e.clientY),n.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(n){o&&p&&(l=n.clientX-t,c=n.clientY-a)},{passive:!0}),document.addEventListener("touchmove",function(n){if(o&&p){const e=n?.touches?.[0];if(!e)return;l=e.clientX-t,c=e.clientY-a,n.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",u),document.addEventListener("touchend",u),document.addEventListener("touchcancel",u)}K(n){(0,console.info)(`${this.name}: ${n}`),this.U(this.C,"Status: "+n,!0)}X(n){(0,console.error)(`${this.name}: ${n}`),this.U(this.C,"Error: "+n,!0)}};v=new WeakSet,w=function(n,e={},t={}){const o=document.createElement(n);this.T?(this.N?.appendChild(o),this.O.push(this.N),this.N=o):(this.T=o,this.N=o);for(const[n,t]of Object.entries(e))o[n]=t;for(const[n,e]of Object.entries(t))o[n]=e;return o},y();var T=class{constructor({displayName:n="My template",Z:e=0,nn:t="",url:o="",file:a=null,coords:r=null,en:i=null,tn:s=1e3}={}){this.displayName=n,this.Z=e,this.nn=t,this.url=o,this.file=a,this.coords=r,this.en=i,this.tn=s,this.pixelCount=0,this.disabledColors=new Set,this.enhancedColors=new Set,this.an=new Map,this.rn=!1}async sn(){let n;try{n=await createImageBitmap(this.file)}catch(e){const t=new Image,o=document.createElement("canvas"),a=o.getContext("2d");await new Promise((n,e)=>{t.onload=()=>{o.width=t.width,o.height=t.height,a.drawImage(t,0,0),n()},t.onerror=e,t.src=URL.createObjectURL(this.file)}),n={width:o.width,height:o.height,canvas:o,ln:a}}const e=n.width,t=n.height;this.imageWidth=e,this.imageHeight=t;const o=e*t;let a=0,r=0;const i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");s.imageSmoothingEnabled=!1,n.canvas?s.drawImage(n.canvas,0,0):s.drawImage(n,0,0);const l=s.getImageData(0,0,e,t).data;for(let n=0;n<l.length;n+=4)l[n+3]>=64?a++:r++;this.pixelCount=o,this.validPixelCount=a,this.transparentPixelCount=r;const c={},d={},p=document.createElement("canvas");p.width=this.tn,p.height=this.tn;const m=p.getContext("2d",{cn:!0});for(let o=this.coords[3];o<t+this.coords[3];){const a=Math.min(this.tn-o%this.tn,t-(o-this.coords[3]));for(let t=this.coords[2];t<e+this.coords[2];){const r=Math.min(this.tn-t%this.tn,e-(t-this.coords[2])),i=3*r,s=3*a;p.width=i,p.height=s,m.imageSmoothingEnabled=!1,m.clearRect(0,0,i,s),n.canvas?m.drawImage(n.canvas,t-this.coords[2],o-this.coords[3],r,a,0,0,3*r,3*a):m.drawImage(n,t-this.coords[2],o-this.coords[3],r,a,0,0,3*r,3*a);const l=m.getImageData(0,0,i,s);for(let n=0;n<s;n++)for(let e=0;e<i;e++){const t=4*(n*i+e),o=l.data[t],a=l.data[t+1],r=l.data[t+2],s=this.dn([o,a,r]);222===o&&250===a&&206===r?(e+n)%2==0?(l.data[t]=0,l.data[t+1]=0,l.data[t+2]=0,l.data[t+3]=32):l.data[t+3]=0:s?l.data[t+3]=0:e%3==1&&n%3==1||(l.data[t+3]=0)}m.putImageData(l,0,0);const u=`${(this.coords[0]+Math.floor(t/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(o/1e3)).toString().padStart(4,"0")},${(t%1e3).toString().padStart(3,"0")},${(o%1e3).toString().padStart(3,"0")}`;try{c[u]=await createImageBitmap(p)}catch(n){c[u]=p.cloneNode(!0)}try{const n=await new Promise((n,e)=>{p.convertToBlob?p.convertToBlob().then(n).catch(e):p.toBlob(n,"image/png")}),e=await n.arrayBuffer(),t=Array.from(new Uint8Array(e));d[u]=b(t)}catch(n){const e=p.toDataURL("image/png").split(",")[1];d[u]=e}t+=r}o+=a}return{pn:c,mn:d}}un(n){const e=n.join(",");this.disabledColors.add(e)}bn(n){const e=n.join(",");this.disabledColors.delete(e)}dn(n){const e=n.join(",");return this.disabledColors.has(e)}gn(){return Array.from(this.disabledColors)}fn(n){this.disabledColors=new Set(n)}hn(n){const e=`${n[0]},${n[1]},${n[2]}`;this.enhancedColors.add(e),this.xn()}vn(n){const e=`${n[0]},${n[1]},${n[2]}`;this.enhancedColors.delete(e),this.xn()}wn(n){const e=`${n[0]},${n[1]},${n[2]}`;return this.enhancedColors.has(e)}yn(){return Array.from(this.enhancedColors)}kn(n){this.enhancedColors=new Set(n||[]),this.xn()}async $n(){if(!this.en)throw new Error("No chunked tiles available to apply color filter");const n={};for(const[e,t]of Object.entries(this.en)){const o=document.createElement("canvas"),a=o.getContext("2d",{cn:!0});let r,i;void 0!==t.width?(r=t.width,i=t.height):(r=t.width||300,i=t.height||300),o.width=r,o.height=i,a.imageSmoothingEnabled=!1,a.clearRect(0,0,r,i),a.drawImage(t,0,0);const s=a.getImageData(0,0,r,i);for(let n=0;n<i;n++)for(let e=0;e<r;e++){const t=4*(n*r+e);if(e%3!=1||n%3!=1)continue;const o=s.data[t],a=s.data[t+1],i=s.data[t+2];0!==s.data[t+3]&&(this.dn([o,a,i])&&(s.data[t+3]=0))}a.putImageData(s,0,0);try{n[e]=await createImageBitmap(o)}catch(t){console.warn("createImageBitmap failed for tile, using canvas directly"),n[e]=o.cloneNode(!0)}}return n}async Mn(n){const e=new Map;for(const[t,o]of Object.entries(n))try{const n=document.createElement("canvas");n.width=o.width,n.height=o.height;const a=n.getContext("2d");a.imageSmoothingEnabled=!1,a.drawImage(o,0,0);const r=a.getImageData(0,0,n.width,n.height),i=r.data,s=n.width,l=n.height,c=new Uint8ClampedArray(i),d=new Set;let p=0,m=0;for(let n=0;n<l;n++)for(let e=0;e<s;e++){const t=4*(n*s+e),o=c[t+3];p++,o>0&&(m++,d.add(`${e},${n}`),d.size<=5)&&(c[t],c[t+1],c[t+2])}let u=0,b=0,g=0;const f=this.Sn();for(let n=0;n<l;n++)for(let e=0;e<s;e++){const t=4*(n*s+e);if(0===c[t+3]){g++;const o=[[e,n-1],[e,n+1],[e-1,n],[e+1,n]];let a=!1;for(const[n,e]of o)if(!(n<0||n>=s||e<0||e>=l)&&d.has(`${n},${e}`)){a=!0;break}const r=[[e+1,n+1],[e-1,n+1],[e+1,n-1],[e-1,n-1]];let c=!1;if(f)for(const[n,e]of r)if(!(n<0||n>=s||e<0||e>=l)&&d.has(`${n},${e}`)){c=!0;break}if(a){const n=this.Cn();i[t]=n.rgb[0],i[t+1]=n.rgb[1],i[t+2]=n.rgb[2],i[t+3]=n.alpha,u++}else c&&(i[t]=0,i[t+1]=100,i[t+2]=255,i[t+3]=200,b++)}}0===d.size?console.warn("🚨 [CRITICAL] No template pixels found! Template might be completely transparent."):0===u?console.warn("⚠️ [ISSUE] Template pixels found but no crosshairs applied! Check template structure."):f&&0===b&&console.warn("⚠️ [BORDER ISSUE] Borders enabled but none applied! Template might not have diagonal space."),a.putImageData(r,0,0);const h=await createImageBitmap(n);e.set(t,h)}catch(o){console.warn(`Failed to create enhanced tile for ${t}:`,o),e.set(t,n[t])}return e}xn(){this.rn=!1,this.an.clear()}Cn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairColor",null);e&&(n=JSON.parse(e))}if(!n){const e=localStorage.getItem("bmCrosshairColor");e&&(n=JSON.parse(e))}if(n)return n}catch(n){console.warn("Failed to load crosshair color:",n)}return{name:"Red",rgb:[255,0,0],alpha:255}}Sn(){try{let n=null,e="none";if("undefined"!=typeof GM_getValue){const t=GM_getValue("bmCrosshairBorder",null);null!==t&&(n=JSON.parse(t),e="TamperMonkey")}if(null===n){const t=localStorage.getItem("bmCrosshairBorder");null!==t&&(n=JSON.parse(t),e="localStorage")}if(null!==n)return console.groupEnd(),n}catch(n){console.error("❌ Failed to load border setting:",n)}return!1}};function z(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmNavigationMethod",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmNavigationMethod");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load navigation method setting:",n)}return"flyto"}y(),y(),y();var N,O,I,_=!1,G=null,E=new Map;function D(n){_?n.Tn=function(n,e){const t=Array.isArray(e)?e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"):e.toString();return E.has(t)?E.get(t):n}:G&&(n.Tn=async function(n,e){const t=await G(n,e);if(!_){const n=Array.isArray(e)?e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"):e.toString();if(E.set(n,t),E.size>100){const n=E.keys().next().value;E.delete(n)}}return t})}function j(){return _}N=new WeakSet,O=async function(){if(!this.zn)return void console.error("❌ Cannot store templates: this.templatesJSON is null/undefined");const n=JSON.stringify(this.zn),e=Date.now();try{if("undefined"!=typeof GM&&GM.setValue){const t=9e5;if(n.length>t){const o=Math.ceil(n.length/t);try{await(GM.deleteValue?.("bmTemplates"))}catch(n){}await GM.setValue("bmTemplates_chunkCount",o);for(let e=0;e<o;e++){const o=n.slice(e*t,(e+1)*t);await GM.setValue(`bmTemplates_part_${e}`,o)}await GM.setValue("bmTemplates_timestamp",e)}else{await GM.setValue("bmTemplates",n),await GM.setValue("bmTemplates_timestamp",e);try{const n=await GM.getValue("bmTemplates_chunkCount",0);for(let e=0;e<n;e++)await GM.deleteValue(`bmTemplates_part_${e}`);await GM.deleteValue("bmTemplates_chunkCount")}catch(n){}}return}if("undefined"!=typeof GM_setValue)return GM_setValue("bmTemplates",n),void GM_setValue("bmTemplates_timestamp",e)}catch(n){console.warn("⚠️ TamperMonkey storage failed:",n)}try{const t=9e5;if(n.length>t){const o=Math.ceil(n.length/t);try{localStorage.removeItem("bmTemplates")}catch(n){}localStorage.setItem("bmTemplates_chunkCount",String(o));for(let e=0;e<o;e++){const o=n.slice(e*t,(e+1)*t);localStorage.setItem(`bmTemplates_part_${e}`,o)}localStorage.setItem("bmTemplates_timestamp",e.toString())}else{localStorage.setItem("bmTemplates",n),localStorage.setItem("bmTemplates_timestamp",e.toString());const t=parseInt(localStorage.getItem("bmTemplates_chunkCount")||"0");for(let n=0;n<t;n++)localStorage.removeItem(`bmTemplates_part_${n}`);localStorage.removeItem("bmTemplates_chunkCount")}}catch(n){console.error("❌ All storage methods failed:",n),alert("Erro crítico: Não foi possível salvar templates. Verifique as permissões do navegador.")}},I=async function(n){this.zn=n;const e=n.templates;if(Object.keys(e).length>0)for(const n in e){const t=n,o=e[n];if(e.hasOwnProperty(n)){const n=t.split(" "),e=Number(n?.[0]),a=n?.[1]||"0",r=o.name||`Template ${e||""}`,i=o?.coords?.split(", ").map(Number),s=o.tiles,l={},c=Object.entries(s).map(async([n,e])=>{const t=g(e),o=new Blob([t],{type:"image/png"});return[n,await createImageBitmap(o)]}),d=await Promise.all(c);for(const[n,e]of d)l[n]=e;const p=new T({displayName:r,Z:e||this.Nn?.length||0,nn:a||"",coords:i});p.en=l,p.pixelCount=o.pixelCount||0;const m=o.disabledColors;m&&Array.isArray(m)&&p.fn(m);const u=o.enhancedColors;u&&Array.isArray(u)&&p.kn(u),this.Nn.push(p)}}},y(),y();var F=GM_info.script.name.toString(),B=GM_info.script.version.toString();function L(n,e){unsafeWindow.bmmap.flyTo({center:[e,n],zoom:16})}!function(n){const e=document.createElement("script");e.setAttribute("bm-Q",F),e.setAttribute("bm-N","color: cornflowerblue;"),e.textContent=`(${n})();`,document.documentElement?.appendChild(e),e.remove()}(()=>{const n=document.currentScript,e=n?.getAttribute("bm-Q")||"Blue Marble",t=n?.getAttribute("bm-N")||"",o=new Map,a=new MutationObserver(n=>{try{let n=document.querySelector("div.absolute.bottom-3.right-3.z-30").childNodes[0].__click[3].v;"string"==typeof n.version&&(window.bmmap=n,a.disconnect())}catch(n){}});a.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("message",n=>{const{source:a,endpoint:r,blobID:i,blobData:s,blink:l}=n.data;if(Date.now(),"blue-marble"==a&&i&&s&&!r){const n=o.get(i);"function"==typeof n?n(s):m(`%c${e}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,t,"",i),o.delete(i)}});const r=window.fetch;window.fetch=async function(...n){const a=await r.apply(this,n),i=a.clone(),s=(n[0]instanceof Request?n[0]?.url:n[0])||"ignore",l=i.headers.get("content-type")||"";if(l.includes("application/json"))i.json().then(n=>{window.postMessage({source:"blue-marble",endpoint:s,jsonData:n},"*")}).catch(n=>{console.error(`%c${e}%c: Failed to parse JSON: `,t,"",n)});else if(l.includes("image/")&&!s.includes("openfreemap")&&!s.includes("maps")){const n=Date.now(),e=await i.blob();return new Promise(t=>{const a=crypto.randomUUID();o.set(a,n=>{t(new Response(n,{headers:i.headers,status:i.status,statusText:i.statusText}))}),window.postMessage({source:"blue-marble",endpoint:s,blobID:a,blobData:e,blink:n})}).catch(n=>{Date.now()})}return a}});var J=GM_getResourceText("CSS-BM-File");GM_addStyle(J),GM_addStyle("\n#skirk-search-draggable {\n  position: fixed; z-index: 2147483646;\n  top: 50%; left: 50%; transform: translate(-50%, -50%);\n  width: min(480px,94vw); max-height: min(70vh, 600px);\n  background: rgba(30, 41, 59, 0.92); color: #f1f5f9; border-radius: 14px;\n  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05);\n  border: 1px solid #334155;\n  backdrop-filter: blur(14px);\n  font: 14px/1.5 Roboto Mono, monospace, Arial;\n  display: none;\n  flex-direction: column;\n  min-width: 300px;\n  will-change: transform;\n  overflow: hidden;\n}\n#skirk-search-draggable .drag-handle {\n  margin-bottom: 0.4em;\n  background: linear-gradient(135deg, rgba(71,85,105,0.6), rgba(100,116,139,0.55));\n  cursor: grab;\n  width: 100%;\n  height: 28px;\n  border-radius: 14px 14px 0 0;\n  opacity: 0.95;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n#skirk-search-draggable.dragging .drag-handle {\n  cursor: grabbing;\n}\n#skirk-search-draggable .drag-handle::before {\n  content: '';\n  width: 56px;\n  height: 6px;\n  border-radius: 6px;\n  background: linear-gradient(90deg, #94a3b8, #cbd5e1);\n  opacity: 0.7;\n}\n#skirk-search-draggable .hdr {\n  display: flex; align-items: center; justify-content: space-between;\n  padding: 12px 16px 0 16px;\n}\n#skirk-search-draggable .hdr h3 {\n  margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 0.04em;\n  display: flex; align-items: center; gap: 0.6em;\n  color: #f8fafc;\n}\n#skirk-search-draggable .hdr .actions {\n  display: flex; gap: 8px;\n}\n#skirk-search-draggable .hdr button {\n  border: 1px solid #475569; padding: 8px 10px; border-radius: 8px;\n  background: #334155; color: #f1f5f9; font: 13px monospace;\n  cursor: pointer;\n  transition: all 0.18s ease;\n}\n#skirk-search-draggable .hdr button:hover { \n  background: #475569; \n  transform: translateY(-1px);\n}\n#skirk-search-draggable .hdr button:active { \n  background: #334155; \n  transform: translateY(0px);\n}\n#skirk-search-draggable .body {\n  padding: 12px 16px 16px 16px; overflow: hidden;\n}\n#skirk-search-input {\n  width: 100%; padding: 12px 14px; border-radius: 10px;\n  border: 1px solid #475569; background: #0b1222;\n  color: #f1f5f9; font: 14px monospace;\n  margin-bottom: 12px;\n  transition: all 0.2s ease;\n}\n#skirk-search-input:focus { \n  outline: none;\n  border-color: #3b82f6;\n  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);\n}\n#skirk-search-input::placeholder { color: #64748b; }\n#skirk-search-results {\n  max-height: 360px; overflow-y: auto; overflow-x: hidden;\n}\n#skirk-search-results::-webkit-scrollbar {\n  width: 6px;\n}\n#skirk-search-results::-webkit-scrollbar-track {\n  background: #0f172a;\n  border-radius: 3px;\n}\n#skirk-search-results::-webkit-scrollbar-thumb {\n  background: #475569;\n  border-radius: 3px;\n}\n#skirk-search-results::-webkit-scrollbar-thumb:hover {\n  background: #64748b;\n}\n.skirk-search-result {\n  padding: 12px; cursor: pointer;\n  border: 1px solid transparent;\n  border-radius: 10px;\n  transition: all 0.2s ease;\n  position: relative;\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  gap: 8px;\n  overflow: hidden;\n}\n.skirk-search-result:hover {\n  background-color: rgba(51, 65, 85, 0.55);\n  border-color: #334155;\n  transform: translateX(2px);\n}\n.skirk-result-content {\n  flex: 1; min-width: 0; overflow: hidden;\n}\n.skirk-result-name {\n  font-size: 15px;\n  color: #f1f5f9;\n  margin-bottom: 4px;\n  font-weight: 700;\n}\n.skirk-result-address {\n  font-size: 12px;\n  color: #94a3b8;\n  line-height: 1.3; overflow-wrap: anywhere; word-break: break-word;\n}\n.skirk-result-address.secondary {\n  color: #cbd5e1;\n  font-weight: 500;\n}\n.skirk-favorite-star {\n  color: #64748b;\n  font-size: 18px;\n  cursor: pointer;\n  padding: 6px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n  user-select: none;\n  margin-left: 8px;\n}\n.skirk-favorite-star:hover {\n  color: #fbbf24;\n  background: rgba(251, 191, 36, 0.1);\n  transform: scale(1.1);\n}\n.skirk-favorite-star.favorited {\n  color: #fbbf24;\n}\n.skirk-loading, .skirk-no-results {\n  padding: 20px;\n  text-align: center;\n  color: #64748b;\n  font-size: 14px;\n}\n.skirk-icon {\n  display: inline-block; height: 2em; margin-right: 1ch; vertical-align: middle;\n}\n\n/* Favorites Menu */\n#skirk-favorites-menu {\n  border-top: 1px solid #334155;\n  margin-top: 12px;\n  padding-top: 12px;\n}\n#skirk-favorites-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 8px;\n  padding: 0 2px;\n}\n#skirk-favorites-title {\n  font-size: 13px;\n  font-weight: 700;\n  color: #cbd5e1;\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  transition: color 0.2s;\n}\n#skirk-favorites-title:hover {\n  color: #f1f5f9;\n}\n#skirk-favorites-toggle {\n  font-size: 10px;\n  transition: transform 0.2s;\n}\n#skirk-favorites-toggle.collapsed {\n  transform: rotate(-90deg);\n}\n#skirk-favorites-count {\n  background: #475569;\n  color: #f1f5f9;\n  border-radius: 10px;\n  padding: 2px 6px;\n  font-size: 11px;\n  font-weight: 500;\n}\n#skirk-clear-favorites {\n  background: none;\n  border: 1px solid #475569;\n  color: #cbd5e1;\n  cursor: pointer;\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n}\n#skirk-clear-favorites:hover {\n  color: #ef4444;\n  background: rgba(239, 68, 68, 0.1);\n}\n#skirk-favorites-list {\n  max-height: 200px;\n  overflow-y: auto;\n}\n.skirk-favorites-filter {\n  width: 100%;\n  padding: 8px 10px;\n  border-radius: 8px;\n  border: 1px solid #475569;\n  background: #0b1222;\n  color: #f1f5f9;\n  font: 12px monospace;\n  margin: 8px 0 6px 0;\n  transition: all 0.2s ease;\n}\n.skirk-favorites-filter:focus {\n  outline: none;\n  border-color: #3b82f6;\n  box-shadow: 0 0 0 3px rgba(59,130,246,0.12);\n}\n.skirk-favorite-item {\n  padding: 10px;\n  cursor: pointer;\n  border-radius: 8px;\n  margin-bottom: 4px;\n  transition: all 0.2s ease;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n.skirk-favorite-item:hover {\n  background: rgba(51, 65, 85, 0.55);\n}\n.skirk-favorite-item .skirk-result-content {\n  flex: 1;\n}\n.skirk-favorite-item .skirk-result-name {\n  font-size: 13px;\n  margin-bottom: 2px;\n}\n.skirk-favorite-item .skirk-result-address {\n  font-size: 11px;\n}\n.skirk-favorite-remove {\n  color: #94a3b8;\n  font-size: 14px;\n  cursor: pointer;\n  padding: 4px 6px;\n  border-radius: 6px;\n  transition: all 0.2s ease;\n}\n.skirk-favorite-remove:hover {\n  color: #ef4444;\n  background: rgba(239, 68, 68, 0.1);\n}\n\n/* Custom Location Modal */\n#skirk-location-modal {\n  position: fixed;\n  top: 0; left: 0; right: 0; bottom: 0;\n  background: rgba(0, 0, 0, 0.7);\n  z-index: 2147483647;\n  display: none;\n  align-items: center;\n  justify-content: center;\n}\n#skirk-location-dialog {\n  background: rgba(30,41,59,0.96);\n  color: #f1f5f9;\n  border-radius: 14px;\n  border: 1px solid #334155;\n  padding: 20px;\n  min-width: 420px;\n  max-width: 90vw;\n  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.05);\n  backdrop-filter: blur(12px);\n}\n#skirk-location-dialog h3 {\n  margin: 0 0 16px 0;\n  color: #f1f5f9;\n  font-size: 18px;\n}\n#skirk-location-dialog .form-group {\n  margin-bottom: 16px;\n}\n#skirk-location-dialog label {\n  display: block;\n  margin-bottom: 4px;\n  color: #cbd5e1;\n  font-size: 14px;\n  font-weight: 500;\n}\n#skirk-location-dialog input {\n  width: 100%;\n  padding: 10px 12px;\n  border: 1px solid #475569;\n  background: #0b1222;\n  color: #f1f5f9;\n  border-radius: 10px;\n  font: 14px monospace;\n  transition: all 0.2s ease;\n}\n#skirk-location-dialog input:focus {\n  outline: none;\n  border-color: #3b82f6;\n  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);\n}\n#skirk-location-dialog input[readonly] {\n  background: #0a0e1a;\n  border-color: #374151;\n  color: #9ca3af;\n  cursor: not-allowed;\n}\n#skirk-location-dialog input[readonly]:focus {\n  border-color: #374151;\n  box-shadow: none;\n}\n#skirk-location-dialog .button-group {\n  display: flex;\n  gap: 8px;\n  justify-content: flex-end;\n  margin-top: 20px;\n}\n#skirk-location-dialog button {\n  padding: 10px 16px;\n  border: 1px solid #475569;\n  border-radius: 8px;\n  font: 14px monospace;\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n#skirk-location-dialog .btn-primary {\n  background: #3b82f6;\n  color: #fff;\n}\n#skirk-location-dialog .btn-primary:hover {\n  background: #2563eb;\n}\n#skirk-location-dialog .btn-secondary {\n  background: #334155;\n  color: #f1f5f9;\n}\n#skirk-location-dialog .btn-secondary:hover {\n  background: #475569;\n}\n\n\n");var A=document.createElement("link");A.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",A.rel="preload",A.as="style",A.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(A);var V=document.createElement("link");V.href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap",V.rel="preload",V.as="style",V.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(V),new class{constructor(){this.On=null,this.In=null,this._n="#bm-n"}Gn(n){return this.In=n,this.On=new MutationObserver(n=>{for(const e of n)for(const n of e.addedNodes)n instanceof HTMLElement&&n.matches?.(this._n)}),this}En(){return this.On}observe(n,e=!1,t=!1){n.observe(this.In,{childList:e,subtree:t})}};var P=new C(F,B),R=(new C(F,B),new class{constructor(n,e,t){a(this,N),this.name=n,this.version=e,this.T=t,this.Dn="1.0.0",this.jn=null,this.Fn="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.tn=1e3,this.Bn=3,this.Ln=new Map,this.Jn=new Set,this.An=0,this.Vn=!0,this.Pn=!1,this.Rn=!0,this.Un=!0,this.Hn=!1,this.Wn=!1,this.Yn=!1,this.qn(),this.Xn=null,this.Kn=null,this.Qn="bm-O",this.Zn="div#map canvas.maplibregl-canvas",this.ne=null,this.ee="",this.Nn=[],this.zn=null,this.te=!0}oe(){if(document.body.contains(this.Xn))return this.Xn;document.getElementById(this.Qn)?.remove();const n=document.querySelector(this.Zn),e=document.createElement("canvas");return e.id=this.Qn,e.className="maplibregl-canvas",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height=n?.clientHeight*(window.devicePixelRatio||1)+"px",e.style.width=n?.clientWidth*(window.devicePixelRatio||1)+"px",e.height=n?.clientHeight*(window.devicePixelRatio||1),e.width=n?.clientWidth*(window.devicePixelRatio||1),e.style.zIndex="8999",e.style.pointerEvents="none",n?.parentElement?.appendChild(e),this.Xn=e,window.addEventListener("move",this.ae),window.addEventListener("zoom",this.re),window.addEventListener("resize",this.ie),this.Xn}async se(){return{whoami:"BlueMarble",scriptVersion:this.version,schemaVersion:this.Dn,createdAt:(new Date).toISOString(),lastModified:(new Date).toISOString(),templateCount:0,totalPixels:0,templates:{}}}le(n,e){if(!this.zn?.templates)return null;if(!n||!e||e<=0)return null;for(const[t,o]of Object.entries(this.zn.templates))if(o.name===n&&o.pixelCount===e)return t;return null}async ce(n,e,t){this.zn||(this.zn=await this.se()),this.T.K(`Creating template at ${t.join(", ")}...`);const o=new T({displayName:e,Z:0,nn:u(this.jn||0,this.Fn),file:n,coords:t}),{pn:a,mn:i}=await o.sn(this.tn);o.en=a;const s=this.le(e,o.pixelCount);let l,c;if(s){c=parseInt(s.split(" ")[0]),this.T.K(`Duplicate detected! Replacing existing template "${e}"...`);const n=this.Nn.findIndex(n=>`${n.Z} ${n.nn}`===s);-1!==n&&this.Nn.splice(n,1),this.zn.templates[s]&&delete this.zn.templates[s]}else{const n=Object.keys(this.zn.templates).map(n=>parseInt(n.split(" ")[0]));c=n.length>0?Math.max(...n)+1:0}l=new T({displayName:e,Z:c,nn:u(this.jn||0,this.Fn),file:n,coords:t});const{pn:d,mn:p}=await l.sn(this.tn);l.en=d,this.zn.templates[`${l.Z} ${l.nn}`]={name:l.displayName,coords:t.join(", "),createdAt:(new Date).toISOString(),pixelCount:l.pixelCount,validPixelCount:l.validPixelCount,transparentPixelCount:l.transparentPixelCount,enabled:!0,disabledColors:l.gn(),enhancedColors:l.yn(),tiles:p},this.zn.lastModified=(new Date).toISOString(),this.zn.templateCount=Object.keys(this.zn.templates).length,this.zn.totalPixels=this.Nn.reduce((n,e)=>n+(e.pixelCount||0),0)+l.pixelCount,this.Nn||(this.Nn=[]),this.Nn.push(l);const m=(new Intl.NumberFormat).format(l.pixelCount),b=Object.keys(this.zn.templates).length,g=s?"replaced":"created";this.T.K(`Template #${l.Z} ${g} at ${t.join(", ")}! Total pixels: ${m} | Total templates: ${b}`),await r(this,N,O).call(this)}async de(n){if(!n||!this.zn?.templates)return m("⚠️ Invalid template key or no templates available"),!1;try{const e=this.Nn.find(e=>`${e.Z} ${e.nn}`===n);if(e&&(e.an&&e.an.clear(),e.en))for(const[n,t]of Object.entries(e.en))if(t&&"function"==typeof t.close)try{t.close()}catch(n){}this.pe();try{E.size,E.clear()}catch(n){}this.zn.templates[n]&&delete this.zn.templates[n];const t=this.Nn.findIndex(e=>`${e.Z} ${e.nn}`===n);if(-1!==t&&this.Nn.splice(t,1),this.zn.lastModified=(new Date).toISOString(),this.zn.templateCount=Object.keys(this.zn.templates).length,this.zn.totalPixels=this.Nn.reduce((n,e)=>n+(e.pixelCount||0),0),await r(this,N,O).call(this),"function"==typeof refreshTemplateDisplay)try{await refreshTemplateDisplay()}catch(n){m("Warning: Failed to refresh template display:",n)}if("function"==typeof updateMiniTracker&&updateMiniTracker(),"function"==typeof window.gc)try{window.gc()}catch(n){}return!0}catch(n){return p("❌ Failed to delete template:",n),!1}}async me(){this.zn||(this.zn=await this.se())}async Tn(n,e){if(!this.te)return n;const t=this.tn*this.Bn;e=e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0");const o=this.Nn;o.sort((n,e)=>n.Z-e.Z);const a=o.filter(n=>{const e=`${n.Z} ${n.nn}`;return this.ue(e)}).map(n=>{const t=Object.keys(n.en).filter(n=>n.startsWith(e));if(0===t.length)return null;const o=t.map(e=>{const t=e.split(",");return{be:n.en[e],ge:[t[0],t[1]],fe:[t[2],t[3]]}});return o?.[0]}).filter(Boolean),r=a?.length||0;if(r>0){this.Jn.clear();for(const n of o){const t=`${n.Z} ${n.nn}`;this.ue(t)&&Object.keys(n.en).filter(n=>n.startsWith(e)).length>0&&this.Jn.add(t)}this.An=this.Jn.size;const n=o.filter(n=>{const t=Object.keys(n.en).filter(n=>n.startsWith(e)),o=`${n.Z} ${n.nn}`,a=this.ue(o);return t.length>0&&a}).reduce((n,e)=>n+(e.pixelCount||0),0),t=(new Intl.NumberFormat).format(n);this.T.K(`Displaying ${r} template${1==r?"":"s"}.\nTotal pixels: ${t}`)}else this.T.K(`Displaying ${r} templates.`),this.Jn.clear(),this.An=0;const i=await createImageBitmap(n),s=document.createElement("canvas");s.width=t,s.height=t;const l=s.getContext("2d");l.imageSmoothingEnabled=!1,l.beginPath(),l.rect(0,0,t,t),l.clip(),l.clearRect(0,0,t,t),l.drawImage(i,0,0,t,t);for(let n=0;n<a.length;n++){const t=a[n],r=o[n],i=r&&r.gn().length>0,c=r&&(r.enhancedColors.size>0||this.Yn);if(this.Yn&&this.Ln.has(e)){const n=this.Ln.get(e);n.he&&Object.entries(n.he).filter(([n,e])=>e.xe>0).map(([n,e])=>`${n}(${e.xe} wrong)`)}if(c||i){const n=document.createElement("canvas");n.width=t.be.width,n.height=t.be.height;const e=n.getContext("2d");e.imageSmoothingEnabled=!1,e.drawImage(t.be,0,0);const o=e.getImageData(0,0,n.width,n.height),a=o.data,d=n.width,p=n.height,m=c?new Uint8ClampedArray(a):null,u=c?new Set:null;let b=null;if(c&&(b=l.getImageData(0,0,s.width,s.height).data),i)for(let n=0;n<p;n++)for(let e=0;e<d;e++){if(e%this.Bn!==1||n%this.Bn!==1)continue;const t=4*(n*d+e),o=a[t],i=a[t+1],s=a[t+2];0!==a[t+3]&&(r.dn([o,i,s])?a[t+3]=0:c&&r.wn([o,i,s])&&u.add(`${e},${n}`))}else if(c){let n=0;for(let e=0;e<p;e++)for(let t=0;t<d;t++){if(t%this.Bn!==1||e%this.Bn!==1)continue;const o=4*(e*d+t);if(m[o+3]>0){const a=m[o],i=m[o+1],s=m[o+2];r.wn([a,i,s])&&(u.add(`${t},${e}`),n++)}}}if(c&&u&&u.size>0)if(u.size>6e4);else{let n=0;const e=Number(t.fe[0])*this.Bn,o=Number(t.fe[1])*this.Bn;let r=null;try{e>=0&&o>=0&&e+d<=s.width&&o+p<=s.height&&(r=l.getImageData(e,o,d,p).data)}catch(n){console.warn("Could not get canvas region, using fallback mode")}const i=Array.from(u),c=i.length>25e3,g=c?8e3:i.length,f=new Set;let h=0;if(this.Yn){for(const n of i){const[t,a]=n.split(",").map(Number),i=4*(a*d+t),l=m[i],c=m[i+1],p=m[i+2];let u=0,g=0,x=0,v=0;if(r)u=r[i],g=r[i+1],x=r[i+2],v=r[i+3];else{const n=t+e,r=a+o;if(n>=0&&n<s.width&&r>=0&&r<s.height){const e=4*(r*s.width+n);u=b[e],g=b[e+1],x=b[e+2],v=b[e+3]}}v>0&&(u!==l||g!==c||x!==p)&&(f.add(n),h++)}for(const n of f)u.add(n);Array.from(u)}const x=this.Sn();let v=0;const w=this.Yn&&h>0&&"undefined"!=typeof updatedEnhancedPixelsArray?updatedEnhancedPixelsArray:i;for(let t=0;t<w.length;t+=g){const i=Math.min(t+g,w.length),l=w.slice(t,i);c&&t>0&&Math.floor(t/g)%3==0&&(Math.floor(t/g),Math.ceil(w.length/g));for(const t of l){const[i,l]=t.split(",").map(Number),c=f.has(t),u=this.ve(),g=[[0,-1],[0,1],[-1,0],[1,0]];let h=g.map(([n,e])=>[n,e,"center"]);if(u){let n=!1;for(const[t,a]of g){const u=i+t,g=l+a;if(u<0||u>=d||g<0||g>=p)continue;const f=4*(g*d+u);if(0!==m[f+3])continue;let h=!1;if(r)h=r[f+3]>0;else{const n=u+e,t=g+o;n>=0&&n<s.width&&t>=0&&t<s.height&&(h=b[4*(t*s.width+n)+3]>0)}if(!h||c){n=!0;break}}if(n){const n=this.we();for(let e=2;e<=n;e++)h.push([0,-e,"center"]),h.push([0,e,"center"]),h.push([-e,0,"center"]),h.push([e,0,"center"])}}for(const[t,u,g]of h){const g=i+t,f=l+u;if(g<0||g>=d||f<0||f>=p)continue;const h=4*(f*d+g);if(0!==m[h+3])continue;let x=!1;if(r)x=r[h+3]>0;else{const n=g+e,t=f+o;n>=0&&n<s.width&&t>=0&&t<s.height&&(x=b[4*(t*s.width+n)+3]>0)}if(x&&!c)continue;const v=this.Cn();a[h]=v.rgb[0],a[h+1]=v.rgb[1],a[h+2]=v.rgb[2],a[h+3]=v.alpha,n++}if(x){const n=[[1,1],[-1,1],[1,-1],[-1,-1]];for(const[t,c]of n){const n=i+t,u=l+c;if(n<0||n>=d||u<0||u>=p)continue;const g=4*(u*d+n);if(0!==m[g+3])continue;let f=!1;if(r)f=r[g+3]>0;else{const t=n+e,a=u+o;t>=0&&t<s.width&&a>=0&&a<s.height&&(f=b[4*(a*s.width+t)+3]>0)}f||(a[g]=0,a[g+1]=100,a[g+2]=255,a[g+3]=200,v++)}}}}}e.putImageData(o,0,0),l.drawImage(n,Number(t.fe[0])*this.Bn,Number(t.fe[1])*this.Bn)}else l.drawImage(t.be,Number(t.fe[0])*this.Bn,Number(t.fe[1])*this.Bn)}if(a.length>0){let o=0,r=0,i=0;try{const s=e.split(","),l=parseInt(s[0]),c=parseInt(s[1]);let d;{const e=await createImageBitmap(n),o=document.createElement("canvas");o.width=t,o.height=t;const a=o.getContext("2d",{cn:!0});a.imageSmoothingEnabled=!1,a.clearRect(0,0,t,t),a.drawImage(e,0,0,t,t),d=a.getImageData(0,0,t,t)}const p=d.data,m={};for(const n of a){const e=n.be.width,a=n.be.height,s=document.createElement("canvas");s.width=e,s.height=a;const l=s.getContext("2d",{cn:!0});l.imageSmoothingEnabled=!1,l.drawImage(n.be,0,0);const c=l.getImageData(0,0,e,a).data,d=Number(n.fe[0])*this.Bn,u=Number(n.fe[1])*this.Bn;for(let n=0;n<a;n++)for(let a=0;a<e;a++){if(a%this.Bn!==1||n%this.Bn!==1)continue;const s=a+d,l=n+u;if(s<0||l<0||s>=t||l>=t)continue;const b=4*(n*e+a),g=c[b],f=c[b+1],h=c[b+2];if(c[b+3]<64)continue;if(222===g&&250===f&&206===h)continue;const x=`${g},${f},${h}`;m[x]||(m[x]={ye:0,required:0,xe:0}),m[x].required++,i++;const v=4*(l*t+s),w=p[v],y=p[v+1],k=p[v+2];p[v+3]<64||(w===g&&y===f&&k===h?(o++,m[x].ye++):(r++,m[x].xe++))}}this.Ln.set(e,{ye:o,required:i,xe:r,he:m});const u=`lastProgress_${l}_${c}`,b=this[u]||{ye:0,required:0,xe:0};b.ye,b.xe,this[u]={ye:o,required:i,xe:r}}catch(n){m("Failed to compute tile progress stats:",n)}}if(this.Pn&&a.length>0)try{let e=null;try{const o=await createImageBitmap(n),a=document.createElement("canvas");a.width=t,a.height=t;const r=a.getContext("2d",{cn:!0});r.imageSmoothingEnabled=!1,r.clearRect(0,0,t,t),r.drawImage(o,0,0,t,t),e=r.getImageData(0,0,t,t).data}catch(n){}if(e){const n=[],o=[];for(const r of a){const a=r.be.width,i=r.be.height,s=new OffscreenCanvas(a,i).getContext("2d",{cn:!0});s.imageSmoothingEnabled=!1,s.clearRect(0,0,a,i),s.drawImage(r.be,0,0);const l=s.getImageData(0,0,a,i).data,c=Number(r.fe[0])*this.Bn,d=Number(r.fe[1])*this.Bn;for(let r=0;r<i;r++)for(let i=0;i<a;i++){if(i%this.Bn!==1||r%this.Bn!==1)continue;const s=i+c,p=r+d;if(s<0||p<0||s>=t||p>=t)continue;const m=4*(r*a+i),u=l[m],b=l[m+1],g=l[m+2],f=l[m+3];if(f<64){try{const o=this.Nn?.[0],a=4*(p*t+s),r=e[a],i=e[a+1],l=e[a+2],c=e[a+3],d=`${r},${i},${l}`,m=!!o?.ke&&o.ke.has(d);c>=64&&m&&n.push({x:s,y:p,color:`${u},${b},${g}`})}catch(n){}continue}try{const n=this.Nn?.[0];if(n?.ke&&!n.ke.has(`${u},${b},${g}`))continue}catch(n){}const h=4*(p*t+s),x=e[h],v=e[h+1],w=e[h+2];e[h+3]<64?this.Hn&&0!==f&&n.push({x:s,y:p,color:`${u},${b},${g}`,$e:!0}):x===u&&v===b&&w===g?o.push({x:s,y:p,color:`${u},${b},${g}`}):n.push({x:s,y:p,color:`${u},${b},${g}`,$e:!1})}}l.globalCompositeOperation="source-over";const r=this.Nn?.[0],i=r?.Me||{},s=n=>!((!r?.ke||r.ke.has(n))&&!1!==i?.[n]?.enabled);if(this.Un){l.fillStyle="rgba(255, 0, 0, 0.8)";for(const{x:e,y:t,color:o,$e:a}of n)if(!s(o))if(a)l.fillRect(e,t,1,1);else{const n=Math.floor(this.Bn/2);l.fillRect(e-n,t-n,this.Bn,this.Bn)}}if(this.Rn){l.fillStyle="rgba(0, 128, 0, 0.6)";for(const{x:n,y:e,color:t}of o){if(s(t))continue;const o=Math.floor(this.Bn/2);l.fillRect(n-o,e-o,this.Bn,this.Bn)}}}}catch(n){console.warn("Failed to render error map overlay:",n)}return await new Promise((n,e)=>{s.convertToBlob?s.convertToBlob({type:"image/png"}).then(n).catch(e):s.toBlob(n,"image/png")})}Se(n){const e=["SkirkMarble","BlueMarble",this.name?.replace(" ","")].filter(Boolean);e.includes(n?.whoami)?r(this,N,I).call(this,n):console.warn("❌ Not a valid BlueMarble JSON:",{whoami:n?.whoami,Ce:e,Te:!!n?.templates})}ze(n){this.te=n}Ne(n,e){return this.zn?.templates?.[n]?(this.zn.templates[n].enabled=e,this.zn.lastModified=(new Date).toISOString(),r(this,N,O).call(this),this.pe(),!0):(m(`Template not found: ${n}`),!1)}async Oe(n,e){try{if(!this.zn?.templates?.[n])return!1;const t=String(e||"").trim();if(!t)return!1;this.zn.templates[n].name=t,this.zn.lastModified=(new Date).toISOString();const[o,a]=n.split(" "),i=parseInt(o,10),s=this.Nn?.findIndex(n=>n.Z===i&&n.nn===a)??-1;return-1!==s&&(this.Nn[s].displayName=t),await r(this,N,O).call(this),!0}catch(n){return p("Failed to rename template",n),!1}}pe(){this.Ln.size,this.Ln.clear()}Ie(n){this.Vn=n,this.pe()}_e(){return this.Vn}Ge(){return{count:this.An,templates:Array.from(this.Jn),Ee:this.Vn&&1===this.An}}ue(n){return this.zn?.templates?.[n]?.enabled??!0}async De(n=0){if(!this.Nn||!this.Nn[n])return void m("No template available for color filter update");const e=this.Nn[n];try{if(this.zn&&this.zn.templates){const n=`${e.Z} ${e.nn}`;this.zn.templates[n]&&(this.zn.templates[n].disabledColors=e.gn(),this.zn.templates[n].enhancedColors=e.yn())}await r(this,N,O).call(this)}catch(n){throw p("Error updating template color filter settings:",n),this.T.X("Failed to update template color filter settings"),n}}async je(n,e=0){this.Nn&&this.Nn[e]?(this.Nn[e].fn(n),await this.De(e)):m("No template available for color filter update")}Fe(n=0){return this.Nn&&this.Nn[n]?this.Nn[n].gn():[]}Be(n=0,e=!0){let t=!1,o=new Set;if(this.Vn&&1===this.An&&1===this.Jn.size){t=!0,o=new Set(this.Jn);for(const n of o)this.Nn.find(e=>`${e.Z} ${e.nn}`===n)}const a=t?o:new Set;if(!t&&e&&this.Nn){for(const n of this.Nn){const e=`${n.Z} ${n.nn}`;this.ue(e)&&a.add(e)}if(0===a.size)return m("🚨 [Enhanced Pixel Analysis] No enabled templates found"),{}}let r=null;if(e&&a.size>0){for(const n of this.Nn){const e=`${n.Z} ${n.nn}`;if(a.has(e)){r=n;break}}if(!r)return m("🚨 [Enhanced Pixel Analysis] No enabled template found for reference"),{}}else{if(!this.Nn||!this.Nn[n])return m("🚨 [Enhanced Pixel Analysis] No template available"),{};r=this.Nn[n]}try{if(this.Ln&&this.Ln.size>0){const n={};let t=0,o=0,i=0;const s={};for(const[n,r]of this.Ln.entries()){let l=!0;if(e&&a.size>0){l=!1;const[e,t]=n.split(",").map(n=>parseInt(n));for(const n of this.Nn){const o=`${n.Z} ${n.nn}`;if(a.has(o)){if(n.en)for(const o of Object.keys(n.en)){const[n,a]=o.split(",").map(n=>parseInt(n));if(n===e&&a===t){l=!0;break}}if(l)break}}if(!l)continue}if(t+=r.ye||0,o+=r.required||0,i+=r.xe||0,r.he)for(const[n,e]of Object.entries(r.he))s[n]||(s[n]={ye:0,required:0,xe:0}),s[n].ye+=e.ye,s[n].required+=e.required,s[n].xe+=e.xe}if(r.Me&&0!==Object.keys(r.Me).length||(r.Me=this.Le(r)),r.Me&&Object.keys(r.Me).length>0)for(const[e,a]of Object.entries(r.Me)){const r=a.count||0;let l,c,d,p;if(s[e])if(l=s[e].ye,c=s[e].xe,this.Wn){const n=l+c,t=s[e].required;d=t-n,p=t>0?Math.round(n/t*100):0}else d=s[e].required-l,p=s[e].required>0?Math.round(l/s[e].required*100):0;else{const n=o>0?r/o:0;if(l=Math.round(t*n),c=Math.round(i*n),this.Wn){const n=l+c,e=r;d=e-n,p=e>0?Math.round(n/e*100):0}else d=r-l,p=r>0?Math.round(l/r*100):0}const m=this.Wn?l+c:l,u=s[e]?s[e].required:r,b=u>0?Math.round(m/u*100):0;n[e]={Je:u,ye:m,Ae:Math.max(0,d),Ve:b,Pe:Math.max(0,d)}}let l=0,c=0;for(const e of Object.values(n))l+=e.ye||0,c+=e.Je||0;if(c>0&&Math.round(l/c*100),this.Wn){const n=t+i,e=o;e>0&&Math.round(n/e*100)}return n}return m("🚨 [Enhanced Pixel Analysis] No tile progress data available - need to wait for tiles to be processed"),this.Re(r)}catch(n){return p("❌ [Enhanced Pixel Analysis] Analysis failed:",n),this.Re(r)}}Ue(n,e,t,o,a){const r=n.split(",").map(Number),[i,s,l,c]=r,d=l-t.coords[2],p=c-t.coords[3],u=document.createElement("canvas");u.width=e.width,u.height=e.height;const b=u.getContext("2d");b.imageSmoothingEnabled=!1,b.drawImage(e,0,0);const g=b.getImageData(0,0,e.width,e.height).data,f=o.getContext("2d",{cn:!0}),h=Math.min(e.width,o.width-d),x=Math.min(e.height,o.height-p);if(h<=0||x<=0)return m(`🚨 [Tile Analysis] Invalid tile dimensions: ${h}x${x}`),{He:{},We:0,Ye:0,qe:0};const v=f.getImageData(d,p,h,x).data,w=new Set;let y={},k={};for(let n=0;n<e.height;n++)for(let o=0;o<e.width;o++){const r=4*(n*e.width+o);if(g[r+3]>0){const e=`${g[r]},${g[r+1]},${g[r+2]}`;y[e]||(y[e]=0,k[e]=`(${o},${n})`),(!a||t.enhancedColors.has(e)||this.Yn&&this.Xe(e,tileCoords))&&(w.add(`${o},${n}`),y[e]++)}}const $={};let M=0,S=0,C=0;for(let n=0;n<e.height;n+=this.Bn)for(let t=0;t<e.width;t+=this.Bn){const o=t+1,a=n+1;if(!w.has(`${o},${a}`))continue;const r=4*(a*e.width+o),i=g[r],s=g[r+1],l=g[r+2];if(222===i&&250===s&&206===l)continue;const c=`${i},${s},${l}`;$[c]||($[c]={Je:0,ye:0,Ae:0}),$[c].Je++,M++;let d=!1,p="no canvas data";if(o<h&&a<x){const n=4*(a*h+o),e=v[n+3];if(e>0){const t=v[n],o=v[n+1],a=v[n+2];p=`RGBA(${t},${o},${a},${e})`,t===i&&o===s&&a===l&&(d=!0,$[c].ye++,S++)}}d||($[c].Ae++,C++)}for(const[n,e]of Object.entries($))e.Je>0&&Math.round(e.ye/e.Je*100);return{He:$,We:M,Ye:S,qe:C}}Le(n){const e={};try{for(const[t,o]of Object.entries(n.en||{})){const n=document.createElement("canvas");n.width=o.width,n.height=o.height;const t=n.getContext("2d",{cn:!0});t.imageSmoothingEnabled=!1,t.drawImage(o,0,0);const a=t.getImageData(0,0,o.width,o.height).data;for(let n=0;n<o.height;n++)for(let t=0;t<o.width;t++){if(t%this.Bn!==1||n%this.Bn!==1)continue;const r=4*(n*o.width+t),i=a[r],s=a[r+1],l=a[r+2];if(a[r+3]<64)continue;if(222===i&&250===s&&206===l)continue;const c=`${i},${s},${l}`;e[c]||(e[c]={count:0,enabled:!0}),e[c].count++}}}catch(n){m("🚨 [Build Palette] Failed to build color palette:",n)}return e}Re(n){const e={};for(const[t,o]of Object.entries(n.Me||{})){const n=o.count||0,a=t.split(",").reduce((n,e)=>n+parseInt(e),0)%100/100*.9,r=Math.floor(n*a),i=n-r;e[t]={Je:n,ye:r,Ae:i,Ve:n>0?Math.round(r/n*100):0}}return e}Cn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairColor",null);e&&(n=JSON.parse(e))}if(!n){const e=localStorage.getItem("bmCrosshairColor");e&&(n=JSON.parse(e))}if(n)return n}catch(n){console.warn("Failed to load crosshair color:",n)}return{name:"Red",rgb:[255,0,0],alpha:255}}we(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairRadius",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairRadius");null!==e&&(n=JSON.parse(e))}if(null!==n)return Math.max(12,Math.min(32,n))}catch(n){console.warn("Failed to load crosshair radius:",n)}return 16}Sn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairBorder",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairBorder");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){console.warn("Failed to load border setting:",n)}return!1}ve(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairEnhancedSize",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairEnhancedSize");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){console.warn("Failed to load enhanced size setting:",n)}return!1}async Ke(n){this.Wn=n,this.Qe()}Ze(){return this.Wn}async nt(n){this.Yn=n,this.Qe(),this.et=new Set,this.tt=new Set,this.ot=null,this.rt=!1,this.Nn&&this.Nn.length>0&&(this.ze(!1),setTimeout(()=>{this.ze(!0)},50))}it(){return this.Yn}st(n){this.Pn=!!n}lt(){return this.Pn}qn(){try{if("undefined"!=typeof GM_getValue){const n=GM_getValue("bmIncludeWrongColors",null),e=GM_getValue("bmEnhanceWrongColors",null),t=null!==n&&"null"!==n,o=null!==e&&"null"!==e;if(t&&(this.Wn=JSON.parse(n)),o&&(this.Yn=JSON.parse(e)),t&&o)return}const n=localStorage.getItem("bmIncludeWrongColors"),e=localStorage.getItem("bmEnhanceWrongColors");null!==n&&(this.Wn=JSON.parse(n)),null!==e&&(this.Yn=JSON.parse(e))}catch(n){console.error("❌ [Wrong Colors] Error loading settings:",n),this.Wn=!1,this.Yn=!1}}Qe(){try{if("undefined"!=typeof GM_setValue)return GM_setValue("bmIncludeWrongColors",JSON.stringify(this.Wn)),void GM_setValue("bmEnhanceWrongColors",JSON.stringify(this.Yn));localStorage.setItem("bmIncludeWrongColors",JSON.stringify(this.Wn)),localStorage.setItem("bmEnhanceWrongColors",JSON.stringify(this.Yn))}catch(n){console.error("❌ [Wrong Colors] Failed to save settings:",n)}}Xe(n,e){const t=this.Ln.get(e);if(!t||!t.he)return!1;const o=t.he[n],a=o&&o.xe>0;if(this.Yn&&a&&!this.et){this.et=this.et||new Set;const t=`${n}-${e}`;this.et.has(t)||this.et.add(t)}return a}ct(n,e){const t=new Set;try{const o=this.Ln.get(n);if(!o||!o.he)return t;const a=Array.from(e.enhancedColors);if(0===a.length)return t;for(const r of a){const a=o.he[r];a&&a.xe>0&&this.dt(n,r,e).forEach(n=>t.add(n))}}catch(n){console.warn("Failed to get wrong pixels for selected colors:",n)}return t}dt(n,e,t){const o=new Set;try{const[a,r,i]=e.split(",").map(Number),s=Object.keys(t.en).filter(e=>e.startsWith(n));for(const n of s){const e=t.en[n],s=n.split(","),l=[s[2],s[3]],c=document.createElement("canvas");c.width=e.width,c.height=e.height;const d=c.getContext("2d");d.imageSmoothingEnabled=!1,d.drawImage(e,0,0);const p=d.getImageData(0,0,e.width,e.height).data;for(let n=0;n<e.height;n++)for(let t=0;t<e.width;t++){if(t%this.Bn!==1||n%this.Bn!==1)continue;const s=4*(n*e.width+t),c=p[s],d=p[s+1],m=p[s+2];if(!(p[s+3]<64)&&c===a&&d===r&&m===i){const e=Number(l[0])*this.Bn+t,a=Number(l[1])*this.Bn+n;o.add(`${e},${a}`)}}}}catch(n){console.warn("Failed to find wrong pixel coordinates:",n)}return o}ut(n,e,t,o,a,r,i,s){const l=this.Cn();for(const c of t){const[t,d]=c.split(",").map(Number),p=Number(r.fe[0])*this.Bn,m=Number(r.fe[1])*this.Bn,u=t-p,b=d-m;if(u<0||u>=o||b<0||b>=a)continue;const g=[[0,-1],[0,1],[-1,0],[1,0]];for(const[t,r]of g){const c=u+t,d=b+r;if(c<0||c>=o||d<0||d>=a)continue;const g=4*(d*o+c);if(0!==e[g+3])continue;const f=c+p,h=d+m;f>=0&&f<i.canvas.width&&h>=0&&h<i.canvas.height&&s[4*(h*i.canvas.width+f)+3]>0||(n[g]=l.rgb[0],n[g+1]=l.rgb[1],n[g+2]=l.rgb[2],n[g+3]=l.alpha)}}}bt(n,e,t,o,a){const r=new Set;try{const[e,i,s]=n.split(",").map(Number),l=document.createElement("canvas");l.width=o.width,l.height=o.height;const c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(o,0,0);const d=c.getImageData(0,0,o.width,o.height).data,p=t.getContext("2d",{cn:!0}).getImageData(a[0],a[1],o.width,o.height).data;let m=0;for(let n=0;n<o.height;n++)for(let t=0;t<o.width;t++){if(t%this.Bn!==1||n%this.Bn!==1)continue;const a=4*(n*o.width+t),l=d[a],c=d[a+1],u=d[a+2];if(!(d[a+3]<64)&&l===e&&c===i&&u===s){const o=p[a],l=p[a+1],c=p[a+2];(p[a+3]<64||o!==e||l!==i||c!==s)&&(r.add(`${t},${n}`),m++)}}}catch(n){console.warn("Failed to detect wrong pixels:",n)}return r}async gt(n,e,t){try{let o=null;if(this.Vn&&1===this.Jn.size){const n=Array.from(this.Jn)[0];o=this.Nn.find(e=>`${e.Z} ${e.nn}`===n)}if(!o&&this.Nn)for(const n of this.Nn){const e=`${n.Z} ${n.nn}`;if(this.ue(e)){o=n;break}}if(o||(o=this.Nn?.[0]),!o||!Array.isArray(e)||e.length<4)throw new Error("Missing template or coordinates");const a=Number(e[0]),r=Number(e[1]),i=Number(e[2]),s=Number(e[3]),l=Number(t?.[0]??o.imageWidth??0),c=Number(t?.[1]??o.imageHeight??0);if(!Number.isFinite(a)||!Number.isFinite(r)||l<=0||c<=0)throw new Error("Invalid screenshot dimensions or coords");const d=this.tn||1e3,p=a*d+i,m=r*d+s,u=p+l,b=m+c,g=Math.floor(p/d),f=Math.floor(m/d),h=Math.floor((u-1)/d),x=Math.floor((b-1)/d),v=u-p,w=b-m,y=new OffscreenCanvas(v,w),k=y.getContext("2d",{cn:!0});k.imageSmoothingEnabled=!1,k.clearRect(0,0,v,w);const $=(e,t)=>new Promise((o,a)=>{try{const r=`${n}/${e}/${t}.png`;if("function"==typeof GM_xmlhttpRequest)GM_xmlhttpRequest({method:"GET",url:r,responseType:"blob",onload:n=>{if(n.status>=200&&n.status<300&&n.response)o(n.response);else{const n=new Image;n.crossOrigin="anonymous",n.onload=async()=>{try{const e=new OffscreenCanvas(n.width,n.height),t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.drawImage(n,0,0);const a=await e.convertToBlob({type:"image/png"});o(a)}catch(n){a(n)}},n.onerror=()=>a(new Error("Tile fetch failed (img)")),n.src=r}},onerror:()=>{const n=new Image;n.crossOrigin="anonymous",n.onload=async()=>{try{const e=new OffscreenCanvas(n.width,n.height),t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.drawImage(n,0,0);const a=await e.convertToBlob({type:"image/png"});o(a)}catch(n){a(n)}},n.onerror=()=>a(new Error("Tile fetch failed (img)")),n.src=r}});else{const n=new Image;n.crossOrigin="anonymous",n.onload=async()=>{try{const e=new OffscreenCanvas(n.width,n.height),t=e.getContext("2d");t.imageSmoothingEnabled=!1,t.drawImage(n,0,0);const a=await e.convertToBlob({type:"image/png"});o(a)}catch(n){a(n)}},n.onerror=()=>a(new Error("Tile fetch failed (img)")),n.src=r}}catch(n){a(n)}});for(let n=f;n<=x;n++)for(let e=g;e<=h;e++){const t=await $(e,n),o=await createImageBitmap(t),a=e*d,r=n*d,i=Math.max(0,p-a),s=Math.max(0,m-r),l=Math.max(0,a-p),c=Math.max(0,r-m),u=Math.min(d-i,v-l),b=Math.min(d-s,w-c);u>0&&b>0&&k.drawImage(o,i,s,u,b,l,c,u,b)}return await y.convertToBlob({type:"image/png"})}catch(n){throw console.warn("Failed to build template area screenshot",n),n}}async ft(n,{ht:e=!0}={}){if(!n?.templates||"object"!=typeof n.templates)return;this.zn||(this.zn=await this.se());const t=Object.keys(this.zn.templates||{}),o=new Set(t.map(n=>parseInt(n.split(" ")[0],10)).filter(n=>Number.isFinite(n))),a=()=>{let n=o.size?Math.max(...Array.from(o))+1:0;for(;o.has(n);)n++;return o.add(n),n},i=n.templates;for(const[n,e]of Object.entries(i)){let t=parseInt(n.split(" ")[0]||"0",10);!Number.isFinite(t)||o.has(t)?t=a():o.add(t);const r=n.split(" ")[1]||"",i=`${t} ${r||""}`.trim();this.zn.templates[i]={name:e.name||`Template ${t}`,coords:e.coords,createdAt:e.createdAt||(new Date).toISOString(),pixelCount:e.pixelCount||0,enabled:!1!==e.enabled,disabledColors:e.disabledColors||[],enhancedColors:e.enhancedColors||[],Wn:e.Wn??this.Wn??!1,Yn:e.Yn??this.Yn??!1,tiles:e.tiles||{}};try{const n=this.zn.templates[i].name,e=this.zn.templates[i].coords?.split(", ").map(Number)||null,o=this.zn.templates[i].tiles,a={};let s=0;for(const[n,e]of Object.entries(o)){const t=g(e),o=new Blob([t],{type:"image/png"}),r=await createImageBitmap(o);a[n]=r;try{const n=document.createElement("canvas");n.width=r.width,n.height=r.height;const e=n.getContext("2d");e.imageSmoothingEnabled=!1,e.drawImage(r,0,0);const t=e.getImageData(0,0,n.width,n.height).data;for(let e=0;e<n.height;e++)for(let o=0;o<n.width;o++)o%this.Bn===1&&e%this.Bn===1&&t[4*(e*n.width+o)+3]>0&&s++}catch(e){console.warn("Failed to count pixels for tile during import:",n,e)}}const l=new T({displayName:n,Z:t,nn:r,coords:e});l.en=a,l.pixelCount=s,this.zn.templates[i].pixelCount||(this.zn.templates[i].pixelCount=s),Array.isArray(this.zn.templates[i].disabledColors)&&l.fn(this.zn.templates[i].disabledColors),Array.isArray(this.zn.templates[i].enhancedColors)&&l.kn(this.zn.templates[i].enhancedColors);const c=this.Nn.findIndex(n=>`${n.Z} ${n.nn}`===i);-1!==c?this.Nn[c]=l:this.Nn.push(l)}catch(n){console.warn("Failed to create Template instance during import merge:",n)}}this.zn.lastModified=(new Date).toISOString(),this.zn.templateCount=Object.keys(this.zn.templates).length,this.zn.totalPixels=this.Nn.reduce((n,e)=>n+(e.pixelCount||0),0),await r(this,N,O).call(this);try{const e=Object.entries(n.templates||{}),t=e.length;let o=`Imported ${t} template${1!==t?"s":""}`;if(t>0){const n=e[0][1];o+=`\n• First: ${n?.name||"Unnamed"}\n• Coords: ${n?.coords||"N/A"}\n• Pixels: ${n?.pixelCount??"N/A"}`,t>1&&(o+=`\n• Others: ${t-1} more`)}this.T?.K?.(o)}catch(n){this.T?.K?.("Templates imported!")}}xt(n){return this.zn?.templates?.[n]?{whoami:"BlueMarble",scriptVersion:this.version,schemaVersion:this.Dn,createdAt:(new Date).toISOString(),lastModified:(new Date).toISOString(),templateCount:1,totalPixels:this.zn.templates[n]?.pixelCount||0,templates:{[n]:this.zn.templates[n]}}:null}vt(n){const e=this.xt(n);if(!e)return;const t=(e.templates[n]?.name||"template").replace(/[\\/:*?"<>|]/g,"_"),o=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=`${t}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}wt(){return this.zn?.templates?{whoami:"BlueMarble",scriptVersion:this.version,schemaVersion:this.Dn,createdAt:this.zn.createdAt||(new Date).toISOString(),lastModified:(new Date).toISOString(),templateCount:Object.keys(this.zn.templates).length,totalPixels:this.Nn.reduce((n,e)=>n+(e.pixelCount||0),0),templates:this.zn.templates}:null}yt(){const n=this.wt();if(!n)return;const e=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download="BlueMarble-templates.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t)}}(F,B,P));R.st(Z());var U,H=new class{constructor(n){this.kt=n,this.$t=!1,this.Mt=[],this.St=[],this.Ct=null}Tt(n){window.addEventListener("message",async e=>{const t=e.data,o=t.jsonData;if(!t||"blue-marble"!==t.source)return;if(!t.endpoint)return;const a=t.endpoint?.split("?")[0].split("/").filter(n=>n&&isNaN(Number(n))).filter(n=>n&&!n.includes(".")).pop();switch(a){case"me":if(o.status&&"2"!=o.status?.toString()[0])return void n.X("You are not logged in!\nCould not fetch userdata.");const e=Math.ceil(Math.pow(Math.floor(o.level)*Math.pow(30,.65),1/.65)-o.pixelsPainted);if((o.id||0===o.id)&&console.log(u(o.id,"!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~")),this.kt.jn=o.id,this.zt={charges:o.charges||0,maxCharges:o.maxCharges||1,nextChargeTime:o.nextChargeTime||null,cooldownMs:o.cooldownMs||null,canPaint:o.canPaint||!1,Nt:null},this.zt.nextChargeTime){const n=new Date(this.zt.nextChargeTime).getTime(),e=Date.now();this.zt.Nt=Math.max(0,n-e)}n.U("bm-j",`<b>Username:</b> ${s(o.name)}`);try{const n=JSON.parse(localStorage.getItem("bmShowUsername")??"true"),e=document.getElementById("bm-F");e&&(e.style.display=n?"":"none")}catch(n){}n.U("bm-9",`<b>Droplets:</b> ${(new Intl.NumberFormat).format(o.droplets)}`),n.U("bm-4",`Next level in <b>${(new Intl.NumberFormat).format(e)}</b> pixel${1==e?"":"s"}`),this.Ot(n,o);break;case"pixel":const a=t.endpoint.split("?")[0].split("/").filter(n=>n&&!isNaN(Number(n))),r=new URLSearchParams(t.endpoint.split("?")[1]),i=[r.get("x"),r.get("y")];if(this.Mt.length&&(!a.length||!i.length))return void n.X("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Mt=[...a,...i];const c=l(a,i),d=document.querySelectorAll("span");for(const n of d)if(n.textContent.trim().includes(`${c[0]}, ${c[1]}`)){let e=document.querySelector("#bm-n");const t=`(Tl X: ${a[0]}, Tl Y: ${a[1]}, Px X: ${i[0]}, Px Y: ${i[1]})`;e?e.textContent=t:(e=document.createElement("span"),e.id="bm-n",e.textContent=t,e.style="margin-left: calc(var(--spacing)*3); font-size: small;",n.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",e))}break;case"tiles":let p=t.endpoint.split("/");p=[parseInt(p[p.length-2]),parseInt(p[p.length-1].replace(".png",""))];try{const n=(t.endpoint||"").split("?")[0].split("/"),e=n.lastIndexOf("tiles");if(e>0){const t=n.slice(0,e+1).join("/");this.Ct=t}}catch(n){}const m=t.blobID,b=t.blobData,g=await this.kt.Tn(b,p);window.postMessage({source:"blue-marble",blobID:m,blobData:g,blink:t.blink});break;case"robots":this.$t="false"==o.userscript?.toString().toLowerCase();break}})}Ot(n,e){if(e.charges){const t=e.charges,o=t.count||0,a=t.max||1,r=t.cooldownMs||3e4,i=(a-o)*r;window.skirkChargeData={It:o,max:a,cooldownMs:r,_t:i,startTime:Date.now()},this.Gt(n),window.skirkChargeInterval&&clearInterval(window.skirkChargeInterval),window.skirkChargeInterval=setInterval(()=>{this.Gt(n)},1e4)}else n.U("bm-X",'Full Charge in <b style="color: #6b7280;">N/A</b>')}Gt(n){if(!window.skirkChargeData)return;const e=window.skirkChargeData,t=Date.now()-e.startTime,o=Math.max(0,e._t-t);if(e.It>=e.max||o<=0)return n.U("bm-X",'Full Charge in <b style="color: #10b981;">FULL</b>'),void(window.skirkChargeInterval&&(clearInterval(window.skirkChargeInterval),window.skirkChargeInterval=null));const a=Math.ceil(o/1e3),r=Math.floor(a/3600),i=Math.floor(a%3600/60),s=a%60;let l="";l=r>0?`${r}h ${i}m ${s}s`:i>0?`${i}m ${s}s`:`${s}s`;const c=Math.floor(t/e.cooldownMs),d=Math.min(e.It+c,e.max),p=`${Math.floor(d)}/${e.max}`;n.U("bm-X",`Full Charge in <b style="color: #f59e0b;">${l}</b> <span style="color: #6b7280; font-size: 0.9em;">(${p})</span>`)}}(R);async function W(n){try{if("tm"===n){if("undefined"!=typeof GM&&GM.deleteValue){try{await GM.deleteValue("bmTemplates")}catch(n){}try{await GM.deleteValue("bmTemplates_timestamp")}catch(n){}const n=await GM.getValue("bmTemplates_chunkCount",0);for(let e=0;e<n;e++)try{await GM.deleteValue(`bmTemplates_part_${e}`)}catch(n){}try{await GM.deleteValue("bmTemplates_chunkCount")}catch(n){}}}else if("ls"===n){try{localStorage.removeItem("bmTemplates")}catch(n){}try{localStorage.removeItem("bmTemplates_timestamp")}catch(n){}const n=parseInt(localStorage.getItem("bmTemplates_chunkCount")||"0");for(let e=0;e<n;e++)try{localStorage.removeItem(`bmTemplates_part_${e}`)}catch(n){}try{localStorage.removeItem("bmTemplates_chunkCount")}catch(n){}}}catch(e){console.error(`❌ Failed to cleanup ${n.toUpperCase()} storage:`,e)}}async function Y(n,e,t){const o=9e5,a=Math.ceil(e.length/o);if("tm"===n){if("undefined"!=typeof GM&&GM.setValue){try{await GM.deleteValue("bmTemplates")}catch(n){}await GM.setValue("bmTemplates_chunkCount",a);for(let n=0;n<a;n++){const t=e.slice(n*o,(n+1)*o);await GM.setValue(`bmTemplates_part_${n}`,t)}await GM.setValue("bmTemplates_timestamp",t)}}else if("ls"===n){try{localStorage.removeItem("bmTemplates")}catch(n){}localStorage.setItem("bmTemplates_chunkCount",String(a));for(let n=0;n<a;n++){const t=e.slice(n*o,(n+1)*o);localStorage.setItem(`bmTemplates_part_${n}`,t)}localStorage.setItem("bmTemplates_timestamp",t.toString())}}if(P.I(H),R.qn(),R.Ie(function(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmSmartDetectionEnabled",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmSmartDetectionEnabled");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load smart detection setting:",n)}return!0}()),async function(){try{let n=null,e=null,t=0,o=0,a=!1,r=!1;try{if("undefined"!=typeof GM&&GM.getValue){const e=await GM.getValue("bmTemplates_chunkCount",0);if(e>0){let t="",o=0;for(let n=0;n<e;n++){const e=await GM.getValue(`bmTemplates_part_${n}`,"");e?t+=e:o++}o>0?(console.error(`❌ TM data corruption: ${o}/${e} chunks missing`),n=null):(n=t,a=!0)}else n=await GM.getValue("bmTemplates",null);t=await GM.getValue("bmTemplates_timestamp",0)}else if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmTemplates_chunkCount",0);if(e>0){let t="",o=0;for(let n=0;n<e;n++){const a=GM_getValue(`bmTemplates_part_${n}`,"");a?t+=a:(o++,console.warn(`⚠️ Missing TM legacy chunk ${n}/${e}`))}o>0?(console.error(`❌ TM legacy data corruption: ${o}/${e} chunks missing`),n=null):(n=t,a=!0)}else n=GM_getValue("bmTemplates",null);t=GM_getValue("bmTemplates_timestamp",0)}}catch(e){console.error("❌ TM check failed:",e),n=null}try{const n=parseInt(localStorage.getItem("bmTemplates_chunkCount")||"0");if(n>0){let t="",o=0;for(let e=0;e<n;e++){const a=localStorage.getItem(`bmTemplates_part_${e}`)||"";a?t+=a:(o++,console.warn(`⚠️ Missing LS chunk ${e}/${n}`))}o>0?(console.error(`❌ LS data corruption: ${o}/${n} chunks missing`),e=null):(e=t,r=!0)}else e=localStorage.getItem("bmTemplates");o=parseInt(localStorage.getItem("bmTemplates_timestamp")||"0")}catch(n){console.error("❌ LS check failed:",n),e=null}let i=!1,s=!1;if(n)try{const e=JSON.parse(n);e&&"object"==typeof e&&e.templates?i=!0:console.warn("⚠️ TM data is not a valid template structure")}catch(e){console.error("❌ TM data is not valid JSON:",e),n=null}if(e)try{const n=JSON.parse(e);n&&"object"==typeof n&&n.templates?s=!0:console.warn("⚠️ LS data is not a valid template structure")}catch(n){console.error("❌ LS data is not valid JSON:",n),e=null}if(!i&&n&&(console.warn("🧹 Cleaning up corrupted TM data..."),await W("tm"),n=null,t=0),!s&&e&&(console.warn("🧹 Cleaning up corrupted LS data..."),await W("ls"),e=null,o=0),i&&s&&t!==o)if(t>o)try{if(n.length>9e5)await Y("ls",n,t);else{localStorage.setItem("bmTemplates",n),localStorage.setItem("bmTemplates_timestamp",t.toString());const e=parseInt(localStorage.getItem("bmTemplates_chunkCount")||"0");for(let n=0;n<e;n++)localStorage.removeItem(`bmTemplates_part_${n}`);localStorage.removeItem("bmTemplates_chunkCount")}}catch(n){console.error("❌ Failed to sync TM → LS:",n)}else if(o>t)try{if("undefined"!=typeof GM&&GM.setValue)if(e.length>9e5)await Y("tm",e,o);else{await GM.setValue("bmTemplates",e),await GM.setValue("bmTemplates_timestamp",o);const n=await GM.getValue("bmTemplates_chunkCount",0);for(let e=0;e<n;e++)try{await GM.deleteValue(`bmTemplates_part_${e}`)}catch(n){}try{await GM.deleteValue("bmTemplates_chunkCount")}catch(n){}}else"undefined"!=typeof GM_setValue&&(GM_setValue("bmTemplates",e),GM_setValue("bmTemplates_timestamp",o))}catch(n){console.error("❌ Failed to sync LS → TM:",n)}}catch(n){console.error("❌ Storage migration failed:",n)}}().then(()=>async function(){let n={},e="none";try{if("undefined"!=typeof GM&&GM.getValue){const t=await GM.getValue("bmTemplates_chunkCount",0);let o;if(t>0){let n="",e=0;for(let o=0;o<t;o++){const t=await GM.getValue(`bmTemplates_part_${o}`,"");t?n+=t:e++}if(e>0)throw new Error(`TM data corrupted: ${e}/${t} chunks missing`);o=n}else o=await GM.getValue("bmTemplates","{}");if(o&&"{}"!==o&&""!==o)try{if(n=JSON.parse(o),!n||"object"!=typeof n)throw new Error("Invalid template structure");n.templates||(n.templates={}),e="TamperMonkey (async)"}catch(n){throw n}else n={},e="TamperMonkey (empty)"}else if("undefined"!=typeof GM_getValue){const t=GM_getValue("bmTemplates_chunkCount",0);let o;if(t>0){let n="",e=0;for(let o=0;o<t;o++){const t=GM_getValue(`bmTemplates_part_${o}`,"");t?n+=t:e++}if(e>0)throw new Error(`TM legacy data corrupted: ${e}/${t} chunks missing`);o=n}else o=GM_getValue("bmTemplates","{}");if(o&&"{}"!==o&&""!==o)try{if(n=JSON.parse(o),!n||"object"!=typeof n)throw new Error("Invalid template structure");n.templates||(n.templates={}),e="TamperMonkey (legacy)"}catch(n){throw n}else n={},e="TamperMonkey (legacy, empty)"}}catch(t){try{const t=parseInt(localStorage.getItem("bmTemplates_chunkCount")||"0");let o;if(t>0){let n="",e=0;for(let o=0;o<t;o++){const t=localStorage.getItem(`bmTemplates_part_${o}`)||"";t?n+=t:e++}if(e>0)throw new Error(`LS data corrupted: ${e}/${t} chunks missing`);o=n}else o=localStorage.getItem("bmTemplates")||"{}";if(o&&"{}"!==o&&""!==o)try{if(n=JSON.parse(o),!n||"object"!=typeof n)throw new Error("Invalid template structure");n.templates||(n.templates={}),e="localStorage (fallback)"}catch(n){throw n}else n={},e="localStorage (empty)"}catch(t){try{await async function(){try{if("undefined"!=typeof GM&&GM.deleteValue){const n=["bmTemplates","bmTemplates_timestamp","bmTemplates_chunkCount"];for(const e of n)try{await GM.deleteValue(e)}catch(n){}for(let n=0;n<50;n++)try{await GM.deleteValue(`bmTemplates_part_${n}`)}catch(n){}}const n=["bmTemplates","bmTemplates_timestamp","bmTemplates_chunkCount"];for(const e of n)try{localStorage.removeItem(e)}catch(n){}for(let n=0;n<50;n++)try{localStorage.removeItem(`bmTemplates_part_${n}`)}catch(n){}}catch(n){throw console.error("❌ Emergency cleanup failed:",n),n}}(),n={},e="emergency recovery (empty)"}catch(t){n={},e="empty (all failed)"}}}if(0===Object.keys(n?.templates||{}).length&&"empty (all failed)"!==e)try{let t={};if(e.includes("TamperMonkey")){const n=localStorage.getItem("bmTemplates");n&&(t=JSON.parse(n))}else{let n=null;"undefined"!=typeof GM_getValue&&(n=GM_getValue("bmTemplates",null)),n&&(t=JSON.parse(n))}Object.keys(t?.templates||{}).length>0&&(n=t,R.De().catch(n=>console.warn("Template color filter update failed:",n)))}catch(n){}try{R.Se(n)}catch(n){try{const n={whoami:"BlueMarble",scriptVersion:"0.89.6",schemaVersion:"2.1.0",templates:{},lastModified:(new Date).toISOString(),templateCount:0,totalPixels:0};R.Se(n)}catch(n){throw n}}}()).catch(n=>console.error("Template loading failed:",n)),function(){let n=!1;P.D({id:"bm-M",style:"top: 10px; right: 75px;"}).D({id:"bm-o"}).D({id:"bm-H"})._().D({id:"bm-m"}).B({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer; width: 42px; height: 42px;"},(e,t)=>{t.addEventListener("click",()=>{n=!n;const o=document.querySelector("#bm-M"),a=document.querySelector("#bm-o"),r=document.querySelector("#bm-H"),i=document.querySelector("#bm-p"),s=document.querySelector("#bm-w"),l=document.querySelector("#bm-x"),c=document.querySelector("#bm-1A"),d=document.querySelector("#bm-19"),p=document.querySelectorAll("#bm-p input"),m=document.getElementById("bm-d");if(n||(o.style.width="",o.style.height="",o.style.maxWidth="",o.style.minWidth="",o.style.padding="10px"),["#bm-M h1","#bm-l","#bm-M #bm-E","#bm-h > *:not(#bm-p)","div:has(> #bm-e)","#bm-7",`#${e.C}`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.display=n?"none":""})}),n){if(i&&(i.style.display="none"),s&&(s.style.display="none"),l&&(l.style.display="none"),c&&(c.style.display="none"),d&&(d.style.display="none"),m){let n=m.parentElement;for(let e=0;e<3&&n;e++)n.style.display="",n=n.parentElement;const e=m.parentElement;e&&(e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.gap="0",e.style.position="relative",e.style.height="44px",e.style.gridTemplateColumns="unset"),m.dataset.Et||(m.dataset.Et=m.innerHTML);const t=m.querySelector("svg");t&&(m.innerHTML=t.outerHTML),m.style.width="56px",m.style.height="38px",m.style.padding="0",m.style.gap="0",m.style.fontSize="0",m.style.overflow="hidden",m.style.borderRadius="8px",m.style.animation="none",m.style.gridColumn="auto",m.style.margin="2px auto 0",m.style.display="flex",m.style.alignItems="center",m.style.justifyContent="center",m.style.alignSelf="center",m.style.position="absolute",m.style.left="50%",m.style.transform="translateX(-50%)",m.style.zIndex="1000";const o=m.querySelector("svg");o&&(o.style.width="18px",o.style.height="18px",o.style.display="block",o.style.margin="0 auto")}p.forEach(n=>{n.style.display="none"}),o.style.width="72px",o.style.height="76px",o.style.maxWidth="72px",o.style.minWidth="72px",o.style.padding="6px",t.style.margin="0.3rem 0 0 0",a.style.textAlign="center",a.style.margin="0",a.style.marginBottom="0",r&&(r.style.display="",r.style.marginBottom="0.1em")}else{if(i&&(i.style.display="",i.style.flexDirection="",i.style.justifyContent="",i.style.alignItems="",i.style.gap="",i.style.textAlign="",i.style.margin=""),s&&(s.style.display=""),l&&(l.style.display="",l.style.marginTop=""),c&&(c.style.display="",c.style.marginTop=""),d&&(d.style.display="",d.style.marginTop=""),m){m.dataset.Et&&(m.innerHTML=m.dataset.Et),m.style.width="",m.style.height="",m.style.padding="",m.style.gap="",m.style.fontSize="",m.style.overflow="",m.style.borderRadius="",m.style.animation="",m.style.transform="",m.style.gridColumn="",m.style.margin="",m.style.display="",m.style.alignItems="",m.style.justifyContent="",m.style.position="",m.style.left="",m.style.zIndex="";const n=m.parentElement;n&&(n.style.display="",n.style.justifyContent="",n.style.alignItems="",n.style.gap="",n.style.position="",n.style.height="",n.style.gridTemplateColumns="")}p.forEach(n=>{n.style.display=""}),t.style.margin="",o.style.padding="10px",a.style.textAlign="",a.style.margin="",a.style.marginBottom="",r&&(r.style.marginBottom=""),o.style.maxWidth="",o.style.minWidth=""}un(),t.alt=n?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})})._().L(1,{textContent:"Skirk Marble"})._()._().D({id:"bm-E"}).J()._().D({id:"bm-r"}).D({innerHTML:'<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12.2V9M9 5.8H9.008M17 9C17 13.4183 13.4183 17 9 17C4.58172 17 1 13.4183 1 9C1 4.58172 4.58172 1 9 1C13.4183 1 17 4.58172 17 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'})._().j({textContent:"Information"})._()._().J()._()._().D({id:"bm-l"}).D({id:"bm-F"}).D({id:"bm-G",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'})._().j({id:"bm-j",innerHTML:"<b>Username:</b> loading..."})._()._().D({id:"bm-z"}).D({id:"bm-i",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-droplet"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>'})._().j({id:"bm-9",innerHTML:"<b>Droplets:</b> loading..."})._()._().D({id:"bm-s"}).D({id:"bm-f",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-award"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>'})._().j({id:"bm-4",textContent:"Next level in..."})._()._().D({id:"bm-1o"}).D({id:"bm-15",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>'})._().j({id:"bm-X",textContent:"Full Charge in..."})._()._()._().D({id:"bm-E"}).J()._().D({id:"bm-r"}).D({innerHTML:'<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.07225 1.125H3.40559C2.93409 1.125 2.4819 1.3123 2.14851 1.6457C1.81511 1.9791 1.62781 2.43128 1.62781 2.90278V5.56944M17.6278 5.56944V2.90278C17.6278 2.43128 17.4405 1.9791 17.1071 1.6457C16.7737 1.3123 16.3215 1.125 15.85 1.125H13.1834M13.1834 17.125H15.85C16.3215 17.125 16.7737 16.9377 17.1071 16.6043C17.4405 16.2709 17.6278 15.8187 17.6278 15.3472V12.6806M1.62781 12.6806V15.3472C1.62781 15.8187 1.81511 16.2709 2.14851 16.6043C2.4819 16.9377 2.93409 17.125 3.40559 17.125H6.07225" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'})._().j({textContent:"Template"})._()._().J()._()._().D({id:"bm-h"}).D({id:"bm-p"}).D({id:"bm-B"}).D({innerHTML:k})._().j({innerHTML:"Coordinates:"})._().P({id:"bm-w",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mouse-pointer"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg>Detect',title:"Set the location to the pixel you've selected"},(n,e)=>{e.onclick=()=>{const e=n.S?.Mt;e?.[0]?(n.U("bm-I",e?.[0]||""),n.U("bm-J",e?.[1]||""),n.U("bm-K",e?.[2]||""),n.U("bm-L",e?.[3]||"")):n.X("Coordinates are malformed! Did you try clicking on the canvas first?")}})._()._().D({id:"bm-t"}).j({textContent:"Tile: "})._().H({type:"number",id:"bm-I",placeholder:"T1 X",min:0,max:2047,step:1,required:!0})._().H({type:"number",id:"bm-J",placeholder:"T1 Y",min:0,max:2047,step:1,required:!0})._().H({type:"number",id:"bm-K",placeholder:"Px X",min:0,max:2047,step:1,required:!0})._().H({type:"number",id:"bm-L",placeholder:"Px Y",min:0,max:2047,step:1,required:!0})._()._()._().D({id:"bm-1"}).W({id:"bm-e",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).P({id:"bm-x",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Create'},(n,e)=>{e.onclick=()=>{const e=document.querySelector("#bm-e"),t=document.querySelector("#bm-I");if(!t.checkValidity())return t.reportValidity(),void n.X("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-J");if(!o.checkValidity())return o.reportValidity(),void n.X("Coordinates are malformed! Did you try clicking on the canvas first?");const a=document.querySelector("#bm-K");if(!a.checkValidity())return a.reportValidity(),void n.X("Coordinates are malformed! Did you try clicking on the canvas first?");const r=document.querySelector("#bm-L");if(!r.checkValidity())return r.reportValidity(),void n.X("Coordinates are malformed! Did you try clicking on the canvas first?");e?.files[0]?(R.ce(e.files[0],e.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(t.value),Number(o.value),Number(a.value),Number(r.value)]),setTimeout(()=>un(),500),n.K("Drew to canvas!")):n.X("No file selected!")}})._().P({id:"bm-1A",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>Manage'},(n,e)=>{e.onclick=()=>{!function(n){const e=R?.zn?.templates||{},t=Object.keys(e),o=document.createElement("div");o.id="bm-Y",o.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.8);\n    backdrop-filter: blur(8px);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    z-index: 10000;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  ";const a=document.createElement("div");if(a.style.cssText="\n    background: #1e293b;\n    color: #f1f5f9;\n    border-radius: 20px;\n    border: 1px solid #334155;\n    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(16px);\n    max-width: 500px;\n    width: 90%;\n    max-height: 85vh;\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    position: relative;\n  ",!document.getElementById("bm-16")){const n=document.createElement("style");n.id="bm-16",n.textContent='\n      /* Template manager mobile styles */\n      @media screen and (max-width: 500px) {\n        /* Make ONLY template items stack vertically - not header */\n        #bm-Y div[style*="justify-content: space-between"][style*="padding: 16px"] {\n          flex-direction: column !important;\n          align-items: stretch !important;\n          gap: 12px !important;\n        }\n        \n        /* Template info section takes full width at top */\n        #bm-Y div[style*="flex: 1"][style*="min-width: 0"][style*="margin-right: 16px"] {\n          margin-bottom: 0 !important;\n          margin-right: 0 !important;\n          width: 100% !important;\n        }\n        \n        /* Button container - 4x1 grid layout (linha horizontal) */\n        #bm-Y .templateInfoControls {\n          max-width: 100% !important;\n          display: grid !important;\n          grid-template-columns: repeat(4, 1fr) !important;\n          gap: 6px !important;\n          justify-items: stretch !important;\n          margin-top: 8px !important;\n        }\n        \n        /* Buttons - touch-friendly em linha horizontal */\n        #bm-Y .templateInfoControls button {\n          width: 100% !important;\n          min-width: unset !important;\n          height: 40px !important;\n          padding: 6px 4px !important;\n          font-size: 12px !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n        }\n        \n        /* Toggle button com fonte menor para caber */\n        #bm-Y .templateInfoControls button[style*="min-width: 80px"] {\n          font-size: 11px !important;\n          padding: 6px 2px !important;\n        }\n      }\n      \n      /* Small screens (380px) - começar compactação gradual */\n      @media screen and (max-width: 380px) {\n        /* Template item com padding reduzido gradualmente */\n        #bm-Y div[style*="justify-content: space-between"][style*="padding: 16px"] {\n          padding: 14px !important;\n          gap: 10px !important;\n        }\n        \n        /* Template info mais compacta */\n        #bm-Y div[style*="flex: 1"][style*="min-width: 0"][style*="margin-right: 16px"] {\n          line-height: 1.3 !important;\n        }\n        \n        /* Nome do template */\n        #bm-Y div[style*="display:flex"][style*="align-items:center"][style*="gap:8px"] {\n          margin-bottom: 5px !important;\n        }\n        \n        /* Informações de pixels */\n        #bm-Y div[style*="font-size: 0.85em"][style*="color: #94a3b8"] {\n          font-size: 0.82em !important;\n          margin-bottom: 3px !important;\n        }\n        \n        /* Coordenadas */\n        #bm-Y div[style*="font-size: 0.75em"][style*="color: #60a5fa"] {\n          font-size: 0.72em !important;\n          margin-top: 2px !important;\n        }\n        \n        /* Botões */\n        #bm-Y .templateInfoControls {\n          margin-top: 7px !important;\n          gap: 4px !important;\n        }\n        \n        #bm-Y .templateInfoControls button {\n          height: 42px !important;\n          font-size: 11px !important;\n          padding: 4px 2px !important;\n        }\n        \n        #bm-Y .templateInfoControls button[style*="min-width: 80px"] {\n          font-size: 10px !important;\n          padding: 4px 1px !important;\n        }\n      }\n      \n      /* Very small screens (360px) - mais compacto */\n      @media screen and (max-width: 360px) {\n        #bm-Y div[style*="justify-content: space-between"][style*="padding: 16px"] {\n          padding: 13px !important;\n          gap: 9px !important;\n        }\n        \n        #bm-Y div[style*="flex: 1"][style*="min-width: 0"][style*="margin-right: 16px"] {\n          line-height: 1.25 !important;\n        }\n        \n        #bm-Y div[style*="display:flex"][style*="align-items:center"][style*="gap:8px"] {\n          margin-bottom: 4px !important;\n        }\n        \n        #bm-Y div[style*="font-size: 0.85em"][style*="color: #94a3b8"] {\n          font-size: 0.81em !important;\n          margin-bottom: 2px !important;\n        }\n        \n        #bm-Y div[style*="font-size: 0.75em"][style*="color: #60a5fa"] {\n          font-size: 0.71em !important;\n        }\n        \n        #bm-Y .templateInfoControls button {\n          height: 40px !important;\n          font-size: 10px !important;\n        }\n        \n        #bm-Y .templateInfoControls button[style*="min-width: 80px"] {\n          font-size: 9px !important;\n        }\n      }\n      \n      /* Ultra small screens (320px) - máximo compacto */\n      @media screen and (max-width: 320px) {\n        #bm-Y div[style*="justify-content: space-between"][style*="padding: 16px"] {\n          padding: 12px !important;\n          gap: 8px !important;\n        }\n        \n        #bm-Y div[style*="flex: 1"][style*="min-width: 0"][style*="margin-right: 16px"] {\n          line-height: 1.2 !important;\n        }\n        \n        #bm-Y div[style*="display:flex"][style*="align-items:center"][style*="gap:8px"] {\n          margin-bottom: 3px !important;\n        }\n        \n        #bm-Y div[style*="font-size: 0.85em"][style*="color: #94a3b8"] {\n          font-size: 0.8em !important;\n          margin-bottom: 2px !important;\n        }\n        \n        #bm-Y div[style*="font-size: 0.75em"][style*="color: #60a5fa"] {\n          font-size: 0.7em !important;\n          margin-top: 1px !important;\n        }\n        \n        #bm-Y .templateInfoControls {\n          margin-top: 6px !important;\n          gap: 3px !important;\n        }\n        \n        #bm-Y .templateInfoControls button {\n          height: 38px !important;\n          font-size: 10px !important;\n          padding: 3px 1px !important;\n        }\n        \n        #bm-Y .templateInfoControls button[style*="min-width: 80px"] {\n          font-size: 9px !important;\n        }\n      }\n      \n      /* Extra small screens (330px) - reduzir título para não quebrar */\n      @media screen and (max-width: 330px) {\n        #bm-Y h3 {\n          font-size: 1.3em !important;\n          line-height: 1.2 !important;\n        }\n      }\n    ',document.head.appendChild(n)}const r=document.createElement("div");r.style.cssText="\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 20px 24px 16px 24px;\n    border-bottom: 1px solid #334155;\n    background: linear-gradient(135deg, #1e293b, #293548);\n  ";const i=document.createElement("h3");i.textContent="Manage Templates",i.style.cssText="\n    margin: 0;\n    font-size: 1.5em;\n    font-weight: 700;\n    background: linear-gradient(135deg, #f1f5f9, #cbd5e1);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n  ";const s=document.createElement("button");s.textContent="×",s.style.cssText="\n    background: none;\n    border: none;\n    color: #94a3b8;\n    font-size: 24px;\n    cursor: pointer;\n    padding: 0;\n    width: 30px;\n    height: 30px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 6px;\n    transition: all 0.2s ease;\n  ",s.onmouseover=()=>{s.style.background="rgba(239, 68, 68, 0.1)",s.style.color="#ef4444"},s.onmouseout=()=>{s.style.background="none",s.style.color="#94a3b8"},s.onclick=()=>document.body.removeChild(o),r.appendChild(i),r.appendChild(s);const l=document.createElement("div");l.style.cssText="\n    padding: 20px 24px;\n    overflow-y: auto;\n    flex: 1;\n  ";const c=document.createElement("div");c.style.cssText="\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n  ",t.forEach(t=>{const a=e[t],r=a.name||`Template ${t}`,i=a.coords||"Unknown location",s=a.pixelCount||0,l=R.ue(t),d=document.createElement("div");d.style.cssText="\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 16px;\n      background: #334155;\n      border-radius: 12px;\n      border: 1px solid #475569;\n      transition: all 0.2s ease;\n    ",d.onmouseover=()=>{d.style.background="#3f4b5f",d.style.transform="translateY(-1px)"},d.onmouseout=()=>{d.style.background="#334155",d.style.transform=""};const m=document.createElement("div");m.style.cssText="\n      flex: 1;\n      min-width: 0;\n      margin-right: 16px;\n    ";const u=document.createElement("div");u.style.cssText="display:flex; align-items:center; gap:8px; margin-bottom:6px;";const b=document.createElement("button");b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7 21l-4 1 1-4L17 3z"></path></svg>',b.title="Rename template",b.style.cssText="\n      padding: 6px; border: 1px solid #475569; border-radius: 8px; cursor: pointer;\n      background: #1f2937; color: #e2e8f0; min-width: 32px; height: 32px; display:flex; align-items:center; justify-content:center;";const g=document.createElement("div");g.textContent=r,g.style.cssText="\n      font-weight: 600;\n      font-size: 1em;\n      color: #f1f5f9;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n      flex: 1;\n      padding: 4px 6px;\n      border-radius: 6px;\n    ";const h=()=>{const e=document.createElement("input");e.type="text",e.value=g.textContent||"",e.style.cssText="\n        width: 100%; font-weight: 600; font-size: 1em; color: #f1f5f9;\n        border: 1px solid #475569; background: #1f2937; border-radius: 6px; padding: 6px 10px; outline: none;";const o=async o=>{const a=e.value.trim();u.replaceChild(g,e),o&&a&&a!==g.textContent&&(await R.Oe(t,a)?(g.textContent=a,n.K(`Renamed to "${a}"`)):n.X("Failed to rename template"))};e.addEventListener("keydown",n=>{"Enter"===n.key?o(!0):"Escape"===n.key&&o(!1),n.stopPropagation()}),e.addEventListener("blur",()=>o(!0)),u.replaceChild(e,g),setTimeout(()=>{e.focus(),e.select()},0)};b.onclick=n=>{n.stopPropagation(),h()},g.onclick=n=>{n.stopPropagation(),h()},u.appendChild(b),u.appendChild(g);const x=document.createElement("div"),v=a.validPixelCount||s,w=a.transparentPixelCount||0;x.textContent=v!==s&&w>0?`${(new Intl.NumberFormat).format(s)} pixels (${(new Intl.NumberFormat).format(v)} valid)`:`${(new Intl.NumberFormat).format(s)} pixels`,x.style.cssText="\n      font-size: 0.85em;\n      color: #94a3b8;\n      margin-bottom: 4px;\n    ";const y=document.createElement("div");if(i&&"Unknown location"!==i){const n=i.split(", ");if(4===n.length){const[e,t,o,a]=n;y.textContent=`📍 Tile ${e},${t} • Pixel ${o},${a}`}else y.textContent=`📍 ${i}`}else y.textContent="📍 Unknown location";y.style.cssText="\n      font-size: 0.75em;\n      color: #60a5fa;\n      font-weight: 500;\n    ",m.appendChild(u),m.appendChild(x),m.appendChild(y);const $=document.createElement("div");$.classList.add("templateInfoControls"),$.style.cssText="\n      display: flex;\n      gap: 8px;\n      align-items: center;\n    ";const M=document.createElement("button");M.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',M.title="Export this template as JSON",M.style.cssText="\n      padding: 8px;\n      border: none;\n      border-radius: 8px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 36px;\n      height: 36px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: linear-gradient(135deg, #22c55e, #16a34a);\n      color: white;\n    ",M.onmouseover=()=>{M.style.background="linear-gradient(135deg, #16a34a, #15803d)",M.style.transform="translateY(-1px)"},M.onmouseout=()=>{M.style.background="linear-gradient(135deg, #22c55e, #16a34a)",M.style.transform=""},M.onclick=()=>{R.vt(t),n.K(`Exported "${r}"`)};const S=document.createElement("button");S.textContent=l?"Enabled":"Disabled",S.style.cssText=`\n      padding: 8px 16px;\n      border: none;\n      border-radius: 8px;\n      cursor: pointer;\n      font-size: 0.85em;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      min-width: 80px;\n      ${l?"background: linear-gradient(135deg, #10b981, #059669); color: white;":"background: linear-gradient(135deg, #64748b, #475569); color: #e2e8f0;"}\n    `,S.onclick=()=>{const e=!R.ue(t);R.Ne(t,e),S.textContent=e?"Enabled":"Disabled",S.style.background=e?"linear-gradient(135deg, #10b981, #059669)":"linear-gradient(135deg, #64748b, #475569)",S.style.color=e?"white":"#e2e8f0",n.K(`${e?"Enabled":"Disabled"} template "${r}"!`)};const C=document.createElement("button");C.innerHTML=k,C.title="Fly to template coordinates",C.style.cssText="\n      padding: 8px;\n      border: none;\n      border-radius: 8px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 36px;\n      height: 36px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: linear-gradient(135deg, #3b82f6, #2563eb);\n      color: white;\n    ",C.onmouseover=()=>{C.style.background="linear-gradient(135deg, #2563eb, #1d4ed8)",C.style.transform="translateY(-1px)"},C.onmouseout=()=>{C.style.background="linear-gradient(135deg, #3b82f6, #2563eb)",C.style.transform=""},C.onclick=()=>{if(i&&"Unknown location"!==i){const e=i.split(", ");if(4===e.length){const[t,a,i,s]=e.map(n=>parseInt(n.trim(),10)),l=[t,a,i,s],c=document.querySelector("#bm-I"),d=document.querySelector("#bm-J"),p=document.querySelector("#bm-K"),m=document.querySelector("#bm-L");c&&(c.value=t),d&&(d.value=a),p&&(p.value=i),m&&(m.value=s);const u=f(l);if(u){const e=z();if("openurl"===e){const n=13.62,e=`https://wplace.live/?lat=${u.lat}&lng=${u.t}&zoom=${n}`;window.location.href=e}else L(u.lat,u.t);document.body.removeChild(o),n.K(`🧭 ${"openurl"===e?"Navigating":"Flying"} to "${r}" at ${u.lat.toFixed(6)}, ${u.t.toFixed(6)}! Coordinates auto-filled.`)}else n.K("❌ Unable to convert coordinates to location!")}else n.K("❌ Invalid coordinate format!")}else n.K("❌ No coordinates available for this template!")};const T=document.createElement("button");T.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',T.title="Delete this template",T.style.cssText="\n      padding: 8px;\n      border: none;\n      border-radius: 8px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      min-width: 36px;\n      height: 36px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: linear-gradient(135deg, #ef4444, #dc2626);\n      color: white;\n    ",T.onmouseover=()=>{T.style.background="linear-gradient(135deg, #dc2626, #b91c1c)",T.style.transform="translateY(-1px)"},T.onmouseout=()=>{T.style.background="linear-gradient(135deg, #ef4444, #dc2626)",T.style.transform=""},T.onclick=e=>{e.stopPropagation(),q(`Delete "${r}"?`,"Are you sure you want to delete this template?\n\nThis action cannot be undone!",async()=>{try{if(!await R.de(t))throw new Error("Delete operation returned false");d.remove(),n.K(`Successfully deleted template "${r}"!`),0===c.children.length&&(document.body.removeChild(o),n.K("All templates deleted - dialog closed"))}catch(e){p("❌ Failed to delete template:",e),n.X("Failed to delete template. Check console for details.")}})},$.appendChild(M),$.appendChild(C),$.appendChild(T),$.appendChild(S),d.appendChild(m),d.appendChild($),c.appendChild(d)}),l.appendChild(c);const d=document.createElement("div");d.style.cssText="\n    display: flex; gap: 12px; padding: 12px 16px; border-top: 1px solid #334155;\n    background: #1b2433; position: sticky; bottom: 0; justify-content: center; align-items: center;";const m=document.createElement("button");m.textContent="Enable All",m.style.cssText="padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg,#10b981,#059669); color: white;",m.onclick=()=>{Object.keys(e).forEach(n=>R.Ne(n,!0)),n.K("Enabled all templates"),l.querySelectorAll("button").forEach(n=>{"Disabled"!==n.textContent&&"Enabled"!==n.textContent||(n.textContent="Enabled",n.style.background="linear-gradient(135deg, #10b981, #059669)",n.style.color="white")})};const u=document.createElement("button");u.textContent="Disable All",u.style.cssText="padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg,#64748b,#475569); color: #e2e8f0;",u.onclick=()=>{Object.keys(e).forEach(n=>R.Ne(n,!1)),n.K("Disabled all templates"),l.querySelectorAll("button").forEach(n=>{"Disabled"!==n.textContent&&"Enabled"!==n.textContent||(n.textContent="Disabled",n.style.background="linear-gradient(135deg, #64748b, #475569)",n.style.color="#e2e8f0")})},d.appendChild(m),d.appendChild(u),a.appendChild(r),a.appendChild(l),a.appendChild(d),o.appendChild(a),o.addEventListener("click",n=>{n.target===o&&document.body.removeChild(o)}),document.body.appendChild(o)}(n)}})._().P({id:"bm-19",innerHTML:(j()?S:M)+(j()?"Resume":"Pause")},(n,e)=>{j()&&e.classList.add("paused"),e.onclick=()=>{const t=function(n){return _||E.size>0&&Array.from(E.keys()).slice(0,5),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmTileRefreshPaused",e),localStorage.setItem("bmTileRefreshPaused",e)}catch(n){p("Failed to save tile refresh pause setting:",n)}}(_=!_),D(n),_}(R),o=E.size;e.innerHTML=`${t?S:M} ${t?"Resume":"Pause"}${t&&o>0?` (${o})`:""}`,t?e.classList.add("paused"):e.classList.remove("paused"),n.K(t?`🧊 Tile refresh paused! Showing frozen template view with ${o} cached tiles for better performance.`:"▶️ Tile refresh resumed - templates now update in real-time")}})._().P({id:"bm-d",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>Color Filter'},(n,e)=>{e.onclick=()=>{X()}})._()._().Y({id:P.C,placeholder:`Status: Sleeping...\nVersion: ${B}`,readOnly:!0})._().D({id:"bm-7",style:"position: relative; padding-bottom: 22px;"}).D({style:"display: flex; gap: 6px; align-items: center;"}).P({id:"bm-u",className:"bm-P",innerHTML:"🎨",title:"Template Color Converter"},(n,e)=>{e.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})})._().P({id:"bm-1U",className:"bm-P",innerHTML:"🔍",title:"Location Search"},(n,e)=>{e.addEventListener("click",()=>{const n=document.getElementById("skirk-search-draggable");n&&(n.style.display="none"!==n.style.display&&n.style.display?"none":"flex")})})._().P({id:"bm-1E",className:"bm-P",innerHTML:"🗺️",title:"Fly to current coordinates"},(n,e)=>{e.addEventListener("click",()=>{const n=Number(document.querySelector("#bm-I").value),e=Number(document.querySelector("#bm-J").value),t=Number(document.querySelector("#bm-K").value),o=Number(document.querySelector("#bm-L").value),[a,r]=function(n,e,t,o){const a=19.56787924100512,r=20037508.342789244;let i=(1e3*n+t)*a-r,s=(r-(1e3*e+o)*a)/r*180;return[180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),i/r*180]}(n,e,t,o);if("openurl"===z()){const n=`https://wplace.live/?lat=${a}&lng=${r}&zoom=13.62`;window.location.href=n}else L(a,r)})})._().P({id:"bm-1i",className:"bm-P",innerHTML:"📸",title:"Screenshot current template area (auto-detects coordinates)"},(n,e)=>{e.addEventListener("click",async()=>{try{let e=null;if(R.Vn&&1===R.Jn.size){const n=Array.from(R.Jn)[0];e=R.Nn.find(e=>`${e.Z} ${e.nn}`===n)}if(!e&&R.Nn)for(const n of R.Nn){const t=`${n.Z} ${n.nn}`;if(R.ue(t)){e=n;break}}if(e||(e=R.Nn?.[0]),!e)return void n.X("No template loaded.");if(!e.coords||4!==e.coords.length)return void n.X("Template coordinates not available. Create a template first.");const[t,o,a,r]=e.coords;if(!(Number.isFinite(t)&&Number.isFinite(o)&&Number.isFinite(a)&&Number.isFinite(r)))return void n.X("Invalid template coordinates detected.");if(!e.imageWidth||!e.imageHeight)try{const n=Object.keys(e.en||{});if(n.length>0){let t=1/0,o=1/0,a=0,r=0;const i=R.Bn||3,s=(R.tn||1e3)*i;for(const l of n){const n=e.en[l],[c,d,p,m]=l.split(",").map(Number),u=c*s+p*i,b=d*s+m*i,g=u+n.width,f=b+n.height;u<t&&(t=u),b<o&&(o=b),g>a&&(a=g),f>r&&(r=f)}e.imageWidth=Math.round((a-t)/i),e.imageHeight=Math.round((r-o)/i)}}catch(n){}if(!e.imageWidth||!e.imageHeight)return void n.X("Template size unavailable; create or reload the template first.");const i=H?.Ct;if(!i)return void n.X("Tile server not detected yet; open the board to load tiles.");const s=await R.gt(i,[t,o,a,r],[e.imageWidth,e.imageHeight]),l=URL.createObjectURL(s),c=document.createElement("a");c.href=l;const d=(new Date).toISOString().replace(/[:.]/g,"-");c.download=`wplace_template_area_${String(t).padStart(4,"0")},${String(o).padStart(4,"0")}_${d}.png`,document.body.appendChild(c),c.click(),c.remove(),setTimeout(()=>URL.revokeObjectURL(l),1e3),n.K(`📸 Saved template area screenshot!\nLocation: Tile ${t},${o} • Pixel ${a},${r}\nSize: ${e.imageWidth}×${e.imageHeight}px`)}catch(e){console.error(e),n.X("Failed to create screenshot")}})})._().P({id:"bm-17",className:"bm-P",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rotate-ccw"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',title:"Clear All Storage"},(n,e)=>{e.addEventListener("click",()=>{!function(n){q("Clear All Storage?","This will delete ALL Blue Marble data including:\n\n• Templates\n• Settings\n• Color filters\n• Crosshair preferences\n• All cached data\n\nThis action cannot be undone!\n\nAre you sure?",()=>{try{const e=["bmTemplates","bmTemplates_timestamp","bmErrorMap","bmCrosshairColor","bmCrosshairBorder","bmCrosshairEnhancedSize","bmCrosshairRadius","bmCrosshairThickness","bmMiniTracker","bmCollapseMin","bmMobileMode","bmTileRefreshPaused","bmShowLeftOnColor","bmShowWrongOnColor","bmQuickfillEnabled","bmQuickfillPixels","bmQuickfillSelectedColor","bmcf-excluded-colors","bmcf-excluded-colors-pending","bmcf-view-preference","bmEnhanceWrongColors"];let t=0;e.forEach(n=>{null!==localStorage.getItem(n)&&(localStorage.removeItem(n),t++)}),"undefined"!=typeof GM_deleteValue&&e.forEach(n=>{try{GM_deleteValue(n)}catch(n){}}),"undefined"!=typeof GM&&GM.deleteValue&&e.forEach(async n=>{try{await GM.deleteValue(n)}catch(n){}}),R&&(R.zn=null,R.Nn=[],R.te=!1);try{Object.keys(sessionStorage).forEach(n=>{(n.toLowerCase().includes("bm")||n.toLowerCase().includes("bluemarble"))&&sessionStorage.removeItem(n)})}catch(n){console.warn("Could not clear session storage:",n)}n.K(`🧹 Storage cleared! Deleted ${t} keys. Please refresh the page.`),setTimeout(()=>{confirm("Storage cleared successfully!\n\nRefresh the page to complete the reset?")&&window.location.reload()},2e3)}catch(e){console.error("❌ Error clearing storage:",e),n.X("Failed to clear storage. Check console for details.")}},()=>{n.K("Storage clearing cancelled")})}(n)})})._().P({id:"bm-1C",className:"bm-P",innerHTML:$,title:"Import Templates"},(n,e)=>{e.addEventListener("click",()=>{!function(n){const e=document.createElement("div");e.id="bm-1w",e.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.8);\n    backdrop-filter: blur(8px);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    z-index: 10001;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  ";const t=document.createElement("div");t.style.cssText="\n    background: #1e293b;\n    color: #f1f5f9;\n    border-radius: 20px;\n    border: 1px solid #334155;\n    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(16px);\n    max-width: 500px;\n    width: 90%;\n    padding: 40px;\n    text-align: center;\n    position: relative;\n  ";const o=document.createElement("h3");o.textContent="Import Templates",o.style.cssText="\n    margin: 0 0 20px 0;\n    font-size: 1.5em;\n    font-weight: 700;\n    background: linear-gradient(135deg, #f1f5f9, #cbd5e1);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n  ";const a=document.createElement("div");a.style.cssText="\n    border: 2px dashed #475569;\n    border-radius: 12px;\n    padding: 60px 20px;\n    margin: 20px 0;\n    background: rgba(71, 85, 105, 0.1);\n    transition: all 0.2s ease;\n    cursor: pointer;\n  ";const r=document.createElement("div");r.innerHTML=$,r.style.cssText="\n    font-size: 48px;\n    margin-bottom: 16px;\n    color: #64748b;\n  ";const i=document.createElement("p");i.innerHTML="Drag & drop your JSON file here<br>or <strong>click to browse</strong>",i.style.cssText="\n    margin: 0;\n    color: #94a3b8;\n    font-size: 1.1em;\n    line-height: 1.5;\n  ",a.appendChild(r),a.appendChild(i);const s=document.createElement("input");s.type="file",s.accept=".json,application/json",s.style.display="none";const l=document.createElement("button");l.innerHTML="×",l.style.cssText="\n    position: absolute;\n    top: 15px;\n    right: 20px;\n    background: transparent;\n    border: none;\n    color: #94a3b8;\n    font-size: 24px;\n    cursor: pointer;\n    width: 30px;\n    height: 30px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: all 0.2s ease;\n  ",l.onmouseover=()=>{l.style.background="rgba(255, 255, 255, 0.1)",l.style.color="#f1f5f9"},l.onmouseout=()=>{l.style.background="transparent",l.style.color="#94a3b8"},l.onclick=()=>document.body.removeChild(e);const c=async t=>{if(t)try{const o=await t.text(),a=JSON.parse(o);await R.ft(a,{ht:!0}),document.body.removeChild(e),n.K(`Imported templates from ${t.name}!`)}catch(e){console.error(e),n.K("Failed to import JSON - please check the file format")}};s.onchange=()=>c(s.files?.[0]),a.onclick=()=>s.click(),a.ondragover=n=>{n.preventDefault(),a.style.borderColor="#3b82f6",a.style.background="rgba(59, 130, 246, 0.1)"},a.ondragleave=()=>{a.style.borderColor="#475569",a.style.background="rgba(71, 85, 105, 0.1)"},a.ondrop=e=>{e.preventDefault(),a.style.borderColor="#475569",a.style.background="rgba(71, 85, 105, 0.1)";const t=e.dataTransfer.files?.[0];t&&"application/json"===t.type?c(t):n.K("Please drop a valid JSON file")},t.appendChild(l),t.appendChild(o),t.appendChild(a),t.appendChild(s),e.appendChild(t),e.addEventListener("click",n=>{n.target===e&&document.body.removeChild(e)}),document.body.appendChild(e)}(n)})})._()._().D({style:"position: absolute; left: 0; bottom: 2px; text-align: left; padding: 0; pointer-events: auto; user-select: text; line-height: 12px;"}).F({textContent:"Made by SwingTheVine | Fork Seris0",style:"color: #94a3b8; font-size: 0.74em; opacity: 0.85;"})._()._()._()._().G(document.body)}(),U=R,_=function(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmTileRefreshPaused",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmTileRefreshPaused");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load tile refresh pause setting:",n)}return!1}(),G||(G=U.Tn.bind(U),U.Tn=async function(n,e){const t=await G(n,e);if(!_){const n=Array.isArray(e)?e[0].toString().padStart(4,"0")+","+e[1].toString().padStart(4,"0"):e.toString();if(E.set(n,t),E.size>100){const n=E.keys().next().value;E.delete(n)}}return t}),D(U),setTimeout(()=>{un()},100),P.q("#bm-M","#bm-H"),H.Tt(P),new MutationObserver((n,e)=>{const t=document.querySelector("#color-1");if(!t)return;let o=document.querySelector("#bm-D");if(!o){o=document.createElement("button"),o.id="bm-D",o.textContent="Move ↑",o.className="btn btn-soft",o.onclick=function(){const n=this.parentNode.parentNode.parentNode.parentNode,e="Move ↑"==this.textContent;n.parentNode.className=n.parentNode.className.replace(e?"bottom":"top",e?"top":"bottom"),n.style.borderTopLeftRadius=e?"0px":"var(--radius-box)",n.style.borderTopRightRadius=e?"0px":"var(--radius-box)",n.style.borderBottomLeftRadius=e?"var(--radius-box)":"0px",n.style.borderBottomRightRadius=e?"var(--radius-box)":"0px",this.textContent=e?"Move ↓":"Move ↑"};const n=t.parentNode.parentNode.parentNode.parentNode.querySelector("h2");n.parentNode?.appendChild(o)}}).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver(()=>{const n=document.querySelector('button[title="Toggle art opacity"], button[title="Alterar opacidade"]');if(!n)return;let e=document.querySelector("#bm-18");if(e)return;if(!n.closest(".absolute.bottom-3.left-3.z-30"))return;e=document.createElement("div"),e.id="bm-18",e.className="fixed z-30",e.style.bottom="230px",e.style.left="12px";const t=document.createElement("button");t.id="bm-12",t.innerHTML="🗺️",t.className="btn btn-lg btn-square sm:btn-xl z-30 shadow-md text-base-content/80",t.title="Error Map View",Z()&&(t.style.background="linear-gradient(135deg, #10b981, #059669)",t.style.color="white"),t.onclick=function(){!function(){const n=!Z();(function(n){try{const e=JSON.stringify(!!n);"undefined"!=typeof GM_setValue&&GM_setValue("bmErrorMap",e),localStorage.setItem("bmErrorMap",e)}catch(n){p("❌ Failed to save error map setting:",n)}})(n),R&&R.st(n),R.Nn&&R.Nn.length>0&&(R.ze(!1),setTimeout(()=>{R.ze(!0)},50))}();const n=Z();n?(this.style.background="linear-gradient(135deg, #10b981, #059669)",this.style.color="white"):(this.style.background="",this.style.color=""),P.K(`Error Map ${n?"enabled":"disabled"}! ${n?"Green=correct, Red=wrong pixels":"Back to normal view"}`)},e.appendChild(t),document.body.appendChild(e)}).observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("keydown",n=>{"KeyX"!==n.code||n.repeat||(Q=!0,document.body.style.cursor="crosshair",void 0!==P&&P.K&&P.K("🎹 X-Mode: Click a color to enable enhanced mode for that color only"))}),document.addEventListener("keyup",n=>{"KeyX"===n.code&&(Q=!1,document.body.style.cursor="")}),document.addEventListener("click",function(n){if(!Q)return;const e=n.target.closest('button[id^="color-"]');if(!e)return;n.preventDefault(),n.stopPropagation();const t=e.id,o=K[t];if(!o)return void m(`🎹 [X-Mode] Unknown color ID: ${t}`);if("color-0"===t)return void(void 0!==P&&P.K&&P.K("🎹 X-Mode: Cannot enhance transparent color"));const a=R.Nn?.[0];if(a)try{a.enhancedColors.clear(),a.hn(o);const n=e.getAttribute("aria-label")||t;void 0!==P&&P.K&&P.K(`✅ Enhanced mode enabled for: ${n}`),en().then(()=>{}).catch(n=>{p("🎹 [X-Mode] Error refreshing template:",n)});const r=document.getElementById("bm-c");r&&(r.remove(),setTimeout(()=>{X()},100))}catch(n){p("🎹 [X-Mode] Error processing enhanced color:",n),void 0!==P&&P.X&&P.X("🎹 X-Mode: Failed to set enhanced color")}else void 0!==P&&P.X&&P.X("🎹 X-Mode: No template loaded")},!0),!document.getElementById("bm-1j")){const n=document.createElement("style");n.id="bm-1j",n.textContent="\n    #bm-1o {\n      display: flex;\n      align-items: center;\n    }\n    #bm-15 {\n      margin-right: 0px;\n    }\n    #bm-X {\n      margin: 0;\n      flex: 1;\n    }\n  ",document.head.appendChild(n)}function q(n,e,t,o=null){if(!document.getElementById("bm-a")){const n=document.createElement("style");n.id="bm-a",n.textContent="\n      .bmcd-overlay-backdrop { \n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.9);\n        backdrop-filter: blur(12px);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 15000;\n        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        animation: bmcd-fadeIn 0.2s ease-out;\n      }\n      \n      @keyframes bmcd-fadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n      \n      @keyframes bmcd-slideIn {\n        from { \n          opacity: 0;\n          transform: translate(-50%, -50%) scale(0.9) translateY(20px);\n        }\n        to { \n          opacity: 1;\n          transform: translate(-50%, -50%) scale(1) translateY(0);\n        }\n      }\n      \n      .bmcd-container { \n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: var(--slate-900, #0f172a);\n        color: var(--slate-100, #f1f5f9);\n        border-radius: 16px;\n        border: 1px solid var(--slate-700, #334155);\n        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);\n        backdrop-filter: blur(16px);\n        max-width: 400px;\n        width: 90%;\n        overflow: hidden;\n        animation: bmcd-slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n      \n      .bmcd-container::before {\n        content: '';\n        position: absolute;\n        inset: 0;\n        border-radius: 16px;\n        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));\n        pointer-events: none;\n      }\n      \n      .bmcd-header { \n        padding: 20px 24px 16px 24px;\n        border-bottom: 1px solid var(--slate-700, #334155);\n        background: linear-gradient(135deg, var(--slate-800, #1e293b), var(--slate-750, #293548));\n        position: relative;\n        z-index: 1;\n      }\n      \n      .bmcd-title {\n        margin: 0;\n        font-size: 1.25em;\n        font-weight: 700;\n        text-align: center;\n        letter-spacing: -0.025em;\n        background: linear-gradient(135deg, var(--red-400, #f87171), var(--red-500, #ef4444));\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n        background-clip: text;\n      }\n      \n      .bmcd-content { \n        padding: 20px 24px;\n        position: relative;\n        z-index: 1;\n        text-align: center;\n      }\n      \n      .bmcd-message {\n        color: var(--slate-300, #cbd5e1);\n        line-height: 1.6;\n        white-space: pre-line;\n        font-size: 0.95em;\n      }\n      \n      .bmcd-footer { \n        display: flex;\n        gap: 12px;\n        justify-content: center;\n        align-items: center;\n        padding: 16px 24px 20px 24px;\n        border-top: 1px solid var(--slate-700, #334155);\n        background: linear-gradient(135deg, var(--slate-800, #1e293b), var(--slate-750, #293548));\n        position: relative;\n        z-index: 1;\n      }\n      \n      .bmcd-btn {\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        height: 40px;\n        padding: 0 20px;\n        min-width: 100px;\n        border-radius: 10px;\n        border: 1px solid;\n        font-size: 0.9em;\n        font-weight: 600;\n        white-space: nowrap;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        overflow: hidden;\n        flex: 1;\n      }\n      \n      .bmcd-btn::before {\n        content: '';\n        position: absolute;\n        inset: 0;\n        border-radius: 10px;\n        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));\n        opacity: 0;\n        transition: opacity 0.2s ease;\n      }\n      \n      .bmcd-btn:hover::before {\n        opacity: 1;\n      }\n      \n      .bmcd-btn:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 8px 25px rgba(0,0,0,0.4);\n      }\n      \n      .bmcd-btn:active {\n        transform: translateY(0);\n      }\n      \n      .bmcd-btn-danger {\n        background: linear-gradient(135deg, var(--red-500, #ef4444), var(--red-600, #dc2626));\n        color: white;\n        border-color: var(--red-600, #dc2626);\n      }\n      \n      .bmcd-btn-danger:hover {\n        background: linear-gradient(135deg, var(--red-600, #dc2626), var(--red-700, #b91c1c));\n        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);\n      }\n      \n      .bmcd-btn-secondary {\n        background: var(--slate-700, #334155);\n        color: var(--slate-100, #f1f5f9);\n        border-color: var(--slate-600, #475569);\n      }\n      \n      .bmcd-btn-secondary:hover {\n        background: var(--slate-600, #475569);\n      }\n      \n      @media (max-width: 520px) {\n        .bmcd-container {\n          width: 95%;\n        }\n        \n        .bmcd-btn {\n          min-width: 80px;\n          height: 36px;\n          font-size: 0.85em;\n        }\n        \n        .bmcd-header, .bmcd-content, .bmcd-footer {\n          padding-left: 20px;\n          padding-right: 20px;\n        }\n      }\n    ",document.head.appendChild(n)}const a=document.createElement("div");a.className="bmcd-overlay-backdrop";const r=document.createElement("div");r.className="bmcd-container";const i=document.createElement("div");i.className="bmcd-header";const s=document.createElement("h3");s.className="bmcd-title",s.textContent=n,i.appendChild(s);const l=document.createElement("div");l.className="bmcd-content";const c=document.createElement("p");c.className="bmcd-message",c.textContent=e,l.appendChild(c);const d=document.createElement("div");if(d.className="bmcd-footer",t){const n=document.createElement("button");n.className="bmcd-btn bmcd-btn-danger",n.textContent="Delete",n.addEventListener("click",()=>{document.body.removeChild(a),t()});const e=document.createElement("button");e.className="bmcd-btn bmcd-btn-secondary",e.textContent="Cancel",e.addEventListener("click",()=>{document.body.removeChild(a),o&&o()}),d.appendChild(e),d.appendChild(n)}else{const n=document.createElement("button");n.className="bmcd-btn bmcd-btn-secondary",n.textContent="OK",n.style.flex="none",n.style.minWidth="120px",n.addEventListener("click",()=>{document.body.removeChild(a),o&&o()}),d.appendChild(n),setTimeout(()=>n.focus(),100)}r.appendChild(i),r.appendChild(l),r.appendChild(d),a.appendChild(r),a.addEventListener("click",n=>{n.target===a&&(document.body.removeChild(a),o&&o())});const p=n=>{"Escape"===n.key&&(document.body.removeChild(a),document.removeEventListener("keydown",p),o&&o())};document.addEventListener("keydown",p),document.body.appendChild(a),t&&setTimeout(()=>{const n=d.querySelector(".bmcd-btn-secondary");n&&n.focus()},100)}function X(){if(!R.Nn||0===R.Nn.length)return void P.X("No templates available for color filtering!");const n=document.getElementById("bm-c");n&&n.remove();const e=dn();Promise.resolve().then(()=>(y(),i)).then(n=>{const t=n.l,o=R.Be(0,!0);try{nn(o)}catch(n){m("Failed to update palette left badges:",n)}let a=0,r=0,i=0,s=0;const l=JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]");if(R.Ln&&R.Ln.size>0){const n=new Set;if(R.Nn)for(const e of R.Nn){const t=`${e.Z} ${e.nn}`;R.ue(t)&&n.add(t)}for(const[e,t]of R.Ln.entries()){let o=!0;if(n.size>0){o=!1;const[t,a]=e.split(",").map(n=>parseInt(n));for(const e of R.Nn){const r=`${e.Z} ${e.nn}`;if(n.has(r)){if(e.en)for(const n of Object.keys(e.en)){const[e,r]=n.split(",").map(n=>parseInt(n));if(e===t&&r===a){o=!0;break}}if(o)break}}}if(o&&t.he)for(const[n,e]of Object.entries(t.he))l.includes(n)||(s+=e.xe||0)}}for(const[n,e]of Object.entries(o))l.includes(n)||(a+=e.Je||0,r+=e.ye||0,i+=e.Ae||0);let c,d,u;if(R.Ze(),d=r,u=a,c=u>0?Math.round(d/u*100):0,!document.getElementById("bmcf-styles")){const n=document.createElement("style");n.id="bmcf-styles",n.textContent="\n        :root { \n          --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1; \n          --slate-400: #94a3b8; --slate-500: #64748b; --slate-600: #475569; --slate-700: #334155; \n          --slate-750: #293548; --slate-800: #1e293b; --slate-900: #0f172a; --slate-950: #020617;\n          --blue-400: #60a5fa; --blue-500: #3b82f6; --blue-600: #2563eb; --blue-700: #1d4ed8;\n          --emerald-400: #34d399; --emerald-500: #10b981; --emerald-600: #059669; --emerald-700: #047857;\n          --bmcf-bg: var(--slate-900); --bmcf-card: var(--slate-800); --bmcf-border: var(--slate-700); \n          --bmcf-muted: var(--slate-400); --bmcf-text: var(--slate-100); --bmcf-text-muted: var(--slate-300);\n        }\n        .bmcf-overlay { \n          width: min(94vw, 670px); max-height: 88vh; background: var(--bmcf-bg); color: var(--bmcf-text); \n          border-radius: 20px; border: 1px solid var(--bmcf-border); \n          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05); \n          display: flex; flex-direction: column; overflow: hidden; \n          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; \n          backdrop-filter: blur(16px); position: relative;\n        }\n        .bmcf-overlay::before {\n          content: ''; position: absolute; inset: 0; border-radius: 20px; \n          background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05)); \n          pointer-events: none;\n        }\n        .bmcf-header { \n          display: flex; flex-direction: column; padding: 16px 20px 12px 20px; \n          border-bottom: 1px solid var(--bmcf-border); \n          background: linear-gradient(135deg, var(--slate-800), var(--slate-750)); \n          position: relative; z-index: 1;\n        }\n        .bmcf-content { padding: 20px; overflow: auto; position: relative; z-index: 1; }\n        .bmcf-footer { \n          display: flex; gap: 12px; justify-content: center; align-items: center; padding: 16px 20px; \n          border-top: 1px solid var(--bmcf-border); \n          background: linear-gradient(135deg, var(--slate-800), var(--slate-750)); \n          position: relative; z-index: 1;\n        }\n        .bmcf-btn { \n          display: inline-flex; align-items: center; justify-content: center; height: 40px; \n          padding: 0 18px; min-width: 120px; border-radius: 12px; border: 1px solid var(--bmcf-border); \n          font-size: 0.9em; font-weight: 600; white-space: nowrap; cursor: pointer; \n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;\n          background: var(--slate-700); color: var(--bmcf-text);\n        }\n        .bmcf-btn::before {\n          content: ''; position: absolute; inset: 0; border-radius: 12px; \n          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); \n          opacity: 0; transition: opacity 0.2s ease;\n        }\n        .bmcf-btn:hover::before { opacity: 1; }\n        .bmcf-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }\n        .bmcf-btn.success { \n          background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600)); \n          color: white; border-color: var(--emerald-600);\n        }\n        .bmcf-btn.success:hover { \n          background: linear-gradient(135deg, var(--emerald-600), var(--emerald-700)); \n          box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);\n        }\n        .bmcf-btn.primary { \n          background: linear-gradient(135deg, var(--blue-500), var(--blue-600)); \n          color: white; border-color: var(--blue-600);\n        }\n        .bmcf-btn.primary:hover { \n          background: linear-gradient(135deg, var(--blue-600), var(--blue-700)); \n          box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);\n        }\n        .bmcf-input { \n          width: 100%; height: 44px; padding: 12px 16px; border-radius: 12px; \n          border: 1px solid var(--bmcf-border); background: var(--slate-800); color: var(--bmcf-text); \n          outline: none; font-size: 0.95em; transition: all 0.2s ease;\n        }\n        .bmcf-input:focus { \n          border-color: var(--blue-500); \n          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(59, 130, 246, 0.15); \n        }\n        @media (max-width: 520px) { .bmcf-btn { min-width: 100px; height: 36px; font-size: 0.85em; } }\n        \n        /* View toggle guards - prevent grid/list overlap */\n        .bmcf-view-container .bmcf-grid { display: grid; }\n        .bmcf-view-container .bmcf-list { display: none; }\n        .bmcf-view-container.list-mode .bmcf-grid { display: none !important; }\n        .bmcf-view-container.list-mode .bmcf-list { display: flex !important; }\n        \n        /* Mobile Mode will be applied dynamically via applyMobileModeToColorFilter() */\n      ",document.head.appendChild(n)}if(!localStorage.getItem("bmcf-excluded-colors-pending")){const n=localStorage.getItem("bmcf-excluded-colors")||"[]";localStorage.setItem("bmcf-excluded-colors-pending",n)}const b=document.createElement("div");b.id="bm-c",b.style.cssText=`\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 9001;\n      ${e?"max-width: 95vw; max-height: 90vh;":""}\n    `,b.className="bmcf-overlay";const g=document.createElement("div");g.className="bmcf-header",g.style.cssText="cursor: move; user-select:none; flex-shrink:0; flex-direction: column;";const f=document.createElement("div");f.className="bmcf-drag-bar",f.style.cssText="\n      background: linear-gradient(90deg, #475569 0%, #64748b 50%, #475569 100%);\n      border-radius: 4px;\n      cursor: grab;\n      width: 100%;\n      height: 6px;\n      margin-bottom: 8px;\n      opacity: 0.8;\n      transition: opacity 0.2s ease;\n    ",f.addEventListener("mouseenter",()=>{f.style.opacity="1"}),f.addEventListener("mouseleave",()=>{f.style.opacity="0.8"});const h=document.createElement("div");h.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      width: 100%;\n    ";const x=document.createElement("h2");x.textContent="Template Color Filter";const v=e?"1.2em":"1.5em";x.style.cssText=`\n      margin: 0; \n      font-size: ${v}; \n      font-weight: 700;\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n      text-align: center;\n      flex: 1;\n      pointer-events: none;\n      letter-spacing: -0.025em;\n      background: linear-gradient(135deg, var(--slate-100), var(--slate-300));\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n    `;const w=document.createElement("button");w.textContent="✕";const y=e?"32px":"36px",k=e?"14px":"16px";w.style.cssText=`\n      background: linear-gradient(135deg, #ef4444, #dc2626);\n      border: 1px solid rgba(239, 68, 68, 0.3);\n      color: white;\n      width: ${y};\n      height: ${y};\n      border-radius: 12px;\n      cursor: pointer;\n      font-size: ${k};\n      font-weight: 600;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      position: relative;\n      overflow: hidden;\n    `,w.onmouseover=()=>{w.style.transform="translateY(-1px) scale(1.05)",w.style.boxShadow="0 6px 20px rgba(239, 68, 68, 0.4)"},w.onmouseout=()=>{w.style.transform="",w.style.boxShadow=""},w.addEventListener("touchstart",()=>{w.style.transform="",w.style.boxShadow=""},{passive:!0}),w.onclick=()=>{localStorage.removeItem("bmcf-excluded-colors-pending"),b.remove()};const $=document.createElement("button");$.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.8a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',$.style.cssText=`\n      background: linear-gradient(135deg, var(--slate-600), var(--slate-700));\n      border: 1px solid var(--slate-500);\n      color: var(--slate-200);\n      width: ${y};\n      height: ${y};\n      border-radius: 12px;\n      cursor: pointer;\n      font-size: ${k};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin-right: 12px;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      position: relative;\n      overflow: hidden;\n    `,$.onmouseover=()=>{$.style.transform="translateY(-1px) scale(1.05)",$.style.background="linear-gradient(135deg, var(--slate-500), var(--slate-600))",$.style.boxShadow="0 6px 20px rgba(71, 85, 105, 0.3)"},$.onmouseout=()=>{$.style.transform="",$.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",$.style.boxShadow=""},$.addEventListener("touchstart",()=>{$.style.transform="",$.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",$.style.boxShadow=""},{passive:!0}),$.onclick=()=>function(){try{let n=function(n,e,t=!1){const{rgb:o,alpha:a}=n,r=`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${a/255})`,i=e?"rgba(0, 100, 255, 0.8)":"transparent";T.innerHTML=t?`\n        <div style="\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          width: 100%;\n          height: 100%;\n          display: grid;\n          grid-template-columns: repeat(5, 1fr);\n          grid-template-rows: repeat(5, 1fr);\n          gap: 1px;\n          background: rgba(0,0,0,0.1);\n        ">\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          \n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          \n          <div style="background: ${r};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: black; border: 2px solid rgba(255,255,255,0.4); box-sizing: border-box;"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${r};"></div>\n          \n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          \n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n        </div>\n      `:`\n        <div style="\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          width: 100%;\n          height: 100%;\n          display: grid;\n          grid-template-columns: 1fr 1fr 1fr;\n          grid-template-rows: 1fr 1fr 1fr;\n          gap: 1px;\n          background: rgba(0,0,0,0.1);\n        ">\n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n          \n          <div style="background: ${r};"></div>\n          <div style="background: black; border: 2px solid rgba(255,255,255,0.4); box-sizing: border-box;"></div>\n          <div style="background: ${r};"></div>\n          \n          <div style="background: ${e?i:"transparent"};"></div>\n          <div style="background: ${r};"></div>\n          <div style="background: ${e?i:"transparent"};"></div>\n        </div>\n      `};if(!document.getElementById("bmcf-styles")){const n=document.createElement("style");n.id="bmcf-styles",n.textContent="\n        :root { \n          --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1; \n          --slate-400: #94a3b8; --slate-500: #64748b; --slate-600: #475569; --slate-700: #334155; \n          --slate-750: #293548; --slate-800: #1e293b; --slate-900: #0f172a; --slate-950: #020617;\n          --blue-400: #60a5fa; --blue-500: #3b82f6; --blue-600: #2563eb; --blue-700: #1d4ed8;\n          --emerald-400: #34d399; --emerald-500: #10b981; --emerald-600: #059669; --emerald-700: #047857;\n          --bmcf-bg: var(--slate-900); --bmcf-card: var(--slate-800); --bmcf-border: var(--slate-700); \n          --bmcf-muted: var(--slate-400); --bmcf-text: var(--slate-100); --bmcf-text-muted: var(--slate-300);\n        }\n        \n        @keyframes gradientShift {\n          0% { background-position: 0% 50%; }\n          50% { background-position: 100% 50%; }\n          100% { background-position: 0% 50%; }\n        }\n        \n        /* Custom RGB input placeholder styling */\n        .bm-k::placeholder {\n          text-align: center !important;\n          color: var(--slate-400) !important;\n          font-weight: 600 !important;\n          opacity: 1 !important;\n        }\n        \n        .bm-k::-webkit-input-placeholder {\n          text-align: center !important;\n          color: var(--slate-400) !important;\n          font-weight: 600 !important;\n        }\n        \n        .bm-k::-moz-placeholder {\n          text-align: center !important;\n          color: var(--slate-400) !important;\n          font-weight: 600 !important;\n          opacity: 1 !important;\n        }\n        \n        .bm-k:-ms-input-placeholder {\n          text-align: center !important;\n          color: var(--slate-400) !important;\n          font-weight: 600 !important;\n        }\n      ",document.head.appendChild(n)}const e=document.getElementById("bm-0");e&&e.remove();const t=[{name:"Red",rgb:[255,0,0],alpha:255},{name:"Blue",rgb:[64,147,228],alpha:255},{name:"Green",rgb:[0,255,0],alpha:255},{name:"Purple",rgb:[170,56,185],alpha:255},{name:"Yellow",rgb:[249,221,59],alpha:255},{name:"Orange",rgb:[255,127,39],alpha:255},{name:"Cyan",rgb:[96,247,242],alpha:255},{name:"Pink",rgb:[236,31,128],alpha:255},{name:"Custom",rgb:[255,255,255],alpha:255,Dt:!0}],o=tn();let a={...o};a.Dt||t.filter(n=>!n.Dt).some(n=>JSON.stringify(n.rgb)===JSON.stringify(a.rgb))||(a.Dt=!0,a.name="Custom");let r=an(),i=ln(),s=dn(),l=pn();const c=document.createElement("div");c.id="bm-0";const d=dn(),u=d?"\n      max-width: 350px;\n      max-height: 70vh;\n      border-radius: 12px;\n    ":"\n      max-width: 520px;\n      max-height: 85vh;\n      border-radius: 20px;\n    ";c.style.cssText=`\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: #0f172a;\n      color: #f1f5f9;\n      padding: 0;\n      ${u}\n      z-index: 9002;\n      display: flex;\n      flex-direction: column;\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05);\n      border: 1px solid #334155;\n      backdrop-filter: blur(16px);\n      overflow: hidden;\n    `,c.innerHTML='\n    <div style="\n      position: absolute; inset: 0; border-radius: 20px;\n      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));\n      pointer-events: none; z-index: 0;\n    "></div>\n  ';const b=document.createElement("div"),g=d?"8px 12px":"16px 20px";b.style.cssText=`\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: ${g};\n    border-bottom: 1px solid var(--slate-700);\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    cursor: move;\n    user-select: none;\n    flex-shrink: 0;\n    position: relative;\n    z-index: 1;\n  `;const f=document.createElement("h2");f.textContent="Settings";const h=d?"1.2em":"1.5em";f.style.cssText=`\n    margin: 0; \n    font-size: ${h}; \n    font-weight: 700;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n    text-align: center;\n    flex: 1;\n    pointer-events: none;\n    letter-spacing: -0.025em;\n    background: linear-gradient(135deg, var(--slate-100), var(--slate-300));\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n  `;const x=document.createElement("button");x.textContent="✕",x.style.cssText="\n    background: linear-gradient(135deg, #ef4444, #dc2626);\n    border: 1px solid rgba(239, 68, 68, 0.3);\n    color: white;\n    width: 36px;\n    height: 36px;\n    border-radius: 12px;\n    cursor: pointer;\n    font-size: 16px;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n  ",x.onmouseover=()=>{x.style.transform="translateY(-1px) scale(1.05)",x.style.boxShadow="0 6px 20px rgba(239, 68, 68, 0.4)"},x.onmouseout=()=>{x.style.transform="",x.style.boxShadow=""},x.addEventListener("touchstart",()=>{x.style.transform="",x.style.boxShadow=""},{passive:!0}),x.onclick=()=>c.remove(),b.appendChild(f),b.appendChild(x);const v=document.createElement("p");v.textContent="Select the crosshair color that appears on highlighted template pixels:";const w=d?"0 0 16px 0":"0 0 24px 0",y=d?"0.9em":"0.95em";v.style.cssText=`\n    margin: ${w}; \n    font-size: ${y}; \n    color: var(--slate-300); \n    text-align: center;\n    font-weight: 500;\n    letter-spacing: -0.01em;\n    line-height: 1.4;\n  `;const k=document.createElement("div"),$=d?"12px":"20px",M=d?"16px":"24px",S=d?"12px":"16px";k.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${S};\n    padding: ${$};\n    margin-bottom: ${M};\n    text-align: center;\n    position: relative;\n    overflow: hidden;\n  `;const C=document.createElement("div");C.textContent="Current Color:",C.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const T=document.createElement("div");T.id="bm-b",T.style.cssText="\n    width: 60px;\n    height: 60px;\n    margin: 0 auto 12px;\n    position: relative;\n    background: var(--slate-700);\n    border: 2px solid var(--slate-500);\n    border-radius: 12px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n    transition: all 0.2s ease;\n  ",T.onmouseover=()=>{T.style.transform="scale(1.05)",T.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.6)"},T.onmouseout=()=>{T.style.transform="",T.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"},n(o,r);const N=document.createElement("div");N.id="bm-g",N.textContent=o.name,N.style.cssText="\n    font-weight: 700; \n    font-size: 1.1em;\n    color: var(--slate-100);\n    letter-spacing: -0.025em;\n  ",k.appendChild(C),k.appendChild(T),k.appendChild(N);const O=document.createElement("div"),I=d?"8px":"16px",_=d?"16px":"24px";O.style.cssText=`\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: ${I};\n    margin-bottom: ${_};\n    position: relative;\n    z-index: 1;\n  `,t.forEach(e=>{const i=document.createElement("button");let s=!1;if(s=e.Dt?o.Dt||!t.filter(n=>!n.Dt).some(n=>JSON.stringify(n.rgb)===JSON.stringify(o.rgb)):JSON.stringify(e.rgb)===JSON.stringify(o.rgb)&&!o.Dt,e.Dt){const n=s?`rgba(${o.rgb[0]}, ${o.rgb[1]}, ${o.rgb[2]}, 1)`:"linear-gradient(135deg, \n            #8B5CF6 0%, #A855F7 25%, #3B82F6 50%, #06B6D4 75%, #8B5CF6 100%)",e=d?"85px":"110px",t=d?"8px":"12px";i.style.cssText=`\n        background: ${n};\n        border: 2px solid ${s?"var(--slate-100)":"var(--slate-600)"};\n        border-radius: 12px;\n        padding: ${t};\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        height: ${e};\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        box-sizing: border-box;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n        ${s?"":"background-size: 200% 200%; animation: gradientShift 3s ease infinite;"}\n      `}else{const n=d?"85px":"110px",t=d?"8px":"12px";i.style.cssText=`\n        background: rgba(${e.rgb[0]}, ${e.rgb[1]}, ${e.rgb[2]}, ${e.alpha/255});\n        border: 2px solid ${s?"var(--slate-100)":"var(--slate-600)"};\n        border-radius: 12px;\n        padding: ${t};\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        height: ${n};\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        box-sizing: border-box;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      `}const l=document.createElement("div");if(l.textContent=e.name,l.style.cssText="\n      font-size: 0.9em;\n      font-weight: bold;\n      color: white;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n      text-align: center;\n    ",e.Dt){const e=document.createElement("div"),t=d?"70%":"80%",c=d?"65px":"80px",p=d?"2px":"3px";e.style.cssText=`\n        display: flex;\n        flex-direction: column;\n        gap: ${p};\n        width: ${t};\n        max-width: ${c};\n      `;const m=document.createElement("input");m.type="number",m.min="0",m.max="255",m.value=s?o.rgb[0]:"",m.placeholder="R",m.className="bm-k";const u=d?"2px 3px":"3px 4px",b=d?"18px":"22px",g=d?"0.65em":"0.7em";m.style.cssText=`\n        width: 100%;\n        padding: ${u};\n        border: 1px solid var(--slate-500);\n        border-radius: 4px;\n        background: var(--slate-700);\n        color: var(--slate-100);\n        font-size: ${g};\n        text-align: center;\n        outline: none;\n        font-weight: 600;\n        transition: all 0.2s ease;\n        box-sizing: border-box;\n        height: ${b};\n      `,m.onfocus=()=>{m.style.borderColor="var(--blue-500)",m.style.boxShadow="0 0 0 2px rgba(59, 130, 246, 0.2)"},m.onblur=()=>{m.style.borderColor="var(--slate-500)",m.style.boxShadow=""};const f=document.createElement("input");f.type="number",f.min="0",f.max="255",f.value=s?o.rgb[1]:"",f.placeholder="G",f.className="bm-k",f.style.cssText=m.style.cssText;const h=document.createElement("input");h.type="number",h.min="0",h.max="255",h.value=s?o.rgb[2]:"",h.placeholder="B",h.className="bm-k",h.style.cssText=m.style.cssText;const x=()=>{const e=Math.max(0,Math.min(255,parseInt(m.value)||0)),t=Math.max(0,Math.min(255,parseInt(f.value)||0)),o=Math.max(0,Math.min(255,parseInt(h.value)||0));a={name:"Custom",rgb:[e,t,o],alpha:a.alpha,Dt:!0},i.style.background=`rgba(${e}, ${t}, ${o}, 1)`,n(a,r),document.getElementById("bm-g").textContent=`Custom RGB(${e}, ${t}, ${o})`};[m,f,h].forEach(n=>{n.addEventListener("input",x),n.addEventListener("change",x),n.addEventListener("click",n=>n.stopPropagation()),n.addEventListener("mousedown",n=>n.stopPropagation())}),e.appendChild(m),e.appendChild(f),e.appendChild(h),i.appendChild(l),i.appendChild(e)}else{const n=document.createElement("div");n.textContent=`RGB(${e.rgb.join(", ")})`,n.style.cssText="\n        font-size: 0.7em;\n        color: rgba(255, 255, 255, 0.8);\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n      ",i.appendChild(l),i.appendChild(n)}if(s){const n=document.createElement("div");n.textContent="✓",n.style.cssText="\n        position: absolute;\n        top: 5px;\n        right: 5px;\n        color: white;\n        font-weight: bold;\n        font-size: 1.2em;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n      ",i.appendChild(n)}i.onclick=()=>{e.Dt||(a={...e},n(a,r),document.getElementById("bm-g").textContent=e.name),O.querySelectorAll("button").forEach(n=>{n.style.border="3px solid rgba(255, 255, 255, 0.3)";const e=n.querySelector('div[style*="position: absolute"]');e&&e.remove()}),i.style.border="3px solid #fff";const t=document.createElement("div");t.textContent="✓",t.style.cssText="\n        position: absolute;\n        top: 5px;\n        right: 5px;\n        color: white;\n        font-weight: bold;\n        font-size: 1.2em;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);\n      ",i.appendChild(t)},e.Dt||(i.addEventListener("mouseenter",()=>{s||(i.style.border="3px solid rgba(255, 255, 255, 0.7)",i.style.transform="scale(1.05)")}),i.addEventListener("mouseleave",()=>{s||(i.style.border="3px solid rgba(255, 255, 255, 0.3)",i.style.transform="scale(1)")})),O.appendChild(i)});const G=document.createElement("div"),E=d?"12px":"18px",D=d?"14px":"20px",j=d?"8px":"12px";G.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const F=document.createElement("div");F.textContent="Crosshair Transparency:",F.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const B=document.createElement("input");B.type="range",B.min="50",B.max="255",B.value=o.alpha.toString(),B.style.cssText="\n    width: 100%;\n    margin: 10px 0;\n  ";const L=document.createElement("div");L.textContent=`${Math.round(o.alpha/255*100)}%`,L.style.cssText="\n    text-align: center; \n    font-weight: 700; \n    font-size: 1.1em;\n    color: var(--slate-100);\n    margin-top: 8px;\n    letter-spacing: -0.025em;\n  ",B.oninput=()=>{const e=parseInt(B.value);L.textContent=`${Math.round(e/255*100)}%`,a.alpha=e,n(a,r)},G.appendChild(F),G.appendChild(B),G.appendChild(L);const J=document.createElement("div");J.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const A=document.createElement("div");A.textContent="Corner Borders:",A.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const V=document.createElement("div");V.textContent="Add subtle borders around corner pixels of the crosshair",V.style.cssText="\n    font-size: 0.9em; \n    margin-bottom: 16px; \n    color: var(--slate-300);\n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";const U=document.createElement("label");U.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    cursor: pointer;\n    user-select: none;\n  ";const H=document.createElement("input");H.type="checkbox",H.checked=r,H.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n    border-radius: 4px;\n  ";const W=document.createElement("span");W.textContent=r?"Enabled":"Disabled",W.style.cssText="\n    color: var(--slate-100); \n    font-weight: 700;\n    letter-spacing: -0.01em;\n  ",H.onchange=()=>{r=H.checked,n(a,r),W.style.background="",W.style.border="",W.style.padding="",W.style.borderRadius="",W.style.color=r?"#4caf50":"#f44336",W.textContent=r?"Enabled":"Disabled"},U.appendChild(H),U.appendChild(W),J.appendChild(A),J.appendChild(V),J.appendChild(U);const Y=document.createElement("div");Y.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const q=document.createElement("div");q.textContent="Crosshair Size:",q.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const X=document.createElement("div");X.textContent="Make crosshair 5x larger, extending beyond pixel boundaries",X.style.cssText="\n    font-size: 0.9em; \n    margin-bottom: 16px; \n    color: var(--slate-300);\n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";const K=document.createElement("label");K.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    cursor: pointer;\n    padding: 4px 0;\n    user-select: none;\n  ";let Q=rn();const Z=document.createElement("input");Z.type="checkbox",Z.checked=Q,Z.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n    border-radius: 4px;\n  ";const bn=document.createElement("span");bn.textContent=Q?"Enabled":"Disabled",bn.style.cssText="\n    font-size: 0.95em;\n    color: var(--slate-100);\n    font-weight: 700;\n    letter-spacing: -0.01em;\n  ",Z.onchange=()=>{Q=Z.checked,n(a,r,Q),bn.style.background="",bn.style.border="",bn.style.padding="",bn.style.borderRadius="",bn.style.color=Q?"#4caf50":"#f44336",bn.textContent=Q?"Enabled":"Disabled"},K.onclick=n=>{},K.appendChild(Z),K.appendChild(bn),H.onchange(),Z.onchange(),Y.appendChild(q),Y.appendChild(X),Y.appendChild(K);const fn=document.createElement("div");fn.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n    transition: opacity 0.3s ease, transform 0.3s ease;\n  `;const xn=document.createElement("div");xn.textContent="Crosshair Radius:",xn.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const vn=document.createElement("div");vn.textContent="Control how far the crosshair extends from the center pixel",vn.style.cssText="\n    font-size: 0.9em; \n    margin-bottom: 16px; \n    color: var(--slate-300);\n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";let wn=sn();const yn=document.createElement("div");yn.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 16px;\n    margin-bottom: 12px;\n  ";const kn=document.createElement("input");kn.type="range",kn.min="12",kn.max="32",kn.step="1",kn.value=wn,kn.style.cssText="\n    flex: 1;\n    height: 6px;\n    background: linear-gradient(90deg, var(--slate-600), var(--slate-500));\n    border-radius: 3px;\n    outline: none;\n    cursor: pointer;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n  ";const $n=document.createElement("style");$n.textContent='\n    input[type="range"]::-webkit-slider-thumb {\n      -webkit-appearance: none;\n      width: 18px;\n      height: 18px;\n      background: linear-gradient(135deg, var(--slate-300), var(--slate-400));\n      border-radius: 50%;\n      cursor: pointer;\n      border: 2px solid var(--slate-100);\n      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n    }\n    input[type="range"]::-moz-range-thumb {\n      width: 18px;\n      height: 18px;\n      background: linear-gradient(135deg, var(--slate-300), var(--slate-400));\n      border-radius: 50%;\n      cursor: pointer;\n      border: 2px solid var(--slate-100);\n      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n    }\n  ',document.head.appendChild($n);const Mn=document.createElement("div");Mn.textContent=wn,Mn.style.cssText="\n    font-size: 1em;\n    font-weight: 600;\n    color: var(--slate-100);\n    min-width: 32px;\n    text-align: center;\n    background: var(--slate-700);\n    padding: 6px 12px;\n    border-radius: 6px;\n    border: 1px solid var(--slate-600);\n  ",kn.oninput=()=>{wn=parseInt(kn.value),Mn.textContent=wn,n(a,r,Q)};const Sn=()=>{Q?(fn.style.opacity="1",fn.style.transform="translateY(0)",fn.style.pointerEvents="auto"):(fn.style.opacity="0.5",fn.style.transform="translateY(-10px)",fn.style.pointerEvents="none")},Cn=Z.onchange;Z.onchange=()=>{Cn(),Sn()},yn.appendChild(kn),yn.appendChild(Mn),fn.appendChild(xn),fn.appendChild(vn),fn.appendChild(yn),Sn();const Tn=document.createElement("div");Tn.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const zn=document.createElement("div");zn.textContent="Mini Progress Tracker:",zn.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const Nn=document.createElement("div");Nn.textContent="Show a compact progress tracker below the Color Filter button.",Nn.style.cssText="\n    font-size: 0.9em; \n    color: var(--slate-300); \n    margin-bottom: 16px; \n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";const On=document.createElement("div");On.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  ";const In=document.createElement("input");In.type="checkbox",In.checked=i,In.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n  ";const _n=document.createElement("span");_n.textContent=i?"Enabled":"Disabled",_n.style.cssText=`\n    color: ${i?"#4caf50":"#f44336"};\n    font-weight: bold;\n    cursor: pointer;\n  `;const Gn=()=>{i=In.checked,_n.textContent=i?"Enabled":"Disabled",_n.style.color=i?"#4caf50":"#f44336"};In.addEventListener("change",Gn),_n.onclick=n=>{n.stopPropagation(),In.checked=!In.checked,Gn()},On.style.cursor="default",On.appendChild(In),On.appendChild(_n),Tn.appendChild(zn),Tn.appendChild(Nn),Tn.appendChild(On);const En=document.createElement("div");En.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const Dn=document.createElement("div");Dn.textContent="📱 Mobile Mode:",Dn.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const jn=document.createElement("div");jn.textContent="Enable ultra-compact UI for mobile devices. Makes Color Filter extremely compact for better mobile experience.",jn.style.cssText="\n    font-size: 0.9em; \n    color: var(--slate-300); \n    margin-bottom: 16px; \n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";const Fn=document.createElement("div");Fn.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  ";const Bn=document.createElement("input");Bn.type="checkbox";const Ln=dn();Bn.checked=Ln,s=Ln,Bn.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n  ";const Jn=document.createElement("span");Jn.textContent=Ln?"Enabled":"Disabled",Jn.style.cssText=`\n    color: ${Ln?"#4caf50":"#f44336"};\n    font-weight: bold;\n    cursor: pointer;\n  `;const An=()=>{s=Bn.checked,Jn.textContent=s?"Enabled":"Disabled",Jn.style.color=s?"#4caf50":"#f44336"};Bn.addEventListener("change",An),Jn.onclick=n=>{n.stopPropagation(),Bn.checked=!Bn.checked,An()},Fn.style.cursor="default",Fn.appendChild(Bn),Fn.appendChild(Jn);const Vn=()=>{Jn.style.background="",Jn.style.border="",Jn.style.padding="",Jn.style.borderRadius="",Jn.style.color=s?"#4caf50":"#f44336",Jn.textContent=s?"Enabled":"Disabled"};Vn();const Pn=An,Rn=()=>{Pn(),Vn()};Bn.removeEventListener("change",An),Bn.addEventListener("change",Rn),Jn.onclick=n=>{n.stopPropagation(),Bn.checked=!Bn.checked,Rn()},En.appendChild(Dn),En.appendChild(jn),En.appendChild(Fn);const Un=document.createElement("div");Un.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const Hn=document.createElement("div");Hn.textContent="Collapse Mini Template:",Hn.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const Wn=document.createElement("div");Wn.textContent="Hide mini tracker when template section is collapsed.",Wn.style.cssText="\n    font-size: 0.9em; \n    color: var(--slate-300); \n    margin-bottom: 16px; \n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";let Yn=cn();const qn=document.createElement("div");qn.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  ";const Xn=document.createElement("input");Xn.type="checkbox",Xn.checked=Yn,Xn.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n  ";const Kn=document.createElement("span");Kn.textContent=Yn?"Enabled":"Disabled",Kn.style.cssText=`\n    color: ${Yn?"#4caf50":"#f44336"};\n    font-weight: bold;\n    cursor: pointer;\n  `;const Qn=()=>{Yn=Xn.checked,Kn.textContent=Yn?"Enabled":"Disabled",Kn.style.color=Yn?"#4caf50":"#f44336"};Xn.addEventListener("change",Qn),Kn.onclick=n=>{n.stopPropagation(),Xn.checked=!Xn.checked,Qn()},qn.style.cursor="default",qn.appendChild(Xn),qn.appendChild(Kn);const Zn=()=>{Kn.style.background="",Kn.style.border="",Kn.style.padding="",Kn.style.borderRadius="",Kn.style.color=Yn?"#4caf50":"#f44336",Kn.textContent=Yn?"Enabled":"Disabled"};Zn();const ne=Qn,ee=()=>{ne(),Zn()};Xn.removeEventListener("change",Qn),Xn.addEventListener("change",ee),Kn.onclick=n=>{n.stopPropagation(),Xn.checked=!Xn.checked,ee()},Un.appendChild(Hn),Un.appendChild(Wn),Un.appendChild(qn);const te=document.createElement("div"),oe=d?"10px 12px":"16px 20px";te.style.cssText=`\n    display: flex;\n    gap: 12px;\n    justify-content: center;\n    align-items: center;\n    padding: ${oe};\n    border-top: 1px solid var(--slate-700);\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    position: relative;\n    z-index: 1;\n    flex-shrink: 0;\n  `;const ae=document.createElement("div");ae.style.cssText="\n    display: flex;\n    gap: 12px;\n    width: 100%;\n    max-width: 400px;\n  ";const re=document.createElement("button");re.textContent="Cancel",re.style.cssText="\n    background: linear-gradient(135deg, var(--slate-600), var(--slate-700));\n    border: 1px solid var(--slate-500);\n    color: var(--slate-100);\n    padding: 14px 20px;\n    border-radius: 12px;\n    cursor: pointer;\n    font-size: 0.95em;\n    font-weight: 600;\n    flex: 1;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n  ",re.onmouseover=()=>{re.style.transform="translateY(-1px)",re.style.background="linear-gradient(135deg, var(--slate-500), var(--slate-600))",re.style.boxShadow="0 6px 20px rgba(71, 85, 105, 0.3)"},re.onmouseout=()=>{re.style.transform="",re.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",re.style.boxShadow=""},re.onclick=()=>{const n=tn(),e=an(),t=ln(),o=cn(),d=dn();JSON.stringify(a)!==JSON.stringify(n)||r!==e||Q!==rn()||wn!==sn()||i!==t||Yn!==o||s!==d||l!==pn()||Ce!==z()?confirm("Discard changes? Any unsaved settings will be lost.")&&(c.remove(),P.K("Crosshair settings cancelled - changes discarded")):c.remove()};const ie=document.createElement("button");ie.textContent="Apply Settings",ie.style.cssText="\n    background: linear-gradient(135deg, var(--blue-500), var(--blue-600));\n    border: 1px solid var(--blue-600);\n    color: white;\n    padding: 14px 20px;\n    border-radius: 12px;\n    cursor: pointer;\n    font-size: 0.95em;\n    font-weight: 700;\n    flex: 2;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n  ",ie.onmouseover=()=>{ie.style.transform="translateY(-1px)",ie.style.background="linear-gradient(135deg, var(--blue-600), var(--blue-700))",ie.style.boxShadow="0 6px 20px rgba(59, 130, 246, 0.4)"},ie.onmouseout=()=>{ie.style.transform="",ie.style.background="linear-gradient(135deg, var(--blue-500), var(--blue-600))",ie.style.boxShadow=""},ie.onclick=async()=>{const n=ie.style.background,e=ie.textContent;ie.style.background="linear-gradient(135deg, var(--emerald-500), var(--emerald-600))",ie.textContent="Applying...",ie.style.transform="scale(0.95)",ie.disabled=!0;try{on(a),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmCrosshairBorder",e),localStorage.setItem("bmCrosshairBorder",e)}catch(n){p("❌ Failed to save border setting:",n)}}(r),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmCrosshairEnhancedSize",e),localStorage.setItem("bmCrosshairEnhancedSize",e)}catch(n){p("❌ Failed to save enhanced size setting:",n)}}(Q),function(n){try{const e=Math.max(12,Math.min(32,n)),t=JSON.stringify(e);"undefined"!=typeof GM_setValue&&GM_setValue("bmCrosshairRadius",t),localStorage.setItem("bmCrosshairRadius",t)}catch(n){p("❌ Failed to save crosshair radius setting:",n)}}(wn),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmMiniTracker",e),localStorage.setItem("bmMiniTracker",e)}catch(n){p("❌ Failed to save mini tracker setting:",n)}}(i),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmCollapseMin",e),localStorage.setItem("bmCollapseMin",e)}catch(n){p("❌ Failed to save collapse mini template setting:",n)}}(Yn),function(n){try{const e=JSON.stringify(n);localStorage.setItem("bmMobileMode",e)}catch(n){p("❌ Failed to save mobile mode setting:",n)}}(s),function(n){try{const e=JSON.stringify(!!n);"undefined"!=typeof GM_setValue&&GM_setValue("bmShowLeftOnColor",e),localStorage.setItem("bmShowLeftOnColor",e),hn()}catch(n){p("❌ Failed to save Show Left-on-Color setting:",n)}}(l),function(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmNavigationMethod",e),localStorage.setItem("bmNavigationMethod",e)}catch(n){p("Failed to save navigation method setting:",n)}}(Ce),mn(s);try{nn(R.Be(0,!0))}catch(n){m("Failed to refresh palette left badges after apply:",n)}ie.style.background="linear-gradient(135deg, var(--emerald-600), var(--emerald-700))",ie.textContent="Applied! ✓",un(),gn(),R.Nn&&R.Nn.length>0&&R.Nn.forEach(n=>{n.xn&&n.xn()}),await en(),setTimeout(()=>{c.remove(),P.K(`Crosshair settings applied: ${a.name}, ${r?"with":"without"} borders, tracker ${i?"enabled":"disabled"}, collapse ${Yn?"enabled":"disabled"}, mobile ${s?"enabled":"disabled"}, Left-on-Color ${l?"enabled":"disabled"}!`)},800)}catch(t){ie.style.background="linear-gradient(135deg, #ef4444, #dc2626)",ie.textContent="Error! ✗",setTimeout(()=>{ie.style.background=n,ie.textContent=e,ie.style.transform="scale(1)",ie.disabled=!1},2e3),p("❌ Error applying crosshair settings:",t),P.X("Failed to apply crosshair settings")}},ae.appendChild(re),ae.appendChild(ie),te.appendChild(ae);const se=document.createElement("div"),le=d?"12px":"20px";se.style.cssText=`\n    overflow-y: auto;\n    flex: 1;\n    min-height: 0;\n    padding: ${le};\n    position: relative;\n    z-index: 1;\n  `,c.appendChild(b),se.appendChild(v),se.appendChild(k),se.appendChild(O),se.appendChild(G),se.appendChild(J);const ce=document.createElement("div");ce.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;`;const de=document.createElement("label");de.style.cssText="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;";const pe=document.createElement("input");pe.type="checkbox";try{pe.checked=JSON.parse(localStorage.getItem("bmShowUsername")??"true")}catch(n){pe.checked=!0}const me=document.createElement("span");me.textContent="Show Username in main window",me.style.cssText="color: var(--slate-200); font-weight:600;",pe.onchange=()=>{const n=!!pe.checked;localStorage.setItem("bmShowUsername",JSON.stringify(n));const e=document.getElementById("bm-F");e&&(e.style.display=n?"":"none")},de.appendChild(pe),de.appendChild(me),ce.appendChild(de),se.appendChild(ce),se.appendChild(Y),se.appendChild(fn),se.appendChild(Tn);const ue=document.createElement("div");ue.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const be=document.createElement("div");be.textContent="Display Left number on color cards:",be.style.cssText="\n    font-size: 1em; \n    margin-bottom: 12px; \n    color: var(--slate-200);\n    font-weight: 600;\n    letter-spacing: -0.01em;\n  ";const ge=document.createElement("div");ge.textContent="Displays just the remaining pixels number centered on each color.",ge.style.cssText="\n    font-size: 0.9em; \n    color: var(--slate-300); \n    margin-bottom: 16px; \n    line-height: 1.4;\n    letter-spacing: -0.005em;\n  ";const fe=document.createElement("div");fe.style.cssText="\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  ";const he=document.createElement("input");he.type="checkbox",he.checked=l,he.style.cssText="\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n  ";const xe=document.createElement("span");xe.textContent=l?"Enabled":"Disabled",xe.style.cssText=`\n    color: ${l?"#4caf50":"#f44336"};\n    font-weight: bold;\n    cursor: pointer;\n  `;const ve=()=>{l=he.checked,xe.textContent=l?"Enabled":"Disabled",xe.style.color=l?"#4caf50":"#f44336"};he.addEventListener("change",ve),xe.onclick=n=>{n.stopPropagation(),he.checked=!he.checked,ve()},fe.style.cursor="default",fe.appendChild(he),fe.appendChild(xe);const we=()=>{xe.style.background="",xe.style.border="",xe.style.padding="",xe.style.borderRadius="",xe.style.color=l?"#4caf50":"#f44336",xe.textContent=l?"Enabled":"Disabled"};we();const ye=ve,ke=()=>{ye(),we()};he.removeEventListener("change",ve),he.addEventListener("change",ke),xe.onclick=n=>{n.stopPropagation(),he.checked=!he.checked,ke()},ue.appendChild(be),ue.appendChild(ge),ue.appendChild(fe),se.appendChild(En),se.appendChild(ue),se.appendChild(Un);const $e=document.createElement("div");$e.style.cssText=`\n    background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n    border: 1px solid var(--slate-700);\n    border-radius: ${j};\n    padding: ${E};\n    margin-bottom: ${D};\n    position: relative;\n    z-index: 1;\n  `;const Me=document.createElement("h3");Me.textContent="Navigation Method",Me.style.cssText="\n    margin: 0 0 8px 0;\n    color: var(--slate-100);\n    font-size: 1em;\n    font-weight: 700;\n    letter-spacing: -0.01em;\n  ";const Se=document.createElement("p");Se.textContent="Choose how to navigate when clicking search results and favorites",Se.style.cssText="\n    margin: 0 0 16px 0;\n    color: var(--slate-400);\n    font-size: 0.85em;\n    line-height: 1.4;\n  ";let Ce=z();const Te=document.createElement("div");Te.style.cssText="\n    display: flex;\n    gap: 8px;\n    padding: 4px;\n    background: var(--slate-900);\n    border-radius: 8px;\n    border: 1px solid var(--slate-600);\n  ";const ze=document.createElement("button");ze.textContent="FlyTo",ze.style.cssText=`\n    flex: 1;\n    padding: 8px 12px;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 0.9em;\n    font-weight: 600;\n    transition: all 0.2s ease;\n    ${"flyto"===Ce?"background: linear-gradient(135deg, var(--blue-500), var(--blue-600)); color: white;":"background: transparent; color: var(--slate-300);"}\n  `;const Ne=document.createElement("button");Ne.textContent="OpenURL",Ne.style.cssText=`\n    flex: 1;\n    padding: 8px 12px;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 0.9em;\n    font-weight: 600;\n    transition: all 0.2s ease;\n    ${"openurl"===Ce?"background: linear-gradient(135deg, var(--blue-500), var(--blue-600)); color: white;":"background: transparent; color: var(--slate-300);"}\n  `,ze.onclick=()=>{Ce="flyto",ze.style.background="linear-gradient(135deg, var(--blue-500), var(--blue-600))",ze.style.color="white",Ne.style.background="transparent",Ne.style.color="var(--slate-300)"},Ne.onclick=()=>{Ce="openurl",Ne.style.background="linear-gradient(135deg, var(--blue-500), var(--blue-600))",Ne.style.color="white",ze.style.background="transparent",ze.style.color="var(--slate-300)"},Te.appendChild(ze),Te.appendChild(Ne),$e.appendChild(Me),$e.appendChild(Se),$e.appendChild(Te),se.appendChild($e),c.appendChild(se),c.appendChild(te),document.body.appendChild(c);let Oe=!1,Ie=0,_e=0,Ge=0,Ee=0;b.addEventListener("mousedown",n=>{Oe=!0,Ie=n.clientX,_e=n.clientY;const e=c.getBoundingClientRect();Ge=e.left,Ee=e.top,c.style.position="fixed",c.style.transform="none",c.style.left=Ge+"px",c.style.top=Ee+"px",n.preventDefault()}),document.addEventListener("mousemove",n=>{if(!Oe)return;const e=n.clientX-Ie,t=n.clientY-_e,o=Ge+e,a=Ee+t,r=window.innerWidth-c.offsetWidth,i=window.innerHeight-c.offsetHeight,s=Math.max(0,Math.min(o,r)),l=Math.max(0,Math.min(a,i));c.style.left=s+"px",c.style.top=l+"px"}),document.addEventListener("mouseup",()=>{Oe=!1})}catch(n){p("Failed to build Crosshair Settings overlay:",n),P.X("Failed to open Crosshair Settings")}}();const M=document.createElement("button");M.innerHTML="📋",M.title="Toggle between Grid and List view",M.style.cssText=`\n      background: linear-gradient(135deg, var(--slate-600), var(--slate-700));\n      border: 1px solid var(--slate-500);\n      color: var(--slate-200);\n      width: ${y};\n      height: ${y};\n      border-radius: 12px;\n      cursor: pointer;\n      font-size: ${k};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin-right: 12px;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      position: relative;\n      overflow: hidden;\n    `;let S="list"===localStorage.getItem("bmcf-view-preference");M.onmouseover=()=>{M.style.transform="translateY(-1px) scale(1.05)",M.style.background="linear-gradient(135deg, var(--slate-500), var(--slate-600))",M.style.boxShadow="0 6px 20px rgba(71, 85, 105, 0.3)"},M.onmouseout=()=>{M.style.transform="",M.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",M.style.boxShadow=""},M.addEventListener("touchstart",()=>{M.style.transform="",M.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",M.style.boxShadow=""},{passive:!0}),M.onclick=()=>{if(S=!S,localStorage.setItem("bmcf-view-preference",S?"list":"grid"),S?(vn.classList.add("list-mode"),M.innerHTML="⊞",M.title="Switch to Grid view"):(vn.classList.remove("list-mode"),M.innerHTML="📋",M.title="Switch to List view"),vn.offsetHeight,void 0!==J&&J.value&&yn(J.value),void 0!==E&&E.value.trim()){const n=E.value.toLowerCase().trim();(S?Array.from(xn.querySelectorAll("[data-color-item]")):Array.from(fn.querySelectorAll("[data-color-item]"))).forEach(e=>{e.getAttribute("data-color-name").toLowerCase().includes(n)?e.style.display="flex":e.style.display="none"})}};const C=document.createElement("button");C.innerHTML="📌",C.title="Toggle Compact Color List",C.style.cssText=`\n      background: linear-gradient(135deg, var(--slate-600), var(--slate-700));\n      border: 1px solid var(--slate-500);\n      color: var(--slate-200);\n      width: ${y};\n      height: ${y};\n      border-radius: 12px;\n      cursor: pointer;\n      font-size: ${k};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin-right: 12px;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      position: relative;\n      overflow: hidden;\n    `,C.onmouseover=()=>{C.style.transform="translateY(-1px) scale(1.05)",C.style.background="linear-gradient(135deg, var(--slate-500), var(--slate-600))",C.style.boxShadow="0 6px 20px rgba(71, 85, 105, 0.3)"},C.onmouseout=()=>{C.style.transform="",C.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",C.style.boxShadow=""},C.addEventListener("touchstart",()=>{C.style.transform="",C.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))",C.style.boxShadow=""},{passive:!0}),h.appendChild(x),h.appendChild(M),h.appendChild(C),h.appendChild($),h.appendChild(w),g.appendChild(f),g.appendChild(h);const T=document.createElement("div");T.style.cssText="\n      background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n      border: 1px solid var(--bmcf-border);\n      border-radius: 16px;\n      padding: 20px;\n      margin-bottom: 24px;\n      color: var(--bmcf-text);\n      text-align: center;\n      position: relative;\n      overflow: hidden;\n    ",T.innerHTML=`\n      <div style="\n        position: absolute; inset: 0; \n        background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1), transparent 50%),\n                    radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.08), transparent 50%);\n        pointer-events: none;\n      "></div>\n      <div style="position: relative; z-index: 1;">\n        <div style="\n          font-size: 1.2em; font-weight: 700; margin-bottom: 12px; \n          color: var(--bmcf-text);\n        ">\n          <span style="margin-right: 8px;">📊</span>\n          <span style="\n            background: linear-gradient(135deg, var(--blue-400), var(--emerald-400));\n            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;\n          ">Template Progress: ${c}%</span>\n        </div>\n        <div style="font-size: 0.95em; color: var(--bmcf-text-muted); margin-bottom: 16px; line-height: 1.5;">\n          ${d.toLocaleString()} / ${u.toLocaleString()} pixels painted\n          ${R.Ze()&&s>0?` (includes ${s.toLocaleString()} wrong)`:""}\n        </div>\n        <div style="\n          width: 100%; height: 12px; background: var(--slate-700); \n          border-radius: 8px; overflow: hidden; position: relative;\n          box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);\n        ">\n          <div style="\n            width: ${c}%; height: 100%; \n            background: linear-gradient(90deg, var(--blue-500), var(--emerald-500)); \n            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n            position: relative;\n          ">\n            <div style="\n              position: absolute; inset: 0; \n              background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);\n              animation: shimmer 2s infinite;\n            "></div>\n          </div>\n        </div>\n        <div style="\n          font-size: 0.85em; color: #fbbf24; margin-top: 12px; font-weight: 600;\n          text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n        ">\n          ${i.toLocaleString()} Pixels Remaining\n        </div>\n      </div>\n      <style>\n        @keyframes shimmer {\n          0% { transform: translateX(-100%); }\n          100% { transform: translateX(100%); }\n        }\n      </style>\n    `;const N=document.createElement("div");N.style.cssText="\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px 16px;\n      background: linear-gradient(135deg, var(--slate-800), var(--slate-750));\n      border-radius: 12px;\n      border: 1px solid var(--bmcf-border);\n      margin-bottom: 24px;\n      transition: all 0.2s ease;\n      cursor: pointer;\n    ",N.onmouseover=()=>{N.style.background="linear-gradient(135deg, var(--slate-750), var(--slate-700))",N.style.transform="translateY(-1px)"},N.onmouseout=()=>{N.style.background="linear-gradient(135deg, var(--slate-800), var(--slate-750))",N.style.transform=""};const O=document.createElement("input");O.type="checkbox",O.id="bm-5",O.checked=R.Ze(),O.style.cssText="\n      width: 18px;\n      height: 18px;\n      cursor: pointer;\n      accent-color: var(--blue-500);\n      border-radius: 4px;\n    ";const I=document.createElement("label");I.htmlFor="bm-5",I.textContent="Include Wrong Color Pixels in Progress",I.style.cssText="\n      color: var(--bmcf-text);\n      font-size: 0.95em;\n      font-weight: 500;\n      cursor: pointer;\n      user-select: none;\n      flex: 1;\n      letter-spacing: -0.01em;\n    ",O.addEventListener("change",async()=>{const n=O.checked;await R.Ke(n),P.K(`Include wrong colors in progress ${n?"enabled":"disabled"}!`),X()}),N.appendChild(O),N.appendChild(I);const _=document.createElement("p");_.textContent="Click on colors to toggle their visibility in the template.",_.style.cssText="\n      margin: 0 0 24px 0; \n      font-size: 0.95em; \n      color: var(--bmcf-text-muted); \n      text-align: center; \n      font-weight: 500;\n      letter-spacing: -0.01em;\n      line-height: 1.4;\n    ";const G=document.createElement("div");G.style.cssText="\n      margin: 0 0 24px 0;\n      position: relative;\n    ";const E=document.createElement("input");E.className="bmcf-input",E.type="text",E.id="bm-A",E.placeholder='Search colors by name or RGB (e.g., "red", "255,0,0")...',E.autocomplete="off",E.spellcheck=!1,E.style.cssText="\n      width: 100%;\n      padding: 14px 50px 14px 48px;\n      border: 1px solid var(--bmcf-border);\n      border-radius: 12px;\n      background: var(--slate-800);\n      color: var(--bmcf-text);\n      font-size: 0.95em;\n      font-weight: 400;\n      outline: none;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      box-sizing: border-box;\n      font-family: inherit;\n      -webkit-user-select: text;\n      -moz-user-select: text;\n      -ms-user-select: text;\n      user-select: text;\n      pointer-events: auto;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    ";const D=document.createElement("div");D.innerHTML="🔍",D.style.cssText="\n      position: absolute;\n      left: 16px;\n      top: 50%;\n      transform: translateY(-50%);\n      font-size: 1.2em;\n      pointer-events: none;\n      opacity: 0.6;\n    ";const j=document.createElement("button");j.innerHTML="✕",j.style.cssText="\n      position: absolute;\n      right: 16px;\n      top: 50%;\n      transform: translateY(-50%);\n      background: var(--slate-600);\n      border: 1px solid var(--slate-500);\n      border-radius: 8px;\n      color: var(--slate-300);\n      font-size: 12px;\n      font-weight: 600;\n      cursor: pointer;\n      padding: 0;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s ease;\n    ",j.onmouseover=()=>{j.style.background="var(--slate-500)",j.style.color="var(--slate-100)"},j.onmouseout=()=>{j.style.background="var(--slate-600)",j.style.color="var(--slate-300)"},G.appendChild(E),G.appendChild(D),G.appendChild(j);const F=n=>{const e=n.toLowerCase().trim(),t=fn.querySelectorAll("[data-color-item]"),o=xn.querySelectorAll("[data-color-item]");let a=0;(S?o:t).forEach(n=>{const t=n.getAttribute("data-color-name").toLowerCase(),o=n.getAttribute("data-color-rgb"),r=t.includes(e),i=o.includes(e),s=o.replace(/,/g," ").includes(e);""===e||r||i||s?(n.style.display="flex",a++):n.style.display="none"}),j.style.display=e?"flex":"none",e&&0===a?(E.style.borderColor="#ef4444",E.style.boxShadow="0 0 0 3px rgba(239, 68, 68, 0.2)"):(E.style.borderColor="var(--bmcf-border)",E.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)")};E.addEventListener("input",n=>{F(n.target.value)}),E.addEventListener("focus",()=>{E.style.borderColor="var(--blue-500)",E.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(59, 130, 246, 0.15)"}),E.addEventListener("blur",()=>{E.value||(E.style.borderColor="var(--bmcf-border)",E.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)")}),E.addEventListener("keydown",n=>{n.stopPropagation()}),E.addEventListener("keyup",n=>{n.stopPropagation()}),E.addEventListener("keypress",n=>{n.stopPropagation()}),j.addEventListener("click",()=>{E.value="",F(""),E.focus()});const B=document.createElement("div");B.style.cssText="\n      margin-bottom: 20px;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    ";const L=document.createElement("label");L.textContent="Sort by:",L.style.cssText="\n      color: white;\n      font-size: 0.9em;\n      font-weight: bold;\n      min-width: 60px;\n    ";const J=document.createElement("select");J.style.cssText="\n      flex: 1;\n      padding: 6px 14px;\n      border: 2px solid rgba(255, 255, 255, 0.2);\n      border-radius: 6px;\n      background: rgba(0, 0, 0, 0.3);\n      color: white;\n      font-size: 0.9em;\n      outline: none;\n      cursor: pointer;\n    ",[{value:"default",text:"Default Order"},{value:"premium",text:"Premium (Most Missing)"},{value:"enhanced",text:"Enhanced Colors Only"},{value:"wrong-desc",text:"Most Wrong Colors"},{value:"wrong-asc",text:"Least Wrong Colors"},{value:"missing-desc",text:"Most Pixels Missing"},{value:"missing-asc",text:"Least Pixels Missing"},{value:"total-desc",text:"Most Total Pixels"},{value:"total-asc",text:"Least Total Pixels"},{value:"percentage-desc",text:"Highest Completion %"},{value:"percentage-asc",text:"Lowest Completion %"},{value:"name-asc",text:"Name A-Z"},{value:"name-desc",text:"Name Z-A"}].forEach(n=>{const e=document.createElement("option");e.value=n.value,e.textContent=n.text,e.style.cssText="\n        background: #2a2a2a;\n        color: white;\n      ",J.appendChild(e)});let A=[],V=[];B.appendChild(L),B.appendChild(J);const U=document.createElement("div");U.style.cssText="\n      margin-bottom: 20px;\n    ";const H=document.createElement("div");H.textContent="Enhanced: Highlight the Pixels.",H.style.cssText="\n      background: #333;\n      color: white;\n      padding: 6px 14px;\n      border-radius: 6px;\n      font-size: 0.9em;\n      font-weight: bold;\n      text-align: center;\n      margin-bottom: 10px;\n    ";const W=document.createElement("div");W.style.cssText="\n      display: flex;\n      gap: 10px;\n      margin-bottom: 10px;\n    ";const Y=document.createElement("button");Y.textContent="Enable All",Y.style.cssText="\n      background: #4caf50;\n      border: none;\n      color: white;\n      padding: 8px 16px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 0.9em;\n      white-space: nowrap;\n      flex: 1;\n    ";const q=document.createElement("button");q.textContent="Disable All",q.style.cssText="\n      background: #f44336;\n      border: none;\n      color: white;\n      padding: 8px 16px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 0.9em;\n      white-space: nowrap;\n      flex: 1;\n    ";const K=document.createElement("button");K.textContent="Disable all Enhanced",K.style.cssText="\n      background: #6c757d;\n      color: white;\n      border: none;\n      padding: 6px 14px;\n      border-radius: 6px;\n      cursor: pointer;\n      width: 100%;\n      font-size: 0.9em;\n    ",W.appendChild(Y),W.appendChild(q),U.appendChild(H),U.appendChild(W),U.appendChild(K);const Q=document.createElement("div");Q.style.cssText="\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 6px 14px;\n      background: rgba(255, 255, 255, 0.1);\n      border-radius: 6px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      margin-top: 10px;\n    ";const Z=document.createElement("input");Z.type="checkbox",Z.id="bm-6",Z.checked=R.it(),Z.style.cssText="\n      width: 16px;\n      height: 16px;\n      cursor: pointer;\n    ";const bn=document.createElement("label");bn.htmlFor="bm-6",bn.textContent="Enhance Wrong Colors (Crosshair)",bn.style.cssText="\n      color: white;\n      font-size: 0.9em;\n      cursor: pointer;\n      user-select: none;\n      flex: 1;\n    ",Z.addEventListener("change",async()=>{const n=Z.checked;await R.nt(n),P.K(`Wrong colors crosshair ${n?"enabled":"disabled"}!`),window.forceTemplateRedraw&&window.forceTemplateRedraw()}),Q.appendChild(Z),Q.appendChild(bn),U.appendChild(Q);const fn=document.createElement("div");fn.className="bmcf-grid",fn.style.cssText="\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 20px;\n      justify-content: center;\n    ";const xn=document.createElement("div");xn.className="bmcf-list",xn.style.cssText="\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      margin-bottom: 20px;\n    ";const vn=document.createElement("div");vn.className="bmcf-view-container",vn.style.cssText="\n      position: relative;\n      width: 100%;\n    ",vn.appendChild(fn),vn.appendChild(xn);const wn=R.Nn[0];t.forEach((n,t)=>{let a=!1;const r=document.createElement("div");r.className="bmcf-card";const i=n.rgb,s=`${i[0]},${i[1]},${i[2]}`,l=n.free,c=wn.dn(i),d=!!wn.wn&&wn.wn(i);r.setAttribute("data-color-item","true"),r.setAttribute("data-color-name",n.name),r.setAttribute("data-color-rgb",i.join(",")),r.style.cssText=`\n        background: rgb(${i[0]}, ${i[1]}, ${i[2]});\n        border: 3px solid ${c?"#f44336":"#4caf50"};\n        border-radius: 8px;\n        padding: 6px 6px 14px 6px;\n        text-align: center;\n        transition: all 0.2s ease;\n        position: relative;\n        width: 100%;\n        height: 120px;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: flex-start;\n        box-sizing: border-box;\n        overflow: hidden;\n      `,e||(r.style.padding="12px 8px 16px 8px",r.style.justifyContent="center");const m=document.createElement("div");m.style.cssText="\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 2px;\n        width: 100%;\n        flex-shrink: 0;\n      ";const u=document.createElement("div");if(u.style.cssText="\n        width: 100%;\n        height: 20px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        position: relative;\n        flex-shrink: 0;\n      ",c){const n=document.createElement("div");n.style.cssText="\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(244, 67, 54, 0.3);\n          border-radius: 5px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          color: white;\n          font-weight: bold;\n          font-size: 16px;\n        ",n.textContent="✕",u.appendChild(n)}const b=document.createElement("div");b.className="bmcf-enhanced",b.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 2px;\n        font-size: 9px;\n        color: white;\n        text-shadow: 1px 1px 1px rgba(0,0,0,0.8);\n        font-weight: bold;\n        flex-shrink: 0;\n      ";const g=document.createElement("input");g.type="checkbox",g.checked=d,g.disabled=c,g.style.cssText="\n        width: 12px;\n        height: 12px;\n        cursor: pointer;\n      ";const f=document.createElement("label");f.textContent="Enhanced",f.style.cssText="\n        cursor: pointer;\n        user-select: none;\n      ",b.appendChild(g),b.appendChild(f),e||(b.style.marginTop="6px"),m.appendChild(u),m.appendChild(b),r.appendChild(m);const h=document.createElement("div");h.className="bmcf-color-name",h.textContent=n.name,h.style.cssText="\n        font-size: 0.75em;\n        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);\n        color: white;\n        font-weight: bold;\n        z-index: 1;\n        position: relative;\n        text-align: center;\n        margin-bottom: 6px;\n        flex-shrink: 0;\n        line-height: 1.1;\n      ";const x=document.createElement("div");x.textContent="💧",x.style.cssText="\n        font-size: 0.7em;\n        position: absolute;\n        bottom: 2px;\n        right: 4px;\n        z-index: 2;\n      ";const v=document.createElement("div");v.textContent="👁️",v.title="Click to exclude/include this color from progress calculation",v.style.cssText="\n        font-size: 0.8em;\n        position: absolute;\n        top: 4px;\n        left: 4px;\n        z-index: 3;\n        cursor: pointer;\n        opacity: 0.7;\n        transition: all 0.2s ease;\n        background: rgba(0,0,0,0.3);\n        border-radius: 50%;\n        width: 20px;\n        height: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ";const w=JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]"),y=JSON.parse(localStorage.getItem("bmcf-excluded-colors-pending")||JSON.stringify(w)).includes(s);y&&(v.textContent="🚫",v.style.opacity="1",v.style.background="rgba(244, 67, 54, 0.8)"),v.onmouseenter=()=>{v.style.opacity="1",v.style.transform="scale(1.1)"},v.onmouseleave=()=>{v.style.opacity=y?"1":"0.7",v.style.transform="scale(1)"},v.onclick=n=>{n.stopPropagation();const e=JSON.parse(localStorage.getItem("bmcf-excluded-colors-pending")||JSON.stringify(JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]")));if(e.includes(s)){const n=e.filter(n=>n!==s);localStorage.setItem("bmcf-excluded-colors-pending",JSON.stringify(n)),v.textContent="👁️",v.style.background="rgba(0,0,0,0.3)",v.style.opacity="0.7",A.textContent="👁️",A.style.background="rgba(0,0,0,0.3)",A.style.opacity="0.7"}else e.push(s),localStorage.setItem("bmcf-excluded-colors-pending",JSON.stringify(e)),v.textContent="🚫",v.style.background="rgba(244, 67, 54, 0.8)",v.style.opacity="1",A.textContent="🚫",A.style.background="rgba(244, 67, 54, 0.8)",A.style.opacity="1";void 0!==P&&P.K&&P.K(`Color ${e.includes(s)?"excluded from":"included in"} progress calculation - click Apply Colors to confirm`)};const k=o[s],$=document.createElement("div");if($.className="bmcf-stats",k&&k.Je>0){let n,e,t,o,a=0;if(R.Ln&&R.Ln.size>0){const n=new Set;if(R.Nn)for(const e of R.Nn){const t=`${e.Z} ${e.nn}`;R.ue(t)&&n.add(t)}for(const[e,t]of R.Ln.entries()){let o=!0;if(n.size>0){o=!1;const[t,a]=e.split(",").map(n=>parseInt(n));for(const e of R.Nn){const r=`${e.Z} ${e.nn}`;if(n.has(r)){if(e.en)for(const n of Object.keys(e.en)){const[e,r]=n.split(",").map(n=>parseInt(n));if(e===t&&r===a){o=!0;break}}if(o)break}}}o&&t.he&&t.he[s]&&(a+=t.he[s].xe||0)}}R.Ze()?(n=k.ye,e=k.Je,t=k.Ve||0,o=k.Ae):(n=k.ye,e=k.Je,t=k.Ve||0,o=k.Je-k.ye),r.setAttribute("data-wrong-count",a.toString()),r.setAttribute("data-missing-count",o.toString()),r.setAttribute("data-total-count",e.toString()),r.setAttribute("data-painted-count",n.toString());let i=`${n.toLocaleString()}/${e.toLocaleString()} (${t}%)`;R.Ze()&&a>0&&(i+=`\n+${a.toLocaleString()} wrong`),$.innerHTML=`\n          <div style="font-size: 0.6em; color: rgba(255,255,255,0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.8); line-height: 1.1;">\n            <div style="margin-bottom: 1px;">\n              ${i}\n            </div>\n            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">\n              ${o.toLocaleString()} Left\n            </div>\n          </div>\n        `;const l=document.createElement("div");l.style.cssText="\n          position: absolute;\n          left: 20px;\n          right: 20px;\n          bottom: 6px;\n          height: 4px;\n          background: rgba(255,255,255,0.25);\n          border-radius: 2px;\n          overflow: hidden;\n          pointer-events: none;\n          z-index: 1;\n        ";const c=document.createElement("div");c.style.cssText=`\n          width: ${Math.min(t,100)}%;\n          height: 100%;\n          background: linear-gradient(90deg, #4CAF50, #8BC34A, #CDDC39);\n          transition: width 0.3s ease;\n        `,l.appendChild(c),r.appendChild(l)}else $.innerHTML='\n          <div style="font-size: 0.65em; color: rgba(255,255,255,0.6); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">\n            Not Used\n          </div>\n        ';$.style.cssText="\n        z-index: 1;\n        position: relative;\n        padding: 4px 6px;\n        text-align: center;\n        flex-grow: 1;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        min-height: 0;\n      ",r.appendChild(h),r.appendChild($),l||r.appendChild(x),r.appendChild(v),u.onclick=n=>{if(n.stopPropagation(),!a){if(wn.dn(i)){wn.bn(i),r.style.border="3px solid #4caf50";const n=u.querySelector('div[style*="position: absolute"]');n&&n.remove(),g.disabled=!1,a=!0,M.style.border="2px solid #4caf50",M.style.opacity="1",L.disabled=!1,a=!1}else{wn.un(i),r.style.border="3px solid #f44336";const n=document.createElement("div");n.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(244, 67, 54, 0.3);\n            border-radius: 5px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 16px;\n          ",n.textContent="✕",u.appendChild(n),g.disabled=!0,g.checked=!1,a=!0,M.style.border="2px solid #f44336",M.style.opacity="0.7",L.disabled=!0,L.checked=!1,J.style.color="rgba(255,255,255,0.6)",a=!1}en().catch(n=>{p("Error refreshing template:",n)})}},g.onchange=n=>{n.stopPropagation(),g.checked?wn.hn(i):wn.vn(i),en().catch(n=>{p("Error refreshing enhanced mode:",n)})},f.onclick=n=>{n.stopPropagation(),g.disabled||(g.checked=!g.checked,g.onchange(n))},fn.appendChild(r);const M=document.createElement("div");M.className="bmcf-list-item",M.setAttribute("data-color-item","true"),M.setAttribute("data-color-name",n.name),M.setAttribute("data-color-rgb",i.join(",")),r.hasAttribute("data-wrong-count")&&(M.setAttribute("data-wrong-count",r.getAttribute("data-wrong-count")),M.setAttribute("data-missing-count",r.getAttribute("data-missing-count")),M.setAttribute("data-total-count",r.getAttribute("data-total-count")),M.setAttribute("data-painted-count",r.getAttribute("data-painted-count"))),M.style.cssText=`\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 8px 12px;\n        background: var(--slate-800);\n        border: 2px solid ${c?"#f44336":"#4caf50"};\n        border-radius: 10px;\n        position: relative;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n        min-height: 50px;\n        opacity: ${c?"0.7":"1"};\n      `;const S=document.createElement("div");S.style.cssText=`\n        width: 32px;\n        height: 32px;\n        background: rgb(${i[0]}, ${i[1]}, ${i[2]});\n        border-radius: 6px;\n        border: 2px solid rgba(255,255,255,0.3);\n        flex-shrink: 0;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n      `;const C=document.createElement("div");C.style.cssText="\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n        min-width: 0;\n      ";const T=document.createElement("div");T.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        cursor: pointer;\n        z-index: 1;\n      ";const z=document.createElement("div");z.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        font-size: 0.9em;\n        line-height: 1.2;\n      ";const N=document.createElement("div");N.textContent=n.name,N.style.cssText="\n        font-weight: 600;\n        color: var(--slate-100);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        max-width: 120px;\n        flex-shrink: 0;\n      ";let O="",I=0;const _=parseInt(M.getAttribute("data-total-count")||"0"),G=parseInt(M.getAttribute("data-painted-count")||"0"),E=parseInt(M.getAttribute("data-missing-count")||"0"),D=parseInt(M.getAttribute("data-wrong-count")||"0");if(_>0){const n=_>0?Math.round((_-E)/_*100):0;O=`${G.toLocaleString()}/${_.toLocaleString()} (${n}%)`,R.Ze()&&D>0&&(O+=` +${D.toLocaleString()} wrong`),I=E}else O="Not Used",I=0;const j=document.createElement("span");j.textContent=O,j.style.cssText="\n        color: var(--slate-300);\n        font-size: 0.8em;\n        white-space: nowrap;\n      ";const F=document.createElement("div");if(F.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        font-size: 0.75em;\n        margin-top: 2px;\n      ","Not Used"!==O){const n=document.createElement("span");n.textContent=`${I.toLocaleString()} Left`,n.style.cssText=`\n          color: ${0===I?"#10b981":"#f59e0b"}; // green if 0, orange if > 0\n          font-weight: 500;\n        `,F.appendChild(n)}z.appendChild(N),O&&z.appendChild(j),C.appendChild(z),"Not Used"!==O&&C.appendChild(F);const B=document.createElement("div");B.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        z-index: 2;\n        position: relative;\n      ";const L=document.createElement("input");L.type="checkbox",L.checked=d,L.disabled=c,L.style.cssText="\n        width: 16px;\n        height: 16px;\n        cursor: pointer;\n        accent-color: #ffd700;\n      ";const J=document.createElement("label");if(J.textContent="Enhanced",J.title="Enhanced mode - highlights this color on the canvas",J.style.cssText=`\n        font-size: 12px;\n        cursor: pointer;\n        color: ${d?"#ffd700":"rgba(255,255,255,0.6)"};\n        user-select: none;\n        transition: color 0.2s ease;\n        font-weight: 500;\n      `,J.onclick=n=>{n.stopPropagation(),L.disabled||(L.checked=!L.checked,L.onchange(n))},L.onchange=n=>{n.stopPropagation(),L.checked?(wn.hn(i),J.style.color="#ffd700",g.checked=!0):(wn.vn(i),J.style.color="rgba(255,255,255,0.6)",g.checked=!1),en().catch(n=>{p("Error refreshing enhanced mode:",n)})},!l){const e=document.createElement("div");e.innerHTML="💧",e.title="Click to select this color in the palette",e.style.cssText="\n          font-size: 16px;\n          cursor: pointer;\n          opacity: 0.7;\n          user-select: none;\n          transition: opacity 0.2s ease;\n        ",e.onmouseenter=()=>e.style.opacity="1",e.onmouseleave=()=>e.style.opacity="0.7",e.onclick=e=>{e.stopPropagation(),document.querySelectorAll('button[id^="color-"]').forEach(e=>{window.getComputedStyle(e).backgroundColor===`rgb(${i[0]}, ${i[1]}, ${i[2]})`&&(e.click(),void 0!==P&&P.K&&P.K(`Selected color: ${n.name}`))})},B.appendChild(e)}const A=document.createElement("div");A.textContent="👁️",A.title="Click to exclude/include this color from progress calculation",A.style.cssText="\n        font-size: 14px;\n        cursor: pointer;\n        opacity: 0.7;\n        transition: all 0.2s ease;\n        background: rgba(0,0,0,0.3);\n        border-radius: 50%;\n        width: 18px;\n        height: 18px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ";const V=JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]"),U=JSON.parse(localStorage.getItem("bmcf-excluded-colors-pending")||JSON.stringify(V)).includes(s);U&&(A.textContent="🚫",A.style.opacity="1",A.style.background="rgba(244, 67, 54, 0.8)"),A.onmouseenter=()=>{A.style.opacity="1",A.style.transform="scale(1.1)"},A.onmouseleave=()=>{A.style.opacity=U?"1":"0.7",A.style.transform="scale(1)"},A.onclick=n=>{n.stopPropagation();const e=JSON.parse(localStorage.getItem("bmcf-excluded-colors-pending")||JSON.stringify(JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]")));if(e.includes(s)){const n=e.filter(n=>n!==s);localStorage.setItem("bmcf-excluded-colors-pending",JSON.stringify(n)),A.textContent="👁️",A.style.background="rgba(0,0,0,0.3)",A.style.opacity="0.7",v.textContent="👁️",v.style.background="rgba(0,0,0,0.3)",v.style.opacity="0.7"}else e.push(s),localStorage.setItem("bmcf-excluded-colors-pending",JSON.stringify(e)),A.textContent="🚫",A.style.background="rgba(244, 67, 54, 0.8)",A.style.opacity="1",v.textContent="🚫",v.style.background="rgba(244, 67, 54, 0.8)",v.style.opacity="1";void 0!==P&&P.K&&P.K(`Color ${e.includes(s)?"excluded from":"included in"} progress calculation - click Apply Colors to confirm`)},B.appendChild(A),B.appendChild(L),B.appendChild(J),M.appendChild(S),M.appendChild(C),M.appendChild(B),M.appendChild(T),T.onclick=n=>{if(n.stopPropagation(),!a){if(wn.dn(i)){wn.bn(i),M.style.border="2px solid #4caf50",M.style.opacity="1",L.disabled=!1,a=!0,r.style.border="3px solid #4caf50";const n=u.querySelector('div[style*="position: absolute"]');n&&n.remove(),g.disabled=!1,a=!1}else{wn.un(i),M.style.border="2px solid #f44336",M.style.opacity="0.7",L.disabled=!0,L.checked=!1,J.style.color="rgba(255,255,255,0.6)",a=!0,r.style.border="3px solid #f44336";const n=document.createElement("div");n.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(244, 67, 54, 0.3);\n            border-radius: 5px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 16px;\n          ",n.textContent="✕",u.appendChild(n),g.disabled=!0,g.checked=!1,a=!1}en().catch(n=>{p("Error refreshing template:",n)})}},xn.appendChild(M)}),A=Array.from(fn.querySelectorAll("[data-color-item]")),V=Array.from(xn.querySelectorAll("[data-color-item]"));const yn=n=>{const e=Array.from(fn.querySelectorAll("[data-color-item]")),o=Array.from(xn.querySelectorAll("[data-color-item]")),a=S?o:e;if("default"===n){a.forEach(n=>{n.style.display="flex"});const n=S?xn:fn;return void(S?V:A).forEach(e=>{n.appendChild(e)})}if("enhanced"===n)return void a.forEach(n=>{const e=n.querySelector('input[type="checkbox"]');e&&e.checked?n.style.display="flex":n.style.display="none"});a.forEach(n=>{n.style.display="flex"}),a.sort((e,o)=>{const a=parseInt(e.getAttribute("data-wrong-count")||"0"),r=parseInt(o.getAttribute("data-wrong-count")||"0"),i=parseInt(e.getAttribute("data-missing-count")||"0"),s=parseInt(o.getAttribute("data-missing-count")||"0"),l=parseInt(e.getAttribute("data-total-count")||"0"),c=parseInt(o.getAttribute("data-total-count")||"0"),d=e.getAttribute("data-color-name")||"",p=o.getAttribute("data-color-name")||"",m=l>0?(l-i)/l*100:0,u=c>0?(c-s)/c*100:0;switch(n){case"premium":const n=e.getAttribute("data-color-rgb"),b=o.getAttribute("data-color-rgb"),g=t.find(e=>`${e.rgb[0]},${e.rgb[1]},${e.rgb[2]}`===n),f=t.find(n=>`${n.rgb[0]},${n.rgb[1]},${n.rgb[2]}`===b),h=g&&!1===g.free,x=f&&!1===f.free;return h&&!x?-1:!h&&x?1:s-i;case"wrong-desc":return r-a;case"wrong-asc":return a-r;case"missing-desc":return s-i;case"missing-asc":return i-s;case"total-desc":return c-l;case"total-asc":return l-c;case"percentage-desc":return u-m;case"percentage-asc":return m-u;case"name-asc":return d.localeCompare(p);case"name-desc":return p.localeCompare(d);default:return 0}});const r=S?xn:fn;a.forEach(n=>{r.appendChild(n)})};J.addEventListener("change",()=>{yn(J.value)}),Y.onclick=async()=>{t.forEach(n=>{wn.bn(n.rgb)}),b.remove(),P.K("Enabling all colors...");try{await en(),X()}catch(n){p("Error enabling all colors:",n),P.X("Failed to enable all colors")}},q.onclick=async()=>{t.forEach(n=>{wn.un(n.rgb)}),b.remove(),P.K("Disabling all colors...");try{await en(),X()}catch(n){p("Error disabling all colors:",n),P.X("Failed to disable all colors")}},K.onclick=async()=>{const n=K.style.background,e=K.textContent;K.style.background="#dc3545",K.textContent="Disabling...",K.style.transform="scale(0.95)",K.style.transition="all 0.1s ease";try{const t=R.Nn?.[0];t&&t.enhancedColors&&t.enhancedColors.size>0?(t.enhancedColors.clear(),K.style.background="#28a745",K.textContent="Disabled! ✓",await en(),X(),setTimeout(()=>{K.style.background=n,K.textContent=e,K.style.transform="scale(1)"},100)):(K.style.background="#ffc107",K.textContent="No Enhanced Colors",setTimeout(()=>{K.style.background=n,K.textContent=e,K.style.transform="scale(1)"},100))}catch(t){K.style.background="#dc3545",K.textContent="Error! ✗",setTimeout(()=>{K.style.background=n,K.textContent=e,K.style.transform="scale(1)"},100),p("Error disabling all enhanced colors:",t),P.X("Failed to disable all enhanced colors")}};const kn=document.createElement("div");kn.className="bmcf-footer";const $n=document.createElement("button");$n.innerHTML="🔄 Update Stats",$n.className="bmcf-btn success",$n.onmouseover=()=>{$n.style.transform="translateY(-2px)",$n.style.boxShadow="0 4px 15px rgba(76, 175, 80, 0.5)"},$n.onmouseout=()=>{$n.style.transform="translateY(0)",$n.style.boxShadow="0 2px 8px rgba(76, 175, 80, 0.3)"};const Mn=document.createElement("button");Mn.innerHTML="🎯 Apply Colors",Mn.className="bmcf-btn primary",Mn.onmouseover=()=>{Mn.style.transform="translateY(-2px)",Mn.style.boxShadow="0 4px 15px rgba(33, 150, 243, 0.5)"},Mn.onmouseout=()=>{Mn.style.transform="translateY(0)",Mn.style.boxShadow="0 2px 8px rgba(33, 150, 243, 0.3)"},$n.onclick=()=>{const n=localStorage.getItem("bmcf-excluded-colors-pending");n&&(localStorage.setItem("bmcf-excluded-colors",n),localStorage.removeItem("bmcf-excluded-colors-pending")),un(),X()},Mn.onclick=async()=>{const n=localStorage.getItem("bmcf-excluded-colors-pending");n&&(localStorage.setItem("bmcf-excluded-colors",n),localStorage.removeItem("bmcf-excluded-colors-pending")),b.remove(),P.K("Applying color filter...");try{un(),await en(),P.K("Color filter applied successfully!")}catch(n){p("Error applying color filter:",n),P.X("Failed to apply color filter")}};const Sn=document.createElement("div");Sn.style.cssText="\n      overflow-y: auto;\n      flex: 1;\n      min-height: 0;\n      padding: 20px;\n    ",kn.appendChild($n),kn.appendChild(Mn),b.appendChild(g),Sn.appendChild(T),Sn.appendChild(N),Sn.appendChild(_),Sn.appendChild(U),Sn.appendChild(G),Sn.appendChild(B),Sn.appendChild(vn);let Cn=document.getElementById("bmcf-compact-list");if(!Cn){Cn=document.createElement("div"),Cn.id="bmcf-compact-list",Cn.style.cssText="\n      display: none;\n      position: fixed;\n      top: 100px;\n      right: 20px;\n      width: 220px;\n      background: var(--slate-800);\n      border: 1px solid var(--bmcf-border);\n      border-radius: 12px;\n      box-shadow: 0 10px 30px rgba(0,0,0,0.6);\n      z-index: 999999;\n      font-family: Inter, system-ui, sans-serif;\n      flex-direction: column;\n      min-height: auto;\n      max-height: none;\n    ",Cn.setAttribute("data-flex-layout","true");const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 8px 12px;\n      background: var(--slate-700);\n      border-bottom: 1px solid var(--bmcf-border);\n      border-radius: 12px 12px 0 0;\n      transition: border-radius 0.3s ease, border-bottom 0.3s ease;\n    ";const t=document.createElement("div");t.style.cssText="\n      display: flex;\n      align-items: center;\n      gap: 6px;\n    ";const a=document.createElement("span");a.innerHTML="▼",a.style.cssText="\n      font-size: 10px;\n      color: var(--bmcf-text-muted);\n      transition: transform 0.2s ease;\n      user-select: none;\n      cursor: pointer;\n      padding: 2px 4px;\n      border-radius: 3px;\n    ",a.addEventListener("mouseenter",()=>{a.style.background="var(--slate-600)"}),a.addEventListener("mouseleave",()=>{a.style.background="none"});const r=document.createElement("span");r.textContent="Color Toggle",r.style.cssText="\n      font-size: 12px;\n      font-weight: 600;\n      color: var(--bmcf-text);\n      user-select: none;\n      cursor: default;\n    ",t.appendChild(a),t.appendChild(r);const i=document.createElement("button");i.innerHTML="✕",i.title="Close",i.style.cssText="\n      background: none;\n      border: none;\n      color: var(--bmcf-text-muted);\n      cursor: pointer;\n      font-size: 14px;\n      padding: 2px 6px;\n      border-radius: 4px;\n      transition: all 0.15s ease;\n    ",i.onmouseover=()=>i.style.background="var(--slate-600)",i.onmouseout=()=>i.style.background="none",i.onclick=()=>{Cn.style.display="none",C.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))"},e.appendChild(t),e.appendChild(i),Cn.appendChild(e);const s=document.createElement("div");s.style.cssText="\n      display: block;\n      transition: height 0.3s ease, opacity 0.2s ease;\n      overflow: hidden;\n      border-radius: 0 0 12px 12px;\n      position: relative;\n      z-index: 1;\n    ",Cn.appendChild(s);const l="bmcf-compact-collapsed";let c="true"===localStorage.getItem(l);c?(s.style.height="0px",s.style.opacity="0",s.style.pointerEvents="none",a.style.transform="rotate(-90deg)",e.style.borderRadius="12px",e.style.borderBottom="none"):(s.style.height="auto",s.style.opacity="1",s.style.pointerEvents="auto",e.style.borderRadius="12px 12px 0 0",e.style.borderBottom="1px solid var(--bmcf-border)"),a.addEventListener("click",n=>{if(n.stopPropagation(),c=!c,localStorage.setItem(l,c.toString()),c){s.style.height="auto";const n=s.offsetHeight;s.style.height=n+"px",s.offsetHeight,requestAnimationFrame(()=>{s.style.height="0px",s.style.opacity="0",s.style.pointerEvents="none",a.style.transform="rotate(-90deg)",e.style.borderRadius="12px",e.style.borderBottom="none"})}else{s.style.pointerEvents="auto",s.style.opacity="1";const n=s.style.height;s.style.height="auto";const t=s.offsetHeight;s.style.height=n,s.offsetHeight,s.style.height=t+"px",a.style.transform="rotate(0deg)",e.style.borderRadius="12px 12px 0 0",e.style.borderBottom="1px solid var(--bmcf-border)",setTimeout(()=>{c||(s.style.height="auto")},300)}});const d=document.createElement("div");d.style.cssText="\n      padding: 6px 12px;\n      background: var(--slate-700);\n      border-bottom: 1px solid var(--bmcf-border);\n      display: flex;\n      align-items: center;\n      gap: 6px;\n    ";const m=document.createElement("input");m.type="text",m.placeholder="Search colors...",m.style.cssText="\n      flex: 1;\n      padding: 4px 8px;\n      background: var(--slate-600);\n      border: 1px solid var(--slate-500);\n      border-radius: 4px;\n      color: var(--bmcf-text);\n      font-size: 11px;\n      height: 24px;\n      outline: none;\n      transition: all 0.2s ease;\n    ",m.addEventListener("focus",()=>{m.style.borderColor="var(--blue-400)",m.style.background="var(--slate-550)"}),m.addEventListener("blur",()=>{m.style.borderColor="var(--slate-500)",m.style.background="var(--slate-600)"});const u=document.createElement("button");u.innerHTML="✕",u.title="Clear search",u.style.cssText="\n      background: none;\n      border: none;\n      color: var(--bmcf-text-muted);\n      cursor: pointer;\n      font-size: 10px;\n      padding: 2px;\n      border-radius: 3px;\n      width: 20px;\n      height: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.15s ease;\n      opacity: 0.7;\n    ",u.addEventListener("mouseenter",()=>{u.style.background="var(--slate-600)",u.style.opacity="1"}),u.addEventListener("mouseleave",()=>{u.style.background="none",u.style.opacity="0.7"}),u.addEventListener("click",()=>{m.value="",m.dispatchEvent(new Event("input")),m.focus()}),d.appendChild(m),d.appendChild(u),s.appendChild(d);const b=document.createElement("div");b.style.cssText="\n      padding: 3px 8px;\n      background: var(--slate-700);\n      border-bottom: 1px solid var(--bmcf-border);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 4px;\n    ";const g=document.createElement("button");g.textContent="Disable",g.style.cssText="\n      background: #dc2626;\n      color: white;\n      border: none;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-weight: 500;\n    ",g.addEventListener("mouseenter",()=>g.style.background="#b91c1c"),g.addEventListener("mouseleave",()=>g.style.background="#dc2626");const f=document.createElement("button");f.textContent="Enable",f.style.cssText="\n      background: #16a34a;\n      color: white;\n      border: none;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-weight: 500;\n    ",f.addEventListener("mouseenter",()=>f.style.background="#15803d"),f.addEventListener("mouseleave",()=>f.style.background="#16a34a"),g.addEventListener("click",()=>{const n=R.Nn?.[0];n&&w.querySelectorAll(".bmcf-compact-item").forEach(e=>{const t=e.getAttribute("data-color-rgb");if(t){const[o,a,r]=t.split(",").map(Number);n.dn([o,a,r])||(n.un([o,a,r]),e.style.opacity="0.5",e.style.background="rgba(244, 67, 54, 0.1)")}})}),f.addEventListener("click",()=>{const n=R.Nn?.[0];n&&w.querySelectorAll(".bmcf-compact-item").forEach(e=>{const t=e.getAttribute("data-color-rgb");if(t){const[o,a,r]=t.split(",").map(Number);n.dn([o,a,r])&&(n.bn([o,a,r]),e.style.opacity="1",e.style.background="")}})}),b.appendChild(g),b.appendChild(f),s.appendChild(b);const h=document.createElement("div");h.style.cssText="\n      padding: 8px 12px;\n      background: var(--slate-700);\n      border-bottom: 1px solid var(--bmcf-border);\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    ";const x=document.createElement("span");x.textContent="Sort:",x.style.cssText="\n      font-size: 11px;\n      color: var(--bmcf-text-muted);\n      min-width: 30px;\n    ";const v=document.createElement("select");v.style.cssText="\n      flex: 1;\n      padding: 4px 8px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 4px;\n      background: rgba(0, 0, 0, 0.3);\n      color: white;\n      font-size: 10px;\n      outline: none;\n      cursor: pointer;\n    ",[{value:"default",text:"Default Order"},{value:"name",text:"By Name"},{value:"premium",text:"Premium (Most Missing)"},{value:"most-missing",text:"Most Pixels Missing"},{value:"less-missing",text:"Less Pixels Missing"},{value:"remaining",text:"By Remaining"},{value:"progress",text:"By Progress"},{value:"most-painted",text:"Most Painted"},{value:"less-painted",text:"Less Painted"},{value:"enhanced",text:"Enhanced Only"}].forEach(n=>{const e=document.createElement("option");e.value=n.value,e.textContent=n.text,e.style.cssText="\n        background: #2a2a2a;\n        color: white;\n      ",v.appendChild(e)}),h.appendChild(x),h.appendChild(v),s.appendChild(h);const w=document.createElement("div");w.style.cssText="\n      overflow-y: auto;\n      max-height: 300px;\n      min-height: 0;\n    ",s.appendChild(w);let y=!1,k=0,$=0,M=0,S=0;e.style.cursor="move",e.addEventListener("mousedown",n=>{if(n.target===i||n.target===a)return;y=!0,k=n.clientX,$=n.clientY;const t=Cn.getBoundingClientRect();M=t.left,S=t.top,e.style.cursor="grabbing",Cn.style.userSelect="none",document.body.style.userSelect="none",n.preventDefault()}),document.addEventListener("mousemove",n=>{if(!y)return;const e=n.clientX-k,t=n.clientY-$,o=M+e,a=S+t,r=window.innerWidth-Cn.offsetWidth,i=window.innerHeight-Cn.offsetHeight;Cn.style.left=Math.max(0,Math.min(r,o))+"px",Cn.style.top=Math.max(0,Math.min(i,a))+"px",Cn.style.right="auto"}),document.addEventListener("mouseup",()=>{y&&(y=!1,e.style.cursor="move",Cn.style.userSelect="",document.body.style.userSelect="")}),e.addEventListener("touchstart",n=>{if(n.target===i)return;const e=n.touches[0];y=!0,k=e.clientX,$=e.clientY;const t=Cn.getBoundingClientRect();M=t.left,S=t.top,Cn.style.userSelect="none",n.preventDefault()},{passive:!1}),document.addEventListener("touchmove",n=>{if(!y)return;const e=n.touches[0],t=e.clientX-k,o=e.clientY-$,a=M+t,r=S+o,i=window.innerWidth-Cn.offsetWidth,s=window.innerHeight-Cn.offsetHeight;Cn.style.left=Math.max(0,Math.min(i,a))+"px",Cn.style.top=Math.max(0,Math.min(s,r))+"px",Cn.style.right="auto"},{passive:!1}),document.addEventListener("touchend",()=>{y&&(y=!1,Cn.style.userSelect="")});const T=e=>{const t=[...N];switch(e){case"name":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=n.querySelector(".bmcf-compact-name div").textContent.toLowerCase(),o=e.querySelector(".bmcf-compact-name div").textContent.toLowerCase();return t.localeCompare(o)});break;case"premium":t.forEach(n=>{n.style.display="flex"}),t.sort((e,t)=>{const o=e.getAttribute("data-color-rgb"),a=t.getAttribute("data-color-rgb"),r=n.l.find(n=>"Transparent"!==n.name&&`${n.rgb[0]},${n.rgb[1]},${n.rgb[2]}`===o),i=n.l.find(n=>"Transparent"!==n.name&&`${n.rgb[0]},${n.rgb[1]},${n.rgb[2]}`===a),s=r&&!1===r.free,l=i&&!1===i.free;if(s&&!l)return-1;if(!s&&l)return 1;const c=parseInt(e.getAttribute("data-remaining")||"0"),d=parseInt(t.getAttribute("data-remaining")||"0"),p=parseInt(e.getAttribute("data-total")||"0"),m=parseInt(t.getAttribute("data-total")||"0");return 0===p&&m>0?1:0===m&&p>0?-1:0===p&&0===m?0:d-c});break;case"most-missing":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseInt(n.getAttribute("data-remaining")||"0"),o=parseInt(e.getAttribute("data-remaining")||"0"),a=parseInt(n.getAttribute("data-total")||"0"),r=parseInt(e.getAttribute("data-total")||"0");return 0===a&&r>0?1:0===r&&a>0?-1:0===a&&0===r?0:o-t});break;case"less-missing":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseInt(n.getAttribute("data-remaining")||"0"),o=parseInt(e.getAttribute("data-remaining")||"0"),a=parseInt(n.getAttribute("data-total")||"0"),r=parseInt(e.getAttribute("data-total")||"0");return 0===a&&r>0?1:0===r&&a>0?-1:0===a&&0===r?0:t-o});break;case"remaining":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseInt(n.getAttribute("data-remaining")||"0");return parseInt(e.getAttribute("data-remaining")||"0")-t});break;case"progress":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseFloat(n.getAttribute("data-progress")||"0");return parseFloat(e.getAttribute("data-progress")||"0")-t});break;case"most-painted":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseInt(n.getAttribute("data-painted")||"0");return parseInt(e.getAttribute("data-painted")||"0")-t});break;case"less-painted":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=parseInt(n.getAttribute("data-painted")||"0"),o=parseInt(e.getAttribute("data-painted")||"0"),a=parseInt(n.getAttribute("data-total")||"0"),r=parseInt(e.getAttribute("data-total")||"0");return 0===a&&r>0?1:0===r&&a>0?-1:0===a&&0===r?0:t-o});break;case"enhanced":t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>{const t=n.querySelector('input[type="checkbox"]').checked,o=e.querySelector('input[type="checkbox"]').checked;return t&&!o?-1:!t&&o?1:0}),t.forEach(n=>{const e=n.querySelector('input[type="checkbox"]').checked;n.style.display=e?"flex":"none"});break;case"default":default:t.forEach(n=>{n.style.display="flex"}),t.sort((n,e)=>parseInt(n.getAttribute("data-original-index")||"0")-parseInt(e.getAttribute("data-original-index")||"0"));break}w.innerHTML="",t.forEach(n=>{w.appendChild(n)})};v.addEventListener("change",()=>{T(v.value),localStorage.setItem("bmcf-compact-sort",v.value)});const z=localStorage.getItem("bmcf-compact-sort")||"default";v.value=z;let N=[];n.l.forEach((n,e)=>{const t=`${n.rgb[0]},${n.rgb[1]},${n.rgb[2]}`;if(0===e)return;const a=o[t]||{},r=R.Nn?.[0],i=!!r&&r.dn(n.rgb),s=a.ye||0,l=a.Ae||0,c=s+l,d=c>0?Math.round(s/c*100):0,m=document.createElement("div");m.className="bmcf-compact-item",m.setAttribute("data-color-rgb",t),m.setAttribute("data-original-index",e.toString()),m.setAttribute("data-remaining",l.toString()),m.setAttribute("data-painted",s.toString()),m.setAttribute("data-total",c.toString()),m.setAttribute("data-progress",d.toString()),m.style.cssText=`\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        padding: 4px 8px;\n        border-bottom: 1px solid var(--slate-700);\n        cursor: pointer;\n        transition: background-color 0.15s ease;\n        min-height: 32px;\n        ${i?"opacity: 0.5; background: rgba(244, 67, 54, 0.1);":""}\n      `,m.onmouseover=()=>m.style.backgroundColor="var(--slate-700)",m.onmouseout=()=>m.style.backgroundColor="";const u=document.createElement("div");u.style.cssText=`\n        width: 14px;\n        height: 14px;\n        border-radius: 2px;\n        background: rgb(${n.rgb.join(",")});\n        border: 1px solid rgba(255,255,255,0.2);\n        flex-shrink: 0;\n      `;const b=document.createElement("div");b.className="bmcf-compact-name",b.style.cssText="\n        font-size: 10px;\n        color: var(--bmcf-text);\n        flex: 1;\n        min-width: 0;\n        overflow: hidden;\n      ",b.innerHTML=`\n        <div style="font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.name}</div>\n        <div style="font-size: 8px; color: var(--bmcf-text-muted); opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n          ${s.toLocaleString()}/${c.toLocaleString()} (${d}%) | ${l.toLocaleString()} left\n        </div>\n      `;const g=document.createElement("div");g.style.cssText="\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        flex-shrink: 0;\n      ";const f=document.createElement("input");if(f.type="checkbox",f.style.cssText="\n        width: 12px;\n        height: 12px;\n        cursor: pointer;\n      ",f.title="Enable enhanced mode for this color",r&&r.enhancedColors){const e=n.rgb.join(",");f.checked=r.enhancedColors.has(e)}f.onclick=n=>{n.stopPropagation()},f.onchange=e=>{e.stopPropagation();const o=R.Nn?.[0];if(!o)return;f.checked?(o.hn(n.rgb),P.K(`Enhanced mode enabled: ${n.name}`)):(o.vn(n.rgb),P.K(`Enhanced mode disabled: ${n.name}`));const a=vn.querySelector(`[data-color-rgb="${t}"]`),r=vn.querySelector(`[data-color-rgb="${t}"].bmcf-list-item`);if(a){const n=a.querySelector('input[type="checkbox"]');n&&(n.checked=f.checked)}if(r){const n=r.querySelector('input[type="checkbox"]');n&&(n.checked=f.checked)}en().catch(n=>{p("Error refreshing enhanced mode from Color Toggle:",n)})};const h=document.createElement("div");n.free?h.style.cssText="\n          width: 14px;\n          height: 14px;\n          flex-shrink: 0;\n        ":(h.textContent="💧",h.title="Premium color",h.style.cssText="\n          width: 14px;\n          height: 14px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 10px;\n          opacity: 0.8;\n          flex-shrink: 0;\n        "),g.appendChild(h),g.appendChild(f),m.onclick=e=>{e.stopPropagation();const o=R.Nn?.[0];if(!o)return void P.K("No template loaded");const a=n.rgb,r=o.dn(a),i=vn.querySelector(`[data-color-rgb="${t}"]`),s=vn.querySelector(`[data-color-rgb="${t}"].bmcf-list-item`);if(r){if(o.bn(a),i){i.style.border="3px solid #4caf50";const n=i.querySelector('div[style*="position: absolute"]');n&&n.remove();const e=i.querySelector('input[type="checkbox"]');e&&(e.disabled=!1)}if(s){s.style.border="2px solid #4caf50",s.style.opacity="1";const n=s.querySelector('input[type="checkbox"]');n&&(n.disabled=!1)}m.style.opacity="1",m.style.background="",P.K(`Color enabled: ${n.name}`)}else{if(o.un(a),i){i.style.border="3px solid #f44336";const n=i.querySelector('[style*="cursor: pointer"]');if(n&&!n.querySelector('div[style*="position: absolute"]')){const e=document.createElement("div");e.style.cssText="\n                position: absolute; top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center;\n                font-size: 24px; color: #f44336; pointer-events: none;\n              ",e.textContent="✕",n.appendChild(e)}const e=i.querySelector('input[type="checkbox"]');e&&(e.disabled=!0)}if(s){s.style.border="2px solid #f44336",s.style.opacity="0.5";const n=s.querySelector('input[type="checkbox"]');n&&(n.disabled=!0)}m.style.opacity="0.5",m.style.background="rgba(244, 67, 54, 0.1)",P.K(`Color disabled: ${n.name}`)}setTimeout(()=>{const e=R.Be(0,!0),o=e[t]?.ye||0,a=e[t]?.Ae||0,r=o+a,i=r>0?Math.round(o/r*100):0;b.innerHTML=`\n            <div style="font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.name}</div>\n            <div style="font-size: 8px; color: var(--bmcf-text-muted); opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n              ${o.toLocaleString()}/${r.toLocaleString()} (${i}%) | ${a.toLocaleString()} left\n            </div>\n          `},100)},m.appendChild(u),m.appendChild(b),m.appendChild(g),w.appendChild(m),N.push(m)}),T(z);const O=n=>{const e=Array.from(w.children),t=n.toLowerCase().trim();let o=0;e.forEach(n=>{if(n.classList.contains("no-results-msg"))return;const e=n.querySelector(".bmcf-compact-name"),a=e?.textContent.toLowerCase()||"",r=""===t||a.includes(t);n.style.display=r?"flex":"none",r&&o++});let a=w.querySelector(".no-results-msg");0===o&&""!==t?(a||(a=document.createElement("div"),a.className="no-results-msg",a.style.cssText="\n            padding: 20px;\n            text-align: center;\n            color: var(--bmcf-text-muted);\n            font-size: 12px;\n            font-style: italic;\n          ",a.textContent="No colors found",w.appendChild(a)),a.style.display="block"):a&&(a.style.display="none")};m.addEventListener("input",n=>{O(n.target.value)}),m.addEventListener("keydown",n=>{n.stopPropagation()}),m.addEventListener("keyup",n=>{n.stopPropagation()}),m.addEventListener("keypress",n=>{n.stopPropagation()}),Cn.addEventListener("keydown",n=>{n.ctrlKey&&"f"===n.key&&(n.preventDefault(),m.focus(),m.select()),"Escape"===n.key&&document.activeElement===m&&(m.value="",O(""),m.blur())}),document.body.appendChild(Cn)}window.updateCompactListData=function(e){const t=e.querySelector('div[style*="overflow-y: auto"]');if(!t)return;const o=R.Be(0,!0),a=R.Nn?.[0];n.l.forEach((n,e)=>{if(0===e)return;const r=`${n.rgb[0]},${n.rgb[1]},${n.rgb[2]}`,i=t.querySelector(`[data-color-rgb="${r}"]`);if(i){const e=o[r]||{},t=e.ye||0,s=e.Ae||0,l=t+s,c=l>0?Math.round(t/l*100):0;i.setAttribute("data-remaining",s.toString()),i.setAttribute("data-painted",t.toString()),i.setAttribute("data-total",l.toString()),i.setAttribute("data-progress",c.toString());const d=i.querySelector('div[style*="flex: 1"]');d&&(d.innerHTML=`\n              <div style="font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${n.name}</div>\n              <div style="font-size: 8px; color: var(--bmcf-text-muted); opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n                ${t.toLocaleString()}/${l.toLocaleString()} (${c}%) | ${s.toLocaleString()} left\n              </div>\n            `),a&&a.dn(n.rgb)?(i.style.opacity="0.5",i.style.background="rgba(244, 67, 54, 0.1)"):(i.style.opacity="1",i.style.background="");const p=i.querySelector('input[type="checkbox"]');if(p&&a&&a.enhancedColors){const e=n.rgb.join(",");p.checked=a.enhancedColors.has(e)}}})},C.onclick=()=>{const n=document.getElementById("bmcf-compact-list");n?"none"!==n.style.display?(n.style.display="none",C.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))"):(n.style.display="flex",n.style.flexDirection="column",C.style.background="linear-gradient(135deg, var(--blue-600), var(--blue-700))",updateCompactListData(n)):"none"!==Cn.style.display?(Cn.style.display="none",C.style.background="linear-gradient(135deg, var(--slate-600), var(--slate-700))"):(Cn.style.display="flex",Cn.style.flexDirection="column",C.style.background="linear-gradient(135deg, var(--blue-600), var(--blue-700))")};const Tn=window.refreshTemplateDisplay;Tn&&"function"==typeof Tn&&(window.refreshTemplateDisplay=async function(...n){const e=await Tn.apply(this,n),t=document.getElementById("bmcf-compact-list");return t&&"none"!==t.style.display&&setTimeout(()=>{window.updateCompactListData&&window.updateCompactListData(t)},200),e}),b.appendChild(Sn),b.appendChild(kn),document.body.appendChild(b),S?(vn.classList.add("list-mode"),M.innerHTML="⊞",M.title="Switch to Grid view"):(vn.classList.remove("list-mode"),M.innerHTML="📋",M.title="Switch to List view"),vn.offsetHeight,mn(!!e);let zn=!1,Nn=0,On=0,In=0,_n=0;g.addEventListener("mousedown",n=>{zn=!0,Nn=n.clientX,On=n.clientY;const e=b.getBoundingClientRect();In=e.left,_n=e.top,b.style.position="fixed",b.style.transform="none",b.style.left=In+"px",b.style.top=_n+"px",g.style.cursor="grabbing",f.style.cursor="grabbing",f.style.opacity="1",b.style.userSelect="none",n.preventDefault()}),g.addEventListener("touchstart",n=>{const e=n.touches&&n.touches[0];if(!e)return;const t=n.target;if("BUTTON"===t.tagName||t.closest("button"))return;zn=!0,Nn=e.clientX,On=e.clientY;const o=b.getBoundingClientRect();In=o.left,_n=o.top,b.style.position="fixed",b.style.transform="none",b.style.left=In+"px",b.style.top=_n+"px",b.style.userSelect="none",n.preventDefault()},{passive:!1}),document.addEventListener("mousemove",n=>{if(!zn)return;const e=n.clientX-Nn,t=n.clientY-On,o=In+e,a=_n+t,r=window.innerWidth-b.offsetWidth,i=window.innerHeight-b.offsetHeight,s=Math.max(0,Math.min(o,r)),l=Math.max(0,Math.min(a,i));b.style.left=s+"px",b.style.top=l+"px"}),document.addEventListener("touchmove",n=>{if(!zn)return;const e=n.touches&&n.touches[0];if(!e)return;const t=e.clientX-Nn,o=e.clientY-On,a=In+t,r=_n+o,i=window.innerWidth-b.offsetWidth,s=window.innerHeight-b.offsetHeight,l=Math.max(0,Math.min(a,i)),c=Math.max(0,Math.min(r,s));b.style.left=l+"px",b.style.top=c+"px",n.preventDefault()},{passive:!1}),document.addEventListener("mouseup",()=>{zn&&(zn=!1,g.style.cursor="move",f.style.cursor="grab",f.style.opacity="0.8",b.style.userSelect="")}),document.addEventListener("touchend",()=>{zn&&(zn=!1,b.style.userSelect="")})}).catch(n=>{p("Failed to load color palette:",n),P.X("Failed to load color palette!")})}var K={"color-0":[255,255,255,0],"color-1":[0,0,0],"color-2":[60,60,60],"color-3":[120,120,120],"color-4":[210,210,210],"color-5":[255,255,255],"color-6":[96,0,24],"color-7":[237,28,36],"color-8":[255,127,39],"color-9":[246,170,9],"color-10":[249,221,59],"color-11":[255,250,188],"color-12":[14,185,104],"color-13":[19,230,123],"color-14":[135,255,94],"color-15":[12,129,110],"color-16":[16,174,166],"color-17":[19,225,190],"color-18":[40,80,158],"color-19":[64,147,228],"color-20":[96,247,242],"color-21":[107,80,246],"color-22":[153,177,251],"color-23":[120,12,153],"color-24":[170,56,185],"color-25":[224,159,249],"color-26":[203,0,122],"color-27":[236,31,128],"color-28":[243,141,169],"color-29":[104,70,52],"color-30":[149,104,42],"color-31":[248,178,119],"color-32":[170,170,170],"color-33":[165,14,30],"color-34":[250,128,114],"color-35":[228,92,26],"color-36":[214,181,148],"color-37":[156,132,49],"color-38":[197,173,49],"color-39":[232,212,95],"color-40":[74,107,58],"color-41":[90,148,74],"color-42":[132,197,115],"color-43":[15,121,159],"color-44":[187,250,242],"color-45":[125,199,255],"color-46":[77,49,184],"color-47":[74,66,132],"color-48":[122,113,196],"color-49":[181,174,241],"color-50":[219,164,99],"color-51":[209,128,81],"color-52":[255,197,165],"color-53":[155,82,73],"color-54":[209,128,120],"color-55":[250,182,164],"color-56":[123,99,82],"color-57":[156,132,107],"color-58":[51,57,65],"color-59":[109,117,141],"color-60":[179,185,209],"color-61":[109,100,63],"color-62":[148,140,107],"color-63":[205,197,158]},Q=!1;function Z(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmErrorMap",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmErrorMap");null!==e&&(n=JSON.parse(e))}return null!==n&&n}catch(n){m("Failed to load error map setting:",n)}return!1}function nn(n){if(!pn())return;if(!n||"object"!=typeof n)return;const e=K||{};Object.entries(e).forEach(([e,t])=>{const o=document.querySelector(`button#${CSS.escape(e)}`);if(!o)return;if("color-0"===e)return;const a=`${t[0]},${t[1]},${t[2]}`,r=n[a],i=r&&"number"==typeof r.Ae?r.Ae:0;let s=o.querySelector(".bm-1w");s||(s=document.createElement("div"),s.className="bm-1w",s.style.cssText="\n        position: absolute;\n        bottom: 2px;\n        right: 2px;\n        background: rgba(0,0,0,0.65);\n        color: #fff;\n        font-weight: 800;\n        font-size: 10px;\n        line-height: 1;\n        padding: 2px 4px;\n        border-radius: 6px;\n        pointer-events: none;\n        user-select: none;\n        z-index: 2;\n      ",o.style.position||(o.style.position="relative"),o.appendChild(s)),s.textContent=i.toLocaleString(),s.style.display=i>0?"block":"none"})}async function en(){if(R.Nn&&R.Nn.length>0)try{R.Nn[0].xn(),R.ze(!1),await new Promise(n=>setTimeout(n,50)),await R.De(0),R.ze(!0)}catch(n){throw p("Error refreshing template display:",n),P.X("Failed to apply color filter"),n}else m("No templates available to refresh");un()}function tn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairColor",null);e&&(n=JSON.parse(e))}if(!n){const e=localStorage.getItem("bmCrosshairColor");e&&(n=JSON.parse(e))}if(n&&180===n.alpha&&(n.alpha=255,on(n)),n)return n}catch(n){m("Failed to load crosshair color:",n)}return{name:"Red",rgb:[255,0,0],alpha:255}}function on(n){try{const e=JSON.stringify(n);"undefined"!=typeof GM_setValue&&GM_setValue("bmCrosshairColor",e),localStorage.setItem("bmCrosshairColor",e)}catch(n){p("Failed to save crosshair color:",n)}}function an(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairBorder",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairBorder");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load border setting:",n)}return!1}function rn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairEnhancedSize",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairEnhancedSize");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){p("Failed to load enhanced size setting:",n)}return!1}function sn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCrosshairRadius",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCrosshairRadius");null!==e&&(n=JSON.parse(e))}if(null!==n)return Math.max(12,Math.min(32,n))}catch(n){p("Failed to load crosshair radius setting:",n)}return 16}function ln(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmMiniTracker",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmMiniTracker");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load mini tracker setting:",n)}return!1}function cn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmCollapseMin",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmCollapseMin");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load collapse mini template setting:",n)}return!0}function dn(){try{const n=localStorage.getItem("bmMobileMode")||"false";return JSON.parse(n)}catch(n){return p("❌ Failed to load mobile mode setting:",n),!1}}function pn(){try{let n=null;if("undefined"!=typeof GM_getValue){const e=GM_getValue("bmShowLeftOnColor",null);null!==e&&(n=JSON.parse(e))}if(null===n){const e=localStorage.getItem("bmShowLeftOnColor");null!==e&&(n=JSON.parse(e))}if(null!==n)return n}catch(n){m("Failed to load Show Left-on-Color setting:",n)}return!1}function mn(n){if(!document.getElementById("bm-c"))return;let e=document.getElementById("bmcf-mobile-styles");e&&e.remove(),n&&(e=document.createElement("style"),e.id="bmcf-mobile-styles",document.head.appendChild(e),e.textContent="\n      /* Dynamic Mobile Mode Styles - Applied Fresh */\n      .bmcf-overlay { \n        width: min(96vw, 420px) !important; \n        max-height: 75vh !important; \n        border-radius: 12px !important; \n        padding: 6px !important;\n      }\n      .bmcf-header { \n        padding: 8px 10px 6px 10px !important; \n      }\n      .bmcf-drag-bar { \n        height: 4px !important; \n        margin-bottom: 6px !important; \n      }\n      .bmcf-title { \n        font-size: 1.12em !important; \n      }\n      .bmcf-close { \n        width: 22px !important; \n        height: 22px !important; \n      }\n      .bmcf-search { \n        height: 28px !important; \n        padding: 6px 10px !important; \n        font-size: 0.75em !important; \n      }\n      .bmcf-select { \n        height: 28px !important; \n        padding: 4px 8px !important; \n        font-size: 0.85em !important; \n      }\n      .bmcf-grid { \n        grid-template-columns: repeat(3, minmax(0, 1fr)) !important; \n        gap: 4px !important; \n        justify-content: stretch !important;\n      }\n      .bmcf-card { \n        padding: 6px 8px 10px 8px !important; \n        border-radius: 6px !important; \n        width: auto !important;\n        height: 108px !important;\n        box-sizing: border-box !important;\n      }\n      /* Enhanced row and label compact spacing */\n      .bmcf-card .bmcf-enhanced { \n        padding: 0 2px !important; \n        margin-top: 2px !important; \n        margin-bottom: 2px !important; \n        gap: 2px !important; \n      }\n      .bmcf-card .bmcf-enhanced input { \n        width: 12px !important; \n        height: 12px !important; \n      }\n      .bmcf-card .bmcf-color-name { \n        margin-bottom: 1px !important; \n        font-size: 0.9em !important; \n        line-height: 1.05 !important;\n      }\n      .bmcf-card .bmcf-stats { \n        padding: 0 2px !important; \n        font-size: 0.8em !important; \n        line-height: 1.05 !important;\n      }\n      .bmcf-color-box { \n        width: 18px !important; \n        height: 18px !important; \n        border-radius: 3px !important; \n      }\n      .bmcf-color-name { \n        font-size: 0.75em !important; \n      }\n      .bmcf-stats { \n        font-size: 0.65em !important; \n        gap: 2px !important; \n      }\n      .bmcf-btn { \n        height: 28px !important; \n        padding: 0 10px !important; \n        min-width: 70px !important; \n        font-size: 0.75em !important; \n      }\n      .bmcf-footer { \n        padding: 6px 8px !important; \n        gap: 6px !important; \n      }\n      .bmcf-progress-container { \n        padding: 6px 10px !important; \n      }\n      .bmcf-instructions { \n        font-size: 0.7em !important; \n        padding: 6px 10px !important; \n      }\n      /* List view styles for mobile */\n      .bmcf-list { \n        gap: 4px !important; \n      }\n      .bmcf-list-item { \n        padding: 6px 8px !important; \n        min-height: 40px !important;\n        gap: 8px !important;\n      }\n      .bmcf-list-item .info-container { \n        font-size: 0.8em !important; \n      }\n      .bmcf-list-item .color-swatch { \n        width: 24px !important; \n        height: 24px !important; \n      }\n    ")}function un(){try{const n=ln(),e=cn(),t=document.getElementById("bm-C"),o=document.getElementById("bm-M");if(!o)return void m("Main overlay not found, skipping mini tracker update");const a=o&&("60px"===o.style.width||"76px"===o.style.height||"72px"===o.style.width);if(!n||e&&a)return void(t&&t.remove());let r=0,i=0,s=0;if(R.Nn&&R.Nn.length>0){const n=R.Be(0,!0),e=JSON.parse(localStorage.getItem("bmcf-excluded-colors")||"[]");for(const[t,o]of Object.entries(n))e.includes(t)||(r+=o.Je||0,i+=o.ye||0,s+=o.Ae||0)}const l=r>0?Math.round(i/r*100):0;let c=t;if(!c){c=document.createElement("div"),c.id="bm-C";const n=document.getElementById("bm-1"),e=document.getElementById("bm-M");if(n&&e)try{const t=document.getElementById(P.C);t&&t.parentNode===e?e.insertBefore(c,t):n.parentNode&&n.nextSibling?n.parentNode.insertBefore(c,n.nextSibling):e.appendChild(c)}catch(n){p("Error inserting mini tracker:",n);try{e.appendChild(c)}catch(n){p("Failed to append mini tracker:",n)}}}const d=o&&("60px"===o.style.width||"76px"===o.style.height||"72px"===o.style.width);c.style.cssText=`\n    background: linear-gradient(135deg, #1e293b, #334155);\n    border: 1px solid #475569;\n    border-radius: 12px;\n    padding: 12px 16px;\n    margin-top: 8px;\n    color: #f1f5f9;\n    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    width: ${d?"230px":"100%"};\n    font-size: 0.85rem;\n    display: grid;\n    grid-template-columns: 1fr;\n    grid-template-rows: auto auto auto auto;\n    grid-gap: 6px;\n    letter-spacing: -0.01em;\n    box-sizing: border-box;\n  `,c.innerHTML=0===r?'\n      <div class="tracker-title">📊 Template Progress: 0%</div>\n      <div class="tracker-pixels">0 / 0 pixels painted</div>\n      <div class="tracker-progress">\n        <div class="tracker-bar" style="width: 0%;"></div>\n      </div>\n      <div class="tracker-left">0 Pixels Left</div>\n    ':`\n      <div class="tracker-title">📊 Template Progress: ${l}%</div>\n      <div class="tracker-pixels">${i.toLocaleString()} / ${r.toLocaleString()} pixels painted</div>\n      <div class="tracker-progress">\n        <div class="tracker-bar" style="width: ${l}%;"></div>\n      </div>\n      <div class="tracker-left">${s.toLocaleString()} Pixels Left</div>\n    `;const u=document.createElement("style");u.textContent="\n    .tracker-title {\n      font-size: 1rem;\n      font-weight: 700;\n      grid-row: 1;\n      width: 100%;\n      text-align: left;\n      color: #f1f5f9;\n      letter-spacing: -0.02em;\n      line-height: 1.2;\n    }\n    .tracker-pixels {\n      font-size: 0.8rem;\n      color: #cbd5e1;\n      grid-row: 2;\n      width: 100%;\n      text-align: left;\n      font-weight: 500;\n      line-height: 1.2;\n    }\n    .tracker-progress {\n      height: 8px;\n      background: #475569;\n      border-radius: 6px;\n      overflow: hidden;\n      grid-row: 3;\n      width: 100%;\n      border: 1px solid #64748b;\n      min-width: 0;\n    }\n    .tracker-bar {\n      height: 100%;\n      background: linear-gradient(90deg, #3b82f6, #10b981);\n      border-radius: 4px;\n      transition: width 0.3s ease;\n      min-width: 0;\n    }\n    .tracker-left {\n      font-size: 0.8rem;\n      color: #fbbf24;\n      grid-row: 4;\n      width: 100%;\n      text-align: left;\n      font-weight: 600;\n      line-height: 1.2;\n    }\n  ";const b=document.getElementById("tracker-styles");b&&b.remove(),u.id="tracker-styles",document.head.appendChild(u)}catch(n){p("❌ Error updating mini tracker:",n);const e=document.getElementById("bm-C");if(e)try{e.remove()}catch(n){p("Failed to remove problematic tracker:",n)}}}window.refreshColorFilterOverlay=function(){const n=document.getElementById("bm-c");n&&(n.remove(),setTimeout(()=>{X()},100))},window.forceTemplateRedraw=function(){R.Nn&&R.Nn.length>0&&(R.ze(!1),setTimeout(()=>{R.ze(!0),un()},100))};var bn=null;function gn(){bn&&clearInterval(bn),ln()&&(bn=setInterval(()=>{ln()?un():(clearInterval(bn),bn=null)},15e3))}var fn=null;function hn(){fn&&clearInterval(fn),pn()&&(fn=setInterval(()=>{pn()?function(){if(pn()&&R.Nn&&0!==R.Nn.length)try{nn(R.Be(0,!0))}catch(n){m("Failed to auto-update left badges:",n)}}():(clearInterval(fn),fn=null)},5e3))}var xn=null;function vn(){if(document.getElementById("skirk-search-draggable"))return void console.warn("Search window already exists, skipping creation");const n=document.createElement("div");n.id="skirk-search-draggable",n.innerHTML='\n<div class="drag-handle"></div>\n<div class="hdr">\n  <h3>\n    <img class="skirk-icon" src="https://raw.githubusercontent.com/Seris0/Wplace-BlueMarble/main/dist/assets/Favicon.png" alt="Blue Marble" style="width:42px;height:42px;">\n    Location Search\n  </h3>\n  <div class="actions">\n    <button id="skirk-location-btn">Location</button>\n    <button id="skirk-search-close">Close</button>\n  </div>\n</div>\n<div class="body">\n  <input type="text" id="skirk-search-input" placeholder="Search for a place...">\n  <div id="skirk-search-results"></div>\n  <div id="skirk-favorites-menu" style="display: none;">\n    <div id="skirk-favorites-header">\n      <div id="skirk-favorites-title" style="cursor: pointer;">\n        <span id="skirk-favorites-toggle">▼</span> ⭐ Favorites\n        <span id="skirk-favorites-count">0</span>\n      </div>\n\n      <button id="skirk-clear-favorites">Clear All</button>\n    </div>\n    <input type="text" id="skirk-favorites-filter" class="skirk-favorites-filter" placeholder="Filter favorites...">\n    <div id="skirk-favorites-list"></div>\n  </div>\n</div>',document.body.appendChild(n),n.querySelector("#skirk-search-close").addEventListener("click",()=>n.style.display="none");const e="bm-1m";function t(){try{const n=localStorage.getItem(e);if(null==n)return[];const t=JSON.parse(n);return Array.isArray(t)?t:[]}catch(n){return console.error("Error getting favorites:",n),[]}}function o(n){try{localStorage.setItem(e,JSON.stringify(n)),i()}catch(n){console.error("Error saving favorites:",n)}}function a(n){const e=t();e.find(e=>e.lat===n.lat&&e.lon===n.lon)||(e.push(n),o(e))}function r(n,e){o(t().filter(t=>!(t.lat===n&&t.lon===e)))}function i(){const e=n.querySelector("#skirk-favorites-filter"),o=e?e.value:"",a=t(),i=function(n){const e=t(),o=(n||"").toLowerCase();return o?e.filter(n=>`${n.jt||""} ${n.Ft||""} ${n.Bt||""}`.toLowerCase().includes(o)):e}(o),s=n.querySelector("#skirk-favorites-menu"),l=n.querySelector("#skirk-favorites-count"),c=n.querySelector("#skirk-favorites-list");if(l.textContent=a.length,a.length>0){if(s.style.display="block",c.innerHTML="",0===i.length)return void(c.innerHTML='<div class="skirk-no-results">No favorites match your filter</div>');i.forEach(e=>{const t=document.createElement("div");t.className="skirk-favorite-item",t.innerHTML=`\n          <div class="skirk-result-content">\n            <div class="skirk-result-name">${e.jt}</div>\n            <div class="skirk-result-address">${e.Ft}</div>\n          </div>\n          <span class="skirk-favorite-remove" title="Remove from favorites">×</span>\n        `,t.querySelector(".skirk-result-content").addEventListener("click",()=>{T(e.lat,e.lon),n.style.display="none"}),t.querySelector(".skirk-favorite-remove").addEventListener("click",n=>{n.stopPropagation(),r(e.lat,e.lon)}),c.appendChild(t)})}else s.style.display="none"}n.querySelector("#skirk-clear-favorites").addEventListener("click",()=>{confirm("Are you sure you want to clear all favorites?")&&o([])});const s=n.querySelector("#skirk-favorites-filter");if(s){let n;const e=()=>{clearTimeout(n),n=setTimeout(()=>i(),120)};s.addEventListener("input",e)}i();const l=document.createElement("div");l.id="skirk-location-modal",l.innerHTML='\n    <div id="skirk-location-dialog">\n      <h3>Add Custom Location</h3>\n      <div class="form-group">\n        <label for="location-name">Name:</label>\n        <input type="text" id="location-name" placeholder="e.g., My House, My Art, Work">\n      </div>\n      \n      <div class="form-group">\n        <label for="location-link">Paste wplace.live link:</label>\n        <input type="text" id="location-link" placeholder="https://wplace.live/?lat=-19.037942104984218&lng=-42.420498378222675&zoom=16.078281108991245">\n      </div>\n      \n      <div class="form-group" style="display: flex; gap: 8px;">\n        <div style="flex: 1;">\n          <label for="location-lat">Latitude:</label>\n          <input type="text" id="location-lat" placeholder="e.g., -23.5506507" readonly>\n        </div>\n        <div style="flex: 1;">\n          <label for="location-lon">Longitude:</label>\n          <input type="text" id="location-lon" placeholder="e.g., -46.6333824" readonly>\n        </div>\n      </div>\n      \n      <div class="button-group">\n        <button class="btn-secondary" id="location-cancel">Cancel</button>\n        <button class="btn-primary" id="location-save">Save to Favorites</button>\n      </div>\n    </div>\n  ',document.body.appendChild(l),n.querySelector("#skirk-location-btn").addEventListener("click",()=>{l.style.display="flex",l.querySelector("#location-name").focus()});const c=l.querySelector("#location-link"),d=l.querySelector("#location-lat"),m=l.querySelector("#location-lon");c.addEventListener("input",()=>{const n=c.value.trim();if(!n)return d.value="",void(m.value="");const e=n.match(/lat=([^&]+)/),t=n.match(/lng=([^&]+)/);if(e&&t){const n=parseFloat(e[1]),o=parseFloat(t[1]);isNaN(n)||isNaN(o)?(d.value="",m.value="",d.style.color="#f87171",m.style.color="#f87171"):(d.value=n.toString(),m.value=o.toString(),d.style.color="#4ade80",m.style.color="#4ade80")}else d.value="",m.value="",d.style.color="#f87171",m.style.color="#f87171"}),l.querySelector("#location-cancel").addEventListener("click",()=>{l.style.display="none",l.querySelector("#location-name").value="",l.querySelector("#location-link").value="",l.querySelector("#location-lat").value="",l.querySelector("#location-lon").value="",d.style.color="#f1f5f9",m.style.color="#f1f5f9"}),l.querySelector("#location-save").addEventListener("click",()=>{const n=l.querySelector("#location-name").value.trim(),e=l.querySelector("#location-lat").value.trim(),t=l.querySelector("#location-lon").value.trim();n&&e&&t?isNaN(parseFloat(e))||isNaN(parseFloat(t))?alert("Please enter valid coordinates"):(a({lat:e,lon:t,jt:n,Ft:`Custom Location (${e}, ${t})`,Bt:""}),l.style.display="none",l.querySelector("#location-name").value="",l.querySelector("#location-link").value="",l.querySelector("#location-lat").value="",l.querySelector("#location-lon").value="",d.style.color="#f1f5f9",m.style.color="#f1f5f9"):alert("Please fill all fields")}),l.addEventListener("click",n=>{n.target===l&&l.querySelector("#location-cancel").click()});let u=!1;n.querySelector("#skirk-favorites-title").addEventListener("click",()=>{u=!u;const e=n.querySelector("#skirk-favorites-toggle"),t=n.querySelector("#skirk-favorites-list");u?(e.classList.add("collapsed"),t.style.display="none"):(e.classList.remove("collapsed"),t.style.display="block")});const b=n.querySelector(".drag-handle");let g=!1,f=0,h=0,x=0,v=0,w=0;function y(){g&&(n.style.transform=`translate(${x}px, ${v}px)`,w=requestAnimationFrame(y))}function k(e,t){g=!0,n.classList.add("dragging");const o=n.getBoundingClientRect();let[a,r]=function(n){const e=window.getComputedStyle(n).transform;if(e&&"none"!==e){const n=new DOMMatrix(e);return[n.m41,n.m42]}return[0,0]}(n);f=e-o.left,h=t-o.top,n.style.left="0px",n.style.top="0px",n.style.right="auto",n.style.bottom="auto",n.style.position="fixed",0===a&&0===r?(x=o.left,v=o.top,n.style.transform=`translate(${x}px, ${v}px)`):(x=a,v=r),document.body.style.userSelect="none",w&&cancelAnimationFrame(w),y()}function $(){g=!1,w&&cancelAnimationFrame(w),document.body.style.userSelect="",n.classList.remove("dragging")}function M(n,e){g&&(x=n-f,v=e-h)}b.addEventListener("mousedown",function(n){n.preventDefault(),k(n.clientX,n.clientY)}),document.addEventListener("mousemove",function(n){g&&M(n.clientX,n.clientY)},{passive:!0}),document.addEventListener("mouseup",$),b.addEventListener("touchstart",function(n){const e=n?.touches?.[0];e&&(k(e.clientX,e.clientY),n.preventDefault())},{passive:!1}),document.addEventListener("touchmove",function(n){if(g){const e=n?.touches?.[0];if(!e)return;M(e.clientX,e.clientY),n.preventDefault()}},{passive:!1}),document.addEventListener("touchend",$),document.addEventListener("touchcancel",$);const S=n.querySelector("#skirk-search-input"),C=n.querySelector("#skirk-search-results");function T(n,e){if("openurl"===z()){const t=`https://wplace.live/?lat=${n}&lng=${e}&zoom=13.62`;window.location.href=t}else L(n,e)}async function N(){const e=S.value.trim();if(e){C.innerHTML='<div class="skirk-loading">Searching...</div>';try{const o=await function(n){return new Promise((e,t)=>{GM_xmlhttpRequest({method:"GET",url:`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=5&addressdetails=1`,headers:{"User-Agent":"BlueMarble-Search-UserScript/1.0"},onload:function(n){try{const t=JSON.parse(n.responseText);e(t)}catch(n){console.error("JSON Parse error:",n),t(n)}},onerror:function(n){console.error("Search API error:",n),t(n)}})})}(e);!function(e){0!==e.length?(C.innerHTML="",e.forEach(e=>{const o=e.display_name||e.name||"Unknown location",i=e.lat,s=e.lon,l=document.createElement("div");l.className="skirk-search-result",l.dataset.lat=String(i||""),l.dataset.lon=String(s||"");const c=o.split(","),d=c[0]?.trim()||"Unknown",p=c.slice(1,3).join(",").trim(),m=c.slice(3).join(",").trim();l.innerHTML=`\n        <div class="skirk-result-content">\n          <div class="skirk-result-name">${d}</div>\n          ${p?`<div class="skirk-result-address secondary">${p}</div>`:""}\n          ${m?`<div class="skirk-result-address">${m}</div>`:""}\n        </div>\n        <span class="skirk-favorite-star ${function(n,e){return t().some(t=>t.lat===n&&t.lon===e)}(i,s)?"favorited":""}" title="Add to favorites">★</span>\n      `,l.querySelector(".skirk-result-content").addEventListener("click",e=>{const t=e.currentTarget.parentElement.dataset.lat,o=e.currentTarget.parentElement.dataset.lon;t&&o&&"undefined"!==t&&"undefined"!==o?(T(t,o),n.style.display="none",S.value="",C.innerHTML=""):(console.error("Invalid coordinates, not navigating"),alert("Error: Invalid coordinates for this location"))}),l.querySelector(".skirk-favorite-star").addEventListener("click",n=>{n.stopPropagation();const e=n.target;e.classList.contains("favorited")?(r(i,s),e.classList.remove("favorited"),e.title="Add to favorites"):(a({lat:i,lon:s,jt:d,Ft:p||"",Bt:m||""}),e.classList.add("favorited"),e.title="Remove from favorites")}),C.appendChild(l)})):C.innerHTML='<div class="skirk-no-results">No results found</div>'}(o)}catch(n){p("Search error:",n),C.innerHTML='<div class="skirk-no-results">Error searching. Please try again.</div>'}}}let O;S.addEventListener("keypress",n=>{"Enter"===n.key&&N()}),S.addEventListener("input",()=>{clearTimeout(O),S.value.trim()?O=setTimeout(N,500):C.innerHTML=""})}setTimeout(()=>{gn(),hn(),xn&&clearInterval(xn),xn=setInterval(()=>{const n=document.getElementById("bmcf-compact-list");n&&"none"!==n.style.display&&window.updateCompactListData&&window.updateCompactListData(n)},5e3)},2e3),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",vn):vn()})();